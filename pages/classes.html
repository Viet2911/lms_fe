<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L·ªõp h·ªçc - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .class-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
    .class-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .class-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .class-card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .class-card-code { font-size: 12px; color: var(--text-muted); font-family: monospace; }
    .class-card-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px; color: var(--text-secondary); }
    .class-card-info i { width: 16px; color: var(--primary-color); }
    .class-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color); }
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 4px; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
    .tab-btn { padding: 12px 20px; background: none; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-secondary); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
    .tab-btn:hover { color: var(--primary-color); background: var(--bg-secondary); }
    .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .tab-btn .badge { background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Session card */
    .session-card { background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
    .session-number { background: var(--primary-color); color: white; width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; }
    .session-info { flex: 1; }
    .session-info h4 { margin: 0 0 4px; font-size: 15px; }
    .session-info p { margin: 0; font-size: 13px; color: var(--text-muted); }
    .session-actions { display: flex; gap: 8px; }
    
    /* Attendance grid */
    .attendance-grid { display: grid; gap: 8px; }
    .attendance-row { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; }
    .attendance-row .student-name { flex: 1; font-weight: 500; }
    .attendance-row select { width: 130px; }
    
    /* Assignment card */
    .assignment-card { background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .assignment-card h4 { margin: 0 0 8px; display: flex; align-items: center; gap: 8px; }
    .assignment-card p { margin: 0; font-size: 13px; color: var(--text-muted); }
    .assignment-meta { display: flex; gap: 16px; margin-top: 12px; font-size: 12px; color: var(--text-secondary); }
    
    /* Stats mini */
    .stats-mini { display: flex; gap: 16px; margin-bottom: 20px; }
    .stat-mini { background: var(--bg-secondary); padding: 12px 16px; border-radius: 8px; text-align: center; flex: 1; }
    .stat-mini .value { font-size: 24px; font-weight: 700; color: var(--primary-color); }
    .stat-mini .label { font-size: 12px; color: var(--text-muted); }
    
    /* Attendance Session Cards */
    .attendance-sessions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .attendance-session-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; padding: 14px; transition: all 0.2s; cursor: pointer; }
    .attendance-session-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .attendance-session-card.completed { border-left: 4px solid #22c55e; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
    .attendance-session-card.pending { border-left: 4px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }
    .attendance-session-card.future { border-left: 4px solid #9ca3af; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); }
    .attendance-session-card .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .attendance-session-card .session-num { font-size: 16px; font-weight: 700; color: var(--text-primary); }
    .attendance-session-card .session-status { font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 12px; }
    .attendance-session-card.completed .session-status { background: #22c55e; color: white; }
    .attendance-session-card.pending .session-status { background: #f59e0b; color: white; }
    .attendance-session-card.future .session-status { background: #9ca3af; color: white; }
    .attendance-session-card .session-details { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: var(--text-secondary); }
    .attendance-session-card .session-details i { width: 16px; color: var(--text-muted); }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i class="fas fa-bars"></i></button>
          <div><h1 class="page-title">L·ªõp h·ªçc</h1><p class="page-subtitle">Qu·∫£n l√Ω c√°c l·ªõp h·ªçc</p></div>
        </div>
        <div class="header-right">
          <button class="theme-toggle" onclick="theme.toggle()" title="ƒê·ªïi giao di·ªán"><i class="fas fa-moon"></i><i class="fas fa-sun"></i></button>
          <button class="btn btn-primary" onclick="openCreateModal()" id="btnCreate"><i class="fas fa-plus"></i> Th√™m l·ªõp</button>
          <div class="user-menu" onclick="auth.logout()">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info"><div class="user-name" id="userName">User</div><div class="user-role" id="userRole">Role</div></div>
          </div>
        </div>
      </header>

      <div class="page-content">
        <div class="filters-bar">
          <div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..." onkeyup="if(event.key==='Enter') loadData()"></div>
          <select id="statusFilter" class="filter-select" onchange="loadData()"><option value="">T·∫•t c·∫£</option><option value="active">ƒêang ho·∫°t ƒë·ªông</option><option value="inactive">Ng·ª´ng</option></select>
          <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-search"></i></button>
        </div>
        <div class="cards-grid" id="classesGrid"><div class="loading"><div class="spinner"></div></div></div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-overlay" id="formModal">
    <div class="modal-content modal-lg">
      <div class="modal-header"><h3 class="modal-title" id="modalTitle">Th√™m l·ªõp h·ªçc</h3><button class="modal-close" onclick="modal.hide('formModal')">&times;</button></div>
      <div class="modal-body">
        <form id="classForm">
          <input type="hidden" id="classId">
          <div class="form-group" id="branchFormGroup">
            <label class="form-label required"><i class="fas fa-building"></i> C∆° s·ªü</label>
            <select name="branchId" id="branchFormSelect" class="form-control" required><option value="">ƒêang t·∫£i...</option></select>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label required">T√™n l·ªõp</label><input type="text" name="className" class="form-control" required></div>
            <div class="form-group"><label class="form-label">M√¥n h·ªçc</label><select name="subjectId" class="form-control" id="subjectSelect"><option value="">Ch·ªçn</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">C·∫•p ƒë·ªô</label><select name="levelId" class="form-control" id="levelSelect"><option value="">Ch·ªçn</option></select></div>
            <div class="form-group"><label class="form-label">Gi√°o vi√™n</label><select name="teacherId" class="form-control" id="teacherSelect"><option value="">Ch·ªçn</option></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">CM</label><select name="cmId" class="form-control" id="cmSelect"><option value="">Ch·ªçn</option></select></div>
            <div class="form-group"><label class="form-label">Ph√≤ng</label><input type="text" name="room" class="form-control"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Ng√†y h·ªçc</label><input type="text" name="studyDays" class="form-control" placeholder="T2, T4, T6"></div>
            <div class="form-group"><label class="form-label">S·ªë bu·ªïi</label><input type="number" name="totalSessions" class="form-control" value="15"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Gi·ªù b·∫Øt ƒë·∫ßu</label><input type="time" name="startTime" class="form-control"></div>
            <div class="form-group"><label class="form-label">Gi·ªù k·∫øt th√∫c</label><input type="time" name="endTime" class="form-control"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Ng√†y khai gi·∫£ng</label><input type="date" name="startDate" class="form-control"></div>
            <div class="form-group"><label class="form-label">Sƒ© s·ªë t·ªëi ƒëa</label><input type="number" name="maxStudents" class="form-control" value="15"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="modal.hide('formModal')">H·ªßy</button><button class="btn btn-primary" onclick="saveClass()"><i class="fas fa-save"></i> L∆∞u</button></div>
    </div>
  </div>

  <!-- Detail Modal with Tabs -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal xl" style="max-width: 900px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border-radius: 12px 12px 0 0;">
        <div>
          <h3 class="modal-title" id="detailTitle">Chi ti·∫øt l·ªõp h·ªçc</h3>
          <p id="detailCode" style="opacity:0.8; font-size:13px; margin:0;"></p>
        </div>
        <button class="modal-close" onclick="modal.hide('detailModal')" style="color:white;">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0;">
        <!-- Tabs Navigation -->
        <div class="tabs" style="padding: 0 20px; background: var(--bg-secondary);">
          <button class="tab-btn active" onclick="switchTab('info')"><i class="fas fa-info-circle"></i> Th√¥ng tin</button>
          <button class="tab-btn" onclick="switchTab('sessions')"><i class="fas fa-calendar-alt"></i> Bu·ªïi h·ªçc <span class="badge" id="sessionCount">0</span></button>
          <button class="tab-btn" onclick="switchTab('attendance')"><i class="fas fa-clipboard-check"></i> ƒêi·ªÉm danh</button>
          <button class="tab-btn" onclick="switchTab('assignments')"><i class="fas fa-tasks"></i> B√†i t·∫≠p <span class="badge" id="assignmentCount">0</span></button>
        </div>
        
        <!-- Tab Contents -->
        <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
          <div id="tab-info" class="tab-content active"></div>
          <div id="tab-sessions" class="tab-content"></div>
          <div id="tab-attendance" class="tab-content"></div>
          <div id="tab-assignments" class="tab-content"></div>
        </div>
      </div>
      <div class="modal-footer" id="detailFooter"></div>
    </div>
  </div>

  <!-- Add Assignment Modal -->
  <div class="modal-overlay" id="assignmentModal">
    <div class="modal-content">
      <div class="modal-header"><h3 class="modal-title">Giao b√†i t·∫≠p</h3><button class="modal-close" onclick="modal.hide('assignmentModal')">&times;</button></div>
      <div class="modal-body">
        <form id="assignmentForm">
          <input type="hidden" id="assignmentClassId">
          <div class="form-group">
            <label class="form-label">Bu·ªïi h·ªçc</label>
            <select name="sessionId" id="assignmentSessionSelect" class="form-control"><option value="">-- Kh√¥ng g·∫Øn bu·ªïi c·ª• th·ªÉ --</option></select>
          </div>
          <div class="form-group"><label class="form-label required">Ti√™u ƒë·ªÅ</label><input type="text" name="title" class="form-control" required></div>
          <div class="form-group"><label class="form-label">M√¥ t·∫£</label><textarea name="description" class="form-control" rows="3"></textarea></div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">H·∫°n n·ªôp</label><input type="date" name="dueDate" class="form-control"></div>
            <div class="form-group"><label class="form-label">Gi·ªù</label><input type="time" name="dueTime" class="form-control"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="modal.hide('assignmentModal')">H·ªßy</button><button class="btn btn-primary" onclick="saveAssignment()"><i class="fas fa-save"></i> L∆∞u</button></div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/sidebar.js"></script>
  <script>
    let classes = [];
    let currentClass = null;
    let currentSessions = [];
    let currentStudents = [];
    let currentAssignments = [];

    async function init() {
      if (!auth.checkAuth()) return;
      buildSidebar('sidebar');
      if (!auth.hasRole('CM', 'ADMIN')) document.getElementById('btnCreate').style.display = 'none';
      setupBranchSelect();
      await loadOptions();
      await loadData();
    }

    function setupBranchSelect() { loadBranchOptions(); }

    async function loadBranchOptions() {
      const branchGroup = document.getElementById('branchFormGroup');
      const branchSelect = document.getElementById('branchFormSelect');
      try {
        const result = await api.get('/branches');
        const allBranches = result.data || [];
        if (allBranches.length === 0) { branchSelect.innerHTML = '<option value="">Ch∆∞a c√≥ c∆° s·ªü</option>'; return; }
        
        const userBranches = auth.user?.branches || [];
        const isAdmin = auth.user?.is_system_wide;
        
        if (userBranches.length > 0 && !isAdmin) {
          if (userBranches.length === 1) {
            // Ch·ªâ c√≥ 1 c∆° s·ªü - ·∫®N dropdown
            branchGroup.style.display = 'none';
            branchSelect.innerHTML = `<option value="${userBranches[0].id}">${userBranches[0].name}</option>`;
            branchSelect.value = userBranches[0].id;
            branchSelect.disabled = false;
          } else {
            branchGroup.style.display = 'block';
            branchSelect.disabled = false;
            const primaryId = auth.user?.primaryBranch?.id || userBranches[0]?.id;
            branchSelect.innerHTML = userBranches.map(b => 
              `<option value="${b.id}" ${b.id == primaryId ? 'selected' : ''}>${b.name}</option>`
            ).join('');
          }
        } else {
          branchGroup.style.display = 'block';
          branchSelect.disabled = false;
          const currentBranchId = branch.getId() || allBranches[0]?.id;
          branchSelect.innerHTML = allBranches.map(b => 
            `<option value="${b.id}" ${b.id == currentBranchId ? 'selected' : ''}>${b.name}</option>`
          ).join('');
        }
      } catch (e) { console.error(e); }
    }

    async function loadOptions() {
      try {
        const [subjects, levels, teachers, cms] = await Promise.all([
          api.get('/common/subjects'), api.get('/common/levels'),
          api.get('/users/by-role/TEACHER'), api.get('/users/by-role/CM')
        ]);
        document.getElementById('subjectSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (subjects.data || []).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('levelSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (levels.data || []).map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        document.getElementById('teacherSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (teachers.data || []).map(t => `<option value="${t.id}">${t.full_name}</option>`).join('');
        document.getElementById('cmSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (cms.data || []).map(c => `<option value="${c.id}">${c.full_name}</option>`).join('');
      } catch (e) { console.error(e); }
    }

    async function loadData() {
      const search = document.getElementById('searchInput').value;
      const status = document.getElementById('statusFilter').value;
      const container = document.getElementById('classesGrid');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      try {
        const params = {};
        if (search) params.search = search;
        if (status) params.status = status;
        const query = branch.buildQuery(params);
        const result = await api.get('/classes' + query);
        classes = result.data || [];
        renderClasses();
      } catch (e) { container.innerHTML = '<p>L·ªói: ' + e.message + '</p>'; }
    }

    function renderClasses() {
      const container = document.getElementById('classesGrid');
      const showBranch = auth.user?.is_system_wide && !branch.getId();
      if (!classes.length) { container.innerHTML = '<div class="empty-state"><i class="fas fa-chalkboard"></i><p>Ch∆∞a c√≥ l·ªõp h·ªçc</p></div>'; return; }
      container.innerHTML = classes.map(c => `
        <div class="class-card" onclick="viewClass(${c.id})">
          <div class="class-card-header">
            <div>
              <div class="class-card-title">${c.class_name}</div>
              <div class="class-card-code">${c.class_code}</div>
            </div>
            <span class="badge badge-${c.status === 'active' ? 'success' : 'secondary'}">${c.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Ng·ª´ng'}</span>
          </div>
          ${showBranch && c.branch_name ? `<div class="branch-tag" style="margin-bottom:8px;"><i class="fas fa-building"></i> ${c.branch_name}</div>` : ''}
          <div class="class-card-info">
            <div><i class="fas fa-book"></i> ${c.subject_name || 'Ch∆∞a ch·ªçn m√¥n'}</div>
            <div><i class="fas fa-layer-group"></i> ${c.level_name || 'Ch∆∞a ch·ªçn c·∫•p ƒë·ªô'}</div>
            <div><i class="fas fa-chalkboard-teacher"></i> ${c.teacher_name || 'Ch∆∞a c√≥ GV'}</div>
            <div><i class="fas fa-door-open"></i> ${c.room || 'Ch∆∞a c√≥ ph√≤ng'}</div>
            <div><i class="fas fa-calendar-alt"></i> ${c.study_days || 'Ch∆∞a x·∫øp l·ªãch'}</div>
            <div><i class="fas fa-clock"></i> ${c.start_time ? c.start_time.substring(0,5) + ' - ' + (c.end_time?.substring(0,5) || '') : 'Ch∆∞a c√≥ gi·ªù'}</div>
          </div>
          <div class="class-card-footer">
            <div><i class="fas fa-users"></i> <strong>${c.student_count || 0}</strong> / ${c.max_students || 15} h·ªçc sinh</div>
            <div><i class="fas fa-calendar-check"></i> ${c.completed_sessions || 0} / ${c.total_sessions || 15} bu·ªïi</div>
          </div>
        </div>
      `).join('');
    }

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Th√™m l·ªõp h·ªçc';
      document.getElementById('classId').value = '';
      form.reset(document.getElementById('classForm'));
      const branchSelect = document.getElementById('branchFormSelect');
      if (branchSelect && branch.getId()) branchSelect.value = branch.getId();
      modal.show('formModal');
    }

    async function editClass(id) {
      try {
        const result = await api.get(`/classes/${id}`);
        const c = result.data;
        document.getElementById('modalTitle').textContent = 'S·ª≠a l·ªõp h·ªçc';
        document.getElementById('classId').value = id;
        form.setData(document.getElementById('classForm'), {
          branchId: c.branch_id, className: c.class_name, subjectId: c.subject_id, levelId: c.level_id,
          teacherId: c.teacher_id, cmId: c.cm_id, room: c.room, studyDays: c.study_days,
          startTime: c.start_time?.substring(0,5), endTime: c.end_time?.substring(0,5),
          startDate: c.start_date?.substring(0,10), totalSessions: c.total_sessions, maxStudents: c.max_students
        });
        modal.hide('detailModal');
        modal.show('formModal');
      } catch (e) { ui.error(e.message); }
    }

    async function saveClass() {
      const formEl = document.getElementById('classForm');
      if (!form.validate(formEl)) { ui.error('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß'); return; }
      const data = form.getData(formEl);
      const id = document.getElementById('classId').value;
      
      // L·∫•y branchId t·ª´ select (disabled select kh√¥ng g·ª≠i qua FormData)
      const branchSelect = document.getElementById('branchFormSelect');
      data.branchId = branchSelect?.value || data.branchId || branch.getId() || auth.user?.branches?.[0]?.id;
      
      if (!data.branchId) {
        ui.error('C·∫ßn ch·ªçn c∆° s·ªü');
        return;
      }
      
      try {
        if (id) await api.put(`/classes/${id}`, data);
        else await api.post('/classes', data);
        ui.success('L∆∞u th√†nh c√¥ng');
        modal.hide('formModal');
        loadData();
      } catch (e) { ui.error(e.message); }
    }

    // ============================================
    // VIEW CLASS WITH TABS
    // ============================================
    async function viewClass(id) {
      try {
        const [classResult, studentsResult, sessionsResult, assignmentsResult] = await Promise.all([
          api.get(`/classes/${id}`),
          api.get(`/classes/${id}/students`),
          api.get(`/sessions?classId=${id}&limit=100`),
          api.get(`/assignments?classId=${id}`)
        ]);
        
        currentClass = classResult.data;
        currentStudents = studentsResult.data || [];
        currentSessions = sessionsResult.data || [];
        currentAssignments = assignmentsResult.data || [];

        document.getElementById('detailTitle').textContent = currentClass.class_name;
        document.getElementById('detailCode').textContent = `${currentClass.class_code} | ${currentClass.branch_name || ''}`;
        document.getElementById('sessionCount').textContent = currentSessions.length;
        document.getElementById('assignmentCount').textContent = currentAssignments.length;

        renderInfoTab();
        renderSessionsTab();
        renderAttendanceTab();
        renderAssignmentsTab();

        document.getElementById('detailFooter').innerHTML = `
          <button class="btn btn-secondary" onclick="modal.hide('detailModal')">ƒê√≥ng</button>
          ${auth.hasRole('CM', 'ADMIN') ? `<button class="btn btn-secondary" onclick="editClass(${currentClass.id})"><i class="fas fa-edit"></i> S·ª≠a</button>` : ''}
        `;

        switchTab('info');
        modal.show('detailModal');
      } catch (e) { ui.error(e.message); }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // ============================================
    // TAB: TH√îNG TIN
    // ============================================
    function renderInfoTab() {
      const c = currentClass;
      document.getElementById('tab-info').innerHTML = `
        <div class="stats-mini">
          <div class="stat-mini"><div class="value">${currentStudents.length}</div><div class="label">H·ªçc sinh</div></div>
          <div class="stat-mini"><div class="value">${currentSessions.filter(s => s.attendance_submitted).length}/${currentSessions.length}</div><div class="label">ƒê√£ ƒëi·ªÉm danh</div></div>
          <div class="stat-mini"><div class="value">${currentAssignments.length}</div><div class="label">B√†i t·∫≠p</div></div>
        </div>
        
        <div class="detail-grid" style="margin-bottom:24px;">
          <div class="detail-item"><label>M√¥n h·ªçc</label><span>${c.subject_name || '-'}</span></div>
          <div class="detail-item"><label>C·∫•p ƒë·ªô</label><span>${c.level_name || '-'}</span></div>
          <div class="detail-item"><label>Gi√°o vi√™n</label><span>${c.teacher_name || '-'}</span></div>
          <div class="detail-item"><label>CM</label><span>${c.cm_name || '-'}</span></div>
          <div class="detail-item"><label>Ph√≤ng</label><span>${c.room || '-'}</span></div>
          <div class="detail-item"><label>L·ªãch h·ªçc</label><span>${c.study_days || '-'} (${c.start_time?.substring(0,5) || ''} - ${c.end_time?.substring(0,5) || ''})</span></div>
          <div class="detail-item"><label>Ng√†y khai gi·∫£ng</label><span>${ui.formatDate(c.start_date)}</span></div>
          <div class="detail-item"><label>Sƒ© s·ªë</label><span>${currentStudents.length} / ${c.max_students || 15}</span></div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h4><i class="fas fa-users"></i> Danh s√°ch h·ªçc sinh</h4>
          ${auth.hasRole('CM', 'ADMIN') ? `<button class="btn btn-sm btn-primary" onclick="openAddStudent()"><i class="fas fa-user-plus"></i> Th√™m HS</button>` : ''}
        </div>
        ${currentStudents.length ? `
          <table class="table">
            <thead><tr><th>M√£</th><th>H·ªç t√™n</th><th>SƒêT PH</th><th>ƒêi·ªÉm danh</th><th></th></tr></thead>
            <tbody>
              ${currentStudents.map(s => `
                <tr>
                  <td><code>${s.student_code || '-'}</code></td>
                  <td><strong>${s.full_name}</strong></td>
                  <td>${s.parent_phone || '-'}</td>
                  <td><span class="badge badge-success">${s.present_count || 0}</span> / <span class="badge badge-danger">${s.absent_count || 0}</span></td>
                  <td>${auth.hasRole('CM', 'ADMIN') ? `<button class="btn btn-sm btn-danger" onclick="removeStudent(${s.id})"><i class="fas fa-times"></i></button>` : ''}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        ` : '<p class="text-muted">Ch∆∞a c√≥ h·ªçc sinh</p>'}
      `;
    }

    // ============================================
    // TAB: BU·ªîI H·ªåC
    // ============================================
    function renderSessionsTab() {
      if (!currentSessions.length) {
        document.getElementById('tab-sessions').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-calendar-alt"></i>
            <p>Ch∆∞a c√≥ bu·ªïi h·ªçc</p>
            ${auth.hasRole('CM', 'ADMIN') ? `<button class="btn btn-primary" onclick="generateSessions()"><i class="fas fa-magic"></i> T·∫°o bu·ªïi h·ªçc t·ª± ƒë·ªông</button>` : ''}
          </div>
        `;
        return;
      }

      document.getElementById('tab-sessions').innerHTML = `
        ${auth.hasRole('CM', 'ADMIN') ? `<div style="margin-bottom:16px;"><button class="btn btn-primary" onclick="generateSessions()"><i class="fas fa-magic"></i> T·∫°o th√™m bu·ªïi h·ªçc</button></div>` : ''}
        <div class="sessions-list">
          ${currentSessions.map(s => `
            <div class="session-card">
              <div class="session-number">${s.session_number}</div>
              <div class="session-info">
                <h4>Bu·ªïi ${s.session_number} - ${ui.formatDate(s.session_date)}</h4>
                <p><i class="fas fa-clock"></i> ${s.start_time?.substring(0,5) || ''} - ${s.end_time?.substring(0,5) || ''} | <i class="fas fa-chalkboard-teacher"></i> ${s.teacher_name || 'Ch∆∞a c√≥ GV'}</p>
              </div>
              <div class="session-actions">
                ${s.attendance_submitted 
                  ? '<span class="badge badge-success"><i class="fas fa-check"></i> ƒê√£ ƒëi·ªÉm danh</span>' 
                  : `<button class="btn btn-sm btn-primary" onclick="markAttendance(${s.id})"><i class="fas fa-clipboard-check"></i> ƒêi·ªÉm danh</button>`
                }
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    async function generateSessions() {
      if (!confirm('T·∫°o bu·ªïi h·ªçc t·ª± ƒë·ªông d·ª±a tr√™n l·ªãch h·ªçc?')) return;
      try {
        await api.post('/sessions/generate', { classId: currentClass.id });
        ui.success('ƒê√£ t·∫°o bu·ªïi h·ªçc');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    // ============================================
    // TAB: ƒêI·ªÇM DANH
    // ============================================
    function renderAttendanceTab() {
      if (!currentSessions.length) {
        document.getElementById('tab-attendance').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-clipboard-check"></i>
            <p>Ch∆∞a c√≥ bu·ªïi h·ªçc ƒë·ªÉ ƒëi·ªÉm danh</p>
          </div>
        `;
        return;
      }

      const completedCount = currentSessions.filter(s => s.attendance_submitted).length;
      const pendingCount = currentSessions.length - completedCount;

      document.getElementById('tab-attendance').innerHTML = `
        <div class="attendance-stats" style="display:flex; gap:12px; margin-bottom:16px;">
          <div class="stat-mini" style="background: #dcfce7; flex:1;">
            <div class="value" style="color: #16a34a;">${completedCount}</div>
            <div class="label">ƒê√£ ƒëi·ªÉm danh</div>
          </div>
          <div class="stat-mini" style="background: #fef3c7; flex:1;">
            <div class="value" style="color: #d97706;">${pendingCount}</div>
            <div class="label">Ch∆∞a ƒëi·ªÉm danh</div>
          </div>
          <div class="stat-mini" style="background: #f3f4f6; flex:1;">
            <div class="value" style="color: #6b7280;">${currentSessions.length}</div>
            <div class="label">T·ªïng bu·ªïi</div>
          </div>
        </div>
        
        <div class="attendance-sessions-grid">
          ${currentSessions.map(s => {
            const today = new Date();
            today.setHours(0,0,0,0);
            const sessionDate = new Date(s.session_date);
            sessionDate.setHours(0,0,0,0);
            
            let statusClass, statusText;
            if (s.attendance_submitted) {
              statusClass = 'completed';
              statusText = '‚úì ƒê√£ ƒëi·ªÉm danh';
            } else if (sessionDate > today) {
              statusClass = 'future';
              statusText = 'Ch∆∞a ƒë·∫øn';
            } else {
              statusClass = 'pending';
              statusText = '‚ö† C·∫ßn ƒëi·ªÉm danh';
            }
            
            return `
              <div class="attendance-session-card ${statusClass}" onclick="openAttendanceModal(${s.id})">
                <div class="session-header">
                  <div class="session-num">Bu·ªïi ${s.session_number}</div>
                  <div class="session-status">${statusText}</div>
                </div>
                <div class="session-details">
                  <div><i class="fas fa-calendar"></i> ${ui.formatDate(s.session_date)}</div>
                  <div><i class="fas fa-clock"></i> ${s.start_time?.substring(0,5) || ''} - ${s.end_time?.substring(0,5) || ''}</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    async function openAttendanceModal(sessionId) {
      const session = currentSessions.find(s => s.id === sessionId);
      if (!session) return;

      try {
        const result = await api.get(`/attendance/session/${sessionId}/students`);
        const students = result.data || [];

        const modalHtml = `
          <div class="modal-overlay" id="attendanceFormModal" style="display:flex;">
            <div class="modal-content modal-lg">
              <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white;">
                <div>
                  <h3 class="modal-title">ƒêi·ªÉm danh Bu·ªïi ${session.session_number}</h3>
                  <p style="margin:0; opacity:0.8; font-size:13px;">
                    ${ui.formatDate(session.session_date)} | ${session.start_time?.substring(0,5) || ''} - ${session.end_time?.substring(0,5) || ''}
                  </p>
                </div>
                <button class="modal-close" onclick="closeAttendanceModal()" style="color:white;">&times;</button>
              </div>
              <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                ${students.length ? `
                  <div class="attendance-grid">
                    ${students.map(s => {
                      const id = s.student_id || s.trial_student_id;
                      const idType = s.student_id ? 'student' : 'trial';
                      return `
                        <div class="attendance-row">
                          <div class="student-info" style="flex:1;">
                            <strong>${s.full_name}</strong>
                            ${s.type === 'trial' ? '<span class="badge badge-warning" style="margin-left:8px;">H·ªçc th·ª≠</span>' : ''}
                            <div style="font-size:12px; color:var(--text-muted);">${s.student_code || ''}</div>
                          </div>
                          <select class="form-control attendance-status" data-type="${idType}" data-id="${id}" style="width:130px;">
                            <option value="present" ${s.status === 'present' ? 'selected' : ''}>‚úì C√≥ m·∫∑t</option>
                            <option value="late" ${s.status === 'late' ? 'selected' : ''}>‚è∞ ƒêi mu·ªôn</option>
                            <option value="excused" ${s.status === 'excused' ? 'selected' : ''}>üìù C√≥ ph√©p</option>
                            <option value="absent" ${s.status === 'absent' ? 'selected' : ''}>‚úó V·∫Øng</option>
                          </select>
                          <input type="text" class="form-control attendance-note" data-type="${idType}" data-id="${id}" 
                                 value="${s.note || ''}" placeholder="Ghi ch√∫" style="width:150px;">
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : '<div class="empty-state"><p>Ch∆∞a c√≥ h·ªçc sinh trong l·ªõp</p></div>'}
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAttendanceModal()">H·ªßy</button>
                ${students.length ? `
                  <button class="btn btn-success" onclick="quickMarkAll('present')"><i class="fas fa-check-double"></i> T·∫•t c·∫£ c√≥ m·∫∑t</button>
                  <button class="btn btn-primary" onclick="saveAttendanceForm(${sessionId})"><i class="fas fa-save"></i> L∆∞u ƒëi·ªÉm danh</button>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('attendanceFormModal');
        if (existingModal) existingModal.remove();

        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } catch (e) { ui.error(e.message); }
    }

    function closeAttendanceModal() {
      const modal = document.getElementById('attendanceFormModal');
      if (modal) modal.remove();
    }

    function quickMarkAll(status) {
      document.querySelectorAll('.attendance-status').forEach(select => {
        select.value = status;
      });
    }

    async function saveAttendanceForm(sessionId) {
      const attendances = [];
      
      document.querySelectorAll('.attendance-status').forEach(select => {
        const type = select.dataset.type;
        const id = select.dataset.id;
        const noteInput = document.querySelector(`.attendance-note[data-type="${type}"][data-id="${id}"]`);
        
        const data = { status: select.value, note: noteInput?.value || '' };
        if (type === 'student') data.studentId = parseInt(id);
        else data.trialStudentId = parseInt(id);
        attendances.push(data);
      });

      try {
        await api.post(`/attendance/session/${sessionId}/mark`, { attendances });
        ui.success('L∆∞u ƒëi·ªÉm danh th√†nh c√¥ng');
        closeAttendanceModal();
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    async function markAttendance(sessionId) {
      switchTab('attendance');
      openAttendanceModal(sessionId);
    }
    // ============================================
    // TAB: B√ÄI T·∫¨P
    // ============================================
    function renderAssignmentsTab() {
      document.getElementById('tab-assignments').innerHTML = `
        ${auth.hasRole('TEACHER', 'CM', 'ADMIN') ? `
          <div style="margin-bottom:16px;">
            <button class="btn btn-primary" onclick="openAddAssignment()"><i class="fas fa-plus"></i> Giao b√†i t·∫≠p</button>
          </div>
        ` : ''}
        ${currentAssignments.length ? `
          <div class="assignments-list">
            ${currentAssignments.map(a => `
              <div class="assignment-card">
                <h4><i class="fas fa-tasks"></i> ${a.title}</h4>
                <p>${a.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                <div class="assignment-meta">
                  ${a.session_number ? `<span><i class="fas fa-calendar"></i> Bu·ªïi ${a.session_number}</span>` : ''}
                  <span><i class="fas fa-clock"></i> H·∫°n: ${a.due_date ? ui.formatDate(a.due_date) : 'Kh√¥ng gi·ªõi h·∫°n'}</span>
                  <span><i class="fas fa-user-check"></i> ${a.submission_count || 0} n·ªôp</span>
                </div>
                ${auth.hasRole('TEACHER', 'CM', 'ADMIN') ? `
                  <div style="margin-top:12px;">
                    <button class="btn btn-sm btn-danger" onclick="deleteAssignment(${a.id})"><i class="fas fa-trash"></i></button>
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        ` : '<div class="empty-state"><i class="fas fa-tasks"></i><p>Ch∆∞a c√≥ b√†i t·∫≠p</p></div>'}
      `;
    }

    function openAddAssignment() {
      document.getElementById('assignmentClassId').value = currentClass.id;
      document.getElementById('assignmentSessionSelect').innerHTML = '<option value="">-- Kh√¥ng g·∫Øn bu·ªïi c·ª• th·ªÉ --</option>' +
        currentSessions.map(s => `<option value="${s.id}">Bu·ªïi ${s.session_number} - ${ui.formatDate(s.session_date)}</option>`).join('');
      form.reset(document.getElementById('assignmentForm'));
      modal.show('assignmentModal');
    }

    async function saveAssignment() {
      const formEl = document.getElementById('assignmentForm');
      if (!form.validate(formEl)) { ui.error('Vui l√≤ng ƒëi·ªÅn ti√™u ƒë·ªÅ'); return; }
      const data = form.getData(formEl);
      data.classId = document.getElementById('assignmentClassId').value;

      try {
        await api.post('/assignments', data);
        ui.success('Giao b√†i t·∫≠p th√†nh c√¥ng');
        modal.hide('assignmentModal');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    async function deleteAssignment(id) {
      if (!confirm('X√≥a b√†i t·∫≠p n√†y?')) return;
      try {
        await api.delete(`/assignments/${id}`);
        ui.success('ƒê√£ x√≥a');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    // ============================================
    // STUDENT MANAGEMENT
    // ============================================
    async function openAddStudent() {
      const studentCode = prompt('Nh·∫≠p m√£ h·ªçc sinh:');
      if (!studentCode) return;
      try {
        const result = await api.get(`/students?search=${studentCode}`);
        const students = result.data || [];
        if (!students.length) { ui.error('Kh√¥ng t√¨m th·∫•y h·ªçc sinh'); return; }
        const student = students[0];
        if (confirm(`Th√™m h·ªçc sinh "${student.full_name}" v√†o l·ªõp?`)) {
          await api.post(`/classes/${currentClass.id}/students`, { studentId: student.id });
          ui.success('ƒê√£ th√™m h·ªçc sinh');
          viewClass(currentClass.id);
        }
      } catch (e) { ui.error(e.message); }
    }

    async function removeStudent(studentId) {
      if (!confirm('X√≥a h·ªçc sinh kh·ªèi l·ªõp?')) return;
      try {
        await api.delete(`/classes/${currentClass.id}/students/${studentId}`);
        ui.success('ƒê√£ x√≥a');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
