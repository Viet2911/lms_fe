<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L·ªõp h·ªçc - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .class-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .class-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .class-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .class-card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .class-card-code {
      font-size: 12px;
      color: var(--text-muted);
      font-family: monospace;
    }

    .class-card-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .class-card-info i {
      width: 16px;
      color: var(--primary-color);
    }

    .class-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 12px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      color: var(--primary-color);
      background: var(--bg-secondary);
    }

    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-btn .badge {
      background: var(--primary-color);
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-mini {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-mini {
      background: var(--bg-secondary);
      padding: 12px 16px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
    }

    .stat-mini .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .stat-mini .label {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Sessions horizontal scroll */
    .sessions-scroll {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 8px 0 16px;
    }

    .sessions-scroll::-webkit-scrollbar {
      height: 6px;
    }

    .sessions-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .session-box {
      min-width: 100px;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      border: 2px solid transparent;
    }

    .session-box:hover:not(.disabled) {
      transform: scale(1.05);
    }

    .session-box.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.5);
    }

    .session-box.completed {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border-color: #22c55e;
    }

    .session-box.pending {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-color: #f59e0b;
    }

    .session-box.future {
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      border-color: #9ca3af;
    }

    .session-box.active {
      border-color: #2563eb;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      transform: scale(1.05);
    }

    .session-box .session-num {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
    }

    .session-box .session-date {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .session-box .session-status {
      font-size: 10px;
      margin-top: 6px;
      padding: 2px 6px;
      border-radius: 8px;
    }

    .session-box.completed .session-status {
      background: #22c55e;
      color: white;
    }

    .session-box.pending .session-status {
      background: #f59e0b;
      color: white;
    }

    .session-box.future .session-status {
      background: #9ca3af;
      color: white;
    }

    /* Attendance table */
    .attendance-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    .attendance-table th {
      text-align: left;
      padding: 8px 12px;
      font-size: 13px;
      color: #6b7280;
      font-weight: 500;
    }

    .attendance-table td {
      padding: 12px;
      background: white;
    }

    .attendance-table tr td:first-child {
      border-radius: 8px 0 0 8px;
    }

    .attendance-table tr td:last-child {
      border-radius: 0 8px 8px 0;
    }

    .attendance-table .student-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .attendance-table .student-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .attendance-table .student-name {
      font-weight: 600;
      color: #1f2937;
    }

    .attendance-table .student-code {
      font-size: 11px;
      color: #9ca3af;
      font-family: monospace;
    }

    /* Status buttons */
    .status-buttons {
      display: flex;
      gap: 6px;
    }

    .status-btn {
      padding: 6px 12px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .status-btn:hover {
      background: #f3f4f6;
    }

    .status-btn.active.on-time {
      background: #dcfce7;
      border-color: #22c55e;
      color: #166534;
    }

    .status-btn.active.late {
      background: #fef3c7;
      border-color: #f59e0b;
      color: #92400e;
    }

    .status-btn.active.excused {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1e40af;
    }

    .status-btn.active.absent {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }

    /* Warning badge */
    .warning-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #fee2e2;
      color: #dc2626;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Add student modal */
    .student-select-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .student-select-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .student-select-item:hover {
      background: #f3f4f6;
      border-color: #3b82f6;
    }

    .student-select-item.selected {
      background: #dbeafe;
      border-color: #3b82f6;
    }

    .student-select-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .student-select-info {
      flex: 1;
    }

    .student-select-name {
      font-weight: 600;
      color: #1f2937;
    }

    .student-select-meta {
      font-size: 12px;
      color: #6b7280;
    }

    /* Assignment cards */
    .assignment-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .assignment-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .assignment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .assignment-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .assignment-title i {
      color: #3b82f6;
    }

    .assignment-desc {
      color: #6b7280;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
      white-space: pre-wrap;
    }

    .assignment-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 13px;
      color: #6b7280;
    }

    .assignment-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .assignment-meta i {
      color: #9ca3af;
    }

    .assignment-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f3f4f6;
    }

    /* Submission list */
    .submission-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .submission-item .student-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .submission-info {
      flex: 1;
    }

    .submission-name {
      font-weight: 600;
      color: #1f2937;
    }

    .submission-time {
      font-size: 12px;
      color: #6b7280;
    }

    .submission-grade {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .submission-grade.graded {
      background: #dcfce7;
      color: #166534;
    }

    .submission-grade.pending {
      background: #fef3c7;
      color: #92400e;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar"></aside>
    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i
              class="fas fa-bars"></i></button>
          <div>
            <h1 class="page-title">L·ªõp h·ªçc</h1>
          </div>
        </div>
        <div class="header-right">
          <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-sync"></i></button>
          <button class="btn btn-primary" onclick="openCreateModal()" id="btnCreate"><i class="fas fa-plus"></i> Th√™m
            l·ªõp</button>
          <div class="user-menu" onclick="auth.logout()">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
              <div class="user-name" id="userName">User</div>
              <div class="user-role" id="userRole">Role</div>
            </div>
          </div>
        </div>
      </header>

      <div class="page-content">
        <div class="filters-bar">
          <div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchInput"
              placeholder="T√¨m ki·∫øm..." onkeyup="if(event.key==='Enter') loadData()"></div>
          <select id="statusFilter" class="filter-select" onchange="loadData()">
            <option value="">T·∫•t c·∫£</option>
            <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
            <option value="inactive">Ng·ª´ng</option>
          </select>
          <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-search"></i></button>
        </div>
        <div class="cards-grid" id="classesGrid">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-overlay" id="formModal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Th√™m l·ªõp h·ªçc</h3><button class="modal-close"
          onclick="modal.hide('formModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="classForm">
          <input type="hidden" id="classId">
          <div class="form-group" id="branchFormGroup">
            <label class="form-label required"><i class="fas fa-building"></i> C∆° s·ªü</label>
            <select name="branchId" id="branchFormSelect" class="form-control" required>
              <option value="">ƒêang t·∫£i...</option>
            </select>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label required">T√™n l·ªõp</label><input type="text"
                name="className" class="form-control" required></div>
            <div class="form-group"><label class="form-label">M√¥n h·ªçc</label><select name="subjectId"
                class="form-control" id="subjectSelect">
                <option value="">Ch·ªçn</option>
              </select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">C·∫•p ƒë·ªô</label><select name="levelId" class="form-control"
                id="levelSelect">
                <option value="">Ch·ªçn</option>
              </select></div>
            <div class="form-group"><label class="form-label">Gi√°o vi√™n</label><select name="teacherId"
                class="form-control" id="teacherSelect">
                <option value="">Ch·ªçn</option>
              </select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">CM</label><select name="cmId" class="form-control"
                id="cmSelect">
                <option value="">Ch·ªçn</option>
              </select></div>
            <div class="form-group"><label class="form-label">Ph√≤ng</label><input type="text" name="room"
                class="form-control"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Ng√†y h·ªçc</label><input type="text" name="studyDays"
                class="form-control" placeholder="T2, T4, T6"></div>
            <div class="form-group"><label class="form-label">S·ªë bu·ªïi</label><input type="number" name="totalSessions"
                class="form-control" value="15"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Gi·ªù b·∫Øt ƒë·∫ßu</label><input type="time" name="startTime"
                class="form-control"></div>
            <div class="form-group"><label class="form-label">Gi·ªù k·∫øt th√∫c</label><input type="time" name="endTime"
                class="form-control"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Ng√†y khai gi·∫£ng</label><input type="date" name="startDate"
                class="form-control"></div>
            <div class="form-group"><label class="form-label">Sƒ© s·ªë t·ªëi ƒëa</label><input type="number"
                name="maxStudents" class="form-control" value="15"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="modal.hide('formModal')">H·ªßy</button><button
          class="btn btn-primary" onclick="saveClass()"><i class="fas fa-save"></i> L∆∞u</button></div>
    </div>
  </div>

  <!-- Detail Modal with Tabs -->
  <div class="modal-overlay" id="detailModal">
    <div class="modal-content xl" style="max-width: 1000px;">
      <div class="modal-header"
        style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border-radius: 12px 12px 0 0;">
        <div>
          <h3 class="modal-title" id="detailTitle">Chi ti·∫øt l·ªõp h·ªçc</h3>
          <p id="detailCode" style="opacity:0.8; font-size:13px; margin:0;"></p>
        </div>
        <button class="modal-close" onclick="modal.hide('detailModal')" style="color:white;">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0;">
        <div class="tabs" style="padding: 0 20px; background: var(--bg-secondary);">
          <button class="tab-btn active" onclick="switchTab('info')"><i class="fas fa-info-circle"></i> Th√¥ng
            tin</button>
          <button class="tab-btn" onclick="switchTab('students')"><i class="fas fa-users"></i> H·ªçc sinh <span
              class="badge" id="studentCount">0</span></button>
          <button class="tab-btn" onclick="switchTab('attendance')"><i class="fas fa-clipboard-check"></i> ƒêi·ªÉm
            danh</button>
          <button class="tab-btn" onclick="switchTab('feedback')"><i class="fas fa-comment-alt"></i> Nh·∫≠n x√©t</button>
          <button class="tab-btn" onclick="switchTab('assignments')"><i class="fas fa-book-open"></i> BTVN <span
              class="badge" id="assignmentCount">0</span></button>
        </div>

        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
          <div id="tab-info" class="tab-content active"></div>
          <div id="tab-students" class="tab-content"></div>
          <div id="tab-attendance" class="tab-content"></div>
          <div id="tab-feedback" class="tab-content"></div>
          <div id="tab-assignments" class="tab-content"></div>
        </div>
      </div>
      <div class="modal-footer" id="detailFooter"></div>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div class="modal-overlay" id="addStudentModal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-user-plus"></i> Th√™m h·ªçc sinh v√†o l·ªõp</h3>
        <button class="modal-close" onclick="modal.hide('addStudentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filters-bar" style="margin-bottom:16px">
          <div class="search-box" style="flex:1">
            <i class="fas fa-search"></i>
            <input type="text" id="studentSearchInput" placeholder="T√¨m theo t√™n, SƒêT..."
              onkeyup="filterWaitingStudents()">
          </div>
        </div>
        <p style="margin-bottom:12px;color:#6b7280;font-size:13px">
          <i class="fas fa-info-circle"></i> Danh s√°ch h·ªçc sinh ƒëang ch·ªù l·ªõp (status: waiting/pending)
        </p>
        <div class="student-select-list" id="waitingStudentsList">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span id="selectedCount" style="flex:1;color:#6b7280">ƒê√£ ch·ªçn: 0 h·ªçc sinh</span>
        <button class="btn btn-secondary" onclick="modal.hide('addStudentModal')">H·ªßy</button>
        <button class="btn btn-primary" onclick="addSelectedStudents()"><i class="fas fa-plus"></i> Th√™m v√†o
          l·ªõp</button>
      </div>
    </div>
  </div>

  <!-- Assignment Modal -->
  <div class="modal-overlay" id="assignmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="assignmentModalTitle"><i class="fas fa-book-open"></i> Giao b√†i t·∫≠p v·ªÅ nh√†</h3>
        <button class="modal-close" onclick="modal.hide('assignmentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="assignmentForm">
          <input type="hidden" id="assignmentId">
          <div class="form-group">
            <label class="form-label">Bu·ªïi h·ªçc</label>
            <select name="sessionId" id="assignmentSessionSelect" class="form-control">
              <option value="">-- Kh√¥ng g·∫Øn bu·ªïi c·ª• th·ªÉ --</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label required">Ti√™u ƒë·ªÅ b√†i t·∫≠p</label>
            <input type="text" name="title" class="form-control" placeholder="VD: BTVN Bu·ªïi 3 - L·∫Øp robot xe" required>
          </div>
          <div class="form-group">
            <label class="form-label">M√¥ t·∫£ / Y√™u c·∫ßu</label>
            <textarea name="description" class="form-control" rows="4"
              placeholder="M√¥ t·∫£ chi ti·∫øt b√†i t·∫≠p, y√™u c·∫ßu c·∫ßn ho√†n th√†nh..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">H·∫°n n·ªôp</label>
              <input type="date" name="dueDate" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">Gi·ªù</label>
              <input type="time" name="dueTime" class="form-control" value="23:59">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="modal.hide('assignmentModal')">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveAssignment()"><i class="fas fa-save"></i> L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- View Submissions Modal -->
  <div class="modal-overlay" id="submissionsModal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-file-alt"></i> B√†i n·ªôp</h3>
        <button class="modal-close" onclick="modal.hide('submissionsModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div id="submissionsList"></div>
      </div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/sidebar.js"></script>
  <script>
    let classes = [];
    let currentClass = null;
    let currentSessions = [];
    let currentStudents = [];
    let currentAssignments = [];
    let waitingStudents = [];
    let selectedStudentIds = [];
    let selectedSessionId = null;
    let attendanceData = {};

    async function init() {
      if (!auth.checkAuth()) return;
      buildSidebar('sidebar');
      if (!auth.hasRole('CM', 'ADMIN')) document.getElementById('btnCreate').style.display = 'none';
      setupBranchSelect();
      await loadOptions();
      await loadData();
    }

    function setupBranchSelect() { loadBranchOptions(); }

    async function loadBranchOptions() {
      const branchGroup = document.getElementById('branchFormGroup');
      const branchSelect = document.getElementById('branchFormSelect');
      try {
        const result = await api.get('/branches');
        const allBranches = result.data || [];
        if (allBranches.length === 0) { branchSelect.innerHTML = '<option value="">Ch∆∞a c√≥ c∆° s·ªü</option>'; return; }

        const userBranches = auth.user?.branches || [];
        const isAdmin = auth.user?.is_system_wide;

        if (userBranches.length > 0 && !isAdmin) {
          if (userBranches.length === 1) {
            branchGroup.style.display = 'none';
            branchSelect.innerHTML = `<option value="${userBranches[0].id}">${userBranches[0].name}</option>`;
            branchSelect.value = userBranches[0].id;
          } else {
            branchGroup.style.display = 'block';
            const primaryId = auth.user?.primaryBranch?.id || userBranches[0]?.id;
            branchSelect.innerHTML = userBranches.map(b =>
              `<option value="${b.id}" ${b.id == primaryId ? 'selected' : ''}>${b.name}</option>`
            ).join('');
          }
        } else {
          branchGroup.style.display = 'block';
          const currentBranchId = branch.getId() || allBranches[0]?.id;
          branchSelect.innerHTML = allBranches.map(b =>
            `<option value="${b.id}" ${b.id == currentBranchId ? 'selected' : ''}>${b.name}</option>`
          ).join('');
        }
      } catch (e) { console.error(e); }
    }

    async function loadOptions() {
      try {
        const [subjects, levels, teachers, cms] = await Promise.all([
          api.get('/common/subjects'), api.get('/common/levels'),
          api.get('/users/by-role/TEACHER'), api.get('/users/by-role/CM')
        ]);
        document.getElementById('subjectSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (subjects.data || []).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        document.getElementById('levelSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (levels.data || []).map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        document.getElementById('teacherSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (teachers.data || []).map(t => `<option value="${t.id}">${t.full_name}</option>`).join('');
        document.getElementById('cmSelect').innerHTML = '<option value="">Ch·ªçn</option>' + (cms.data || []).map(c => `<option value="${c.id}">${c.full_name}</option>`).join('');
      } catch (e) { console.error(e); }
    }

    async function loadData() {
      const search = document.getElementById('searchInput').value;
      const status = document.getElementById('statusFilter').value;
      const container = document.getElementById('classesGrid');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      try {
        const params = {};
        if (search) params.search = search;
        if (status) params.status = status;
        const query = branch.buildQuery(params);
        const result = await api.get('/classes' + query);
        classes = result.data || [];
        renderClasses();
      } catch (e) { container.innerHTML = '<p>L·ªói: ' + e.message + '</p>'; }
    }

    function renderClasses() {
      const container = document.getElementById('classesGrid');
      const showBranch = auth.user?.is_system_wide && !branch.getId();
      if (!classes.length) { container.innerHTML = '<div class="empty-state"><i class="fas fa-chalkboard"></i><p>Ch∆∞a c√≥ l·ªõp h·ªçc</p></div>'; return; }
      container.innerHTML = classes.map(c => `
        <div class="class-card" onclick="viewClass(${c.id})">
          <div class="class-card-header">
            <div>
              <div class="class-card-title">${escapeHtml(c.class_name)}</div>
              <div class="class-card-code">${c.class_code}</div>
            </div>
            <span class="badge badge-${c.status === 'active' ? 'success' : 'secondary'}">${c.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Ng·ª´ng'}</span>
          </div>
          ${showBranch && c.branch_name ? `<div class="branch-tag" style="margin-bottom:8px;"><i class="fas fa-building"></i> ${c.branch_name}</div>` : ''}
          <div class="class-card-info">
            <div><i class="fas fa-book"></i> ${c.subject_name || 'Ch∆∞a ch·ªçn m√¥n'}</div>
            <div><i class="fas fa-layer-group"></i> ${c.level_name || '-'}</div>
            <div><i class="fas fa-chalkboard-teacher"></i> ${c.teacher_name || 'Ch∆∞a c√≥ GV'}</div>
            <div><i class="fas fa-users"></i> ${c.student_count || 0}/${c.max_students || 15}</div>
            <div><i class="fas fa-calendar"></i> ${c.study_days || '-'}</div>
            <div><i class="fas fa-clock"></i> ${c.start_time?.substring(0, 5) || '-'}</div>
          </div>
          <div class="class-card-footer">
            <span style="font-size:12px;color:var(--text-muted)"><i class="fas fa-door-open"></i> ${c.room || 'Ch∆∞a c√≥ ph√≤ng'}</span>
            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();viewClass(${c.id})"><i class="fas fa-eye"></i></button>
          </div>
        </div>
      `).join('');
    }

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Th√™m l·ªõp h·ªçc';
      document.getElementById('classId').value = '';
      form.reset(document.getElementById('classForm'));
      modal.show('formModal');
    }

    async function editClass(id) {
      try {
        const result = await api.get(`/classes/${id}`);
        const c = result.data;
        document.getElementById('modalTitle').textContent = 'S·ª≠a l·ªõp h·ªçc';
        document.getElementById('classId').value = id;
        form.setData(document.getElementById('classForm'), {
          branchId: c.branch_id, className: c.class_name, subjectId: c.subject_id, levelId: c.level_id,
          teacherId: c.teacher_id, cmId: c.cm_id, room: c.room, studyDays: c.study_days,
          totalSessions: c.total_sessions, startTime: c.start_time?.substring(0, 5), endTime: c.end_time?.substring(0, 5),
          startDate: c.start_date?.substring(0, 10), maxStudents: c.max_students
        });
        modal.show('formModal');
      } catch (e) { ui.error(e.message); }
    }

    async function saveClass() {
      const formEl = document.getElementById('classForm');
      if (!form.validate(formEl)) { ui.error('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß'); return; }
      const data = form.getData(formEl);
      const id = document.getElementById('classId').value;
      try {
        if (id) await api.put(`/classes/${id}`, data);
        else await api.post('/classes', data);
        ui.success('L∆∞u th√†nh c√¥ng');
        modal.hide('formModal');
        loadData();
      } catch (e) { ui.error(e.message); }
    }

    // ============================================
    // VIEW CLASS DETAIL
    // ============================================
    async function viewClass(id) {
      try {
        const [classRes, studentsRes, sessionsRes, assignmentsRes] = await Promise.all([
          api.get(`/classes/${id}`),
          api.get(`/classes/${id}/students`),
          api.get(`/sessions?classId=${id}`),
          api.get(`/assignments?classId=${id}`)
        ]);

        currentClass = classRes.data;
        currentStudents = studentsRes.data || [];
        currentSessions = sessionsRes.data || [];
        currentAssignments = assignmentsRes.data || [];

        document.getElementById('detailTitle').textContent = currentClass.class_name;
        document.getElementById('detailCode').textContent = currentClass.class_code;
        document.getElementById('studentCount').textContent = currentStudents.length;
        document.getElementById('assignmentCount').textContent = currentAssignments.length;

        renderInfoTab();
        renderStudentsTab();
        renderAttendanceTab();
        renderFeedbackTab();
        renderAssignmentsTab();

        switchTab('info');
        modal.show('detailModal');
      } catch (e) { ui.error(e.message); }
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // ============================================
    // TAB: TH√îNG TIN
    // ============================================
    function renderInfoTab() {
      const c = currentClass;
      const completedSessions = currentSessions.filter(s => s.attendance_submitted).length;

      document.getElementById('tab-info').innerHTML = `
        <div class="stats-mini">
          <div class="stat-mini"><div class="value">${currentStudents.length}</div><div class="label">H·ªçc sinh</div></div>
          <div class="stat-mini"><div class="value">${completedSessions}/${currentSessions.length}</div><div class="label">ƒê√£ ƒëi·ªÉm danh</div></div>
          <div class="stat-mini"><div class="value">${c.total_sessions || 15}</div><div class="label">T·ªïng bu·ªïi</div></div>
        </div>
        
        <div class="detail-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:24px;">
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">M√¥n h·ªçc</label><div style="font-weight:600">${c.subject_name || '-'}</div></div>
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">C·∫•p ƒë·ªô</label><div style="font-weight:600">${c.level_name || '-'}</div></div>
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">Gi√°o vi√™n</label><div style="font-weight:600">${c.teacher_name || '-'}</div></div>
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">CM</label><div style="font-weight:600">${c.cm_name || '-'}</div></div>
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">Ph√≤ng</label><div style="font-weight:600">${c.room || '-'}</div></div>
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">L·ªãch h·ªçc</label><div style="font-weight:600">${c.study_days || '-'} (${c.start_time?.substring(0, 5) || ''} - ${c.end_time?.substring(0, 5) || ''})</div></div>
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">Ng√†y khai gi·∫£ng</label><div style="font-weight:600">${formatDate(c.start_date)}</div></div>
          <div class="detail-item" style="background:#f9fafb;padding:12px;border-radius:8px"><label style="color:#6b7280;font-size:12px">Sƒ© s·ªë</label><div style="font-weight:600">${currentStudents.length} / ${c.max_students || 15}</div></div>
        </div>
        
        ${auth.hasRole('CM', 'ADMIN') ? `
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="editClass(${c.id})"><i class="fas fa-edit"></i> S·ª≠a</button>
            <button class="btn btn-primary" onclick="generateSessions()"><i class="fas fa-magic"></i> T·∫°o bu·ªïi h·ªçc</button>
          </div>
        ` : ''}
      `;
    }

    // ============================================
    // TAB: H·ªåC SINH
    // ============================================
    function renderStudentsTab() {
      document.getElementById('tab-students').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h4 style="margin:0"><i class="fas fa-users"></i> Danh s√°ch h·ªçc sinh (${currentStudents.length})</h4>
          ${auth.hasRole('CM', 'ADMIN') ? `<button class="btn btn-primary" onclick="openAddStudentModal()"><i class="fas fa-user-plus"></i> Th√™m h·ªçc sinh</button>` : ''}
        </div>
        
        ${currentStudents.length ? `
          <table class="table">
            <thead><tr><th>M√£</th><th>H·ªç t√™n</th><th>SƒêT PH</th><th>ƒê√∫ng gi·ªù</th><th>Mu·ªôn</th><th>Ngh·ªâ</th><th></th></tr></thead>
            <tbody>
              ${currentStudents.map(s => {
        const hasWarning = (s.late_count || 0) + (s.absent_count || 0) >= 3;
        return `
                <tr>
                  <td><code style="font-size:11px">${s.student_code || '-'}</code></td>
                  <td>
                    <strong>${escapeHtml(s.full_name)}</strong>
                    ${hasWarning ? '<span class="warning-badge"><i class="fas fa-exclamation-triangle"></i> C·∫£nh b√°o</span>' : ''}
                  </td>
                  <td>${s.parent_phone || '-'}</td>
                  <td><span class="badge badge-success">${s.ontime_count || 0}</span></td>
                  <td><span class="badge badge-warning">${s.late_count || 0}</span></td>
                  <td><span class="badge badge-danger">${s.absent_count || 0}</span></td>
                  <td>
                    ${auth.hasRole('CM', 'ADMIN') ? `<button class="btn btn-sm btn-danger" onclick="removeStudent(${s.id})" title="X√≥a kh·ªèi l·ªõp"><i class="fas fa-times"></i></button>` : ''}
                  </td>
                </tr>
              `;
      }).join('')}
            </tbody>
          </table>
        ` : '<div class="empty-state" style="padding:40px"><i class="fas fa-users" style="font-size:48px;color:#d1d5db"></i><p>Ch∆∞a c√≥ h·ªçc sinh trong l·ªõp</p></div>'}
      `;
    }

    // ============================================
    // TAB: ƒêI·ªÇM DANH
    // ============================================
    function renderAttendanceTab() {
      selectedSessionId = null;
      attendanceData = {};

      if (!currentSessions.length) {
        document.getElementById('tab-attendance').innerHTML = `
          <div class="empty-state" style="padding:40px">
            <i class="fas fa-calendar-alt" style="font-size:48px;color:#d1d5db"></i>
            <p>Ch∆∞a c√≥ bu·ªïi h·ªçc</p>
            ${auth.hasRole('CM', 'ADMIN') ? `<button class="btn btn-primary" onclick="generateSessions()"><i class="fas fa-magic"></i> T·∫°o bu·ªïi h·ªçc</button>` : ''}
          </div>
        `;
        return;
      }

      document.getElementById('tab-attendance').innerHTML = `
        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 8px"><i class="fas fa-calendar-alt"></i> Ch·ªçn bu·ªïi h·ªçc ƒë·ªÉ ƒëi·ªÉm danh</h4>
          <p style="margin:0;font-size:12px;color:#6b7280">
            <i class="fas fa-info-circle"></i> 
            Gi√°o vi√™n: ƒëi·ªÉm danh tr∆∞·ªõc 5 ph√∫t ~ sau 15 ph√∫t bu·ªïi h·ªçc | 
            CM/OM/Admin: ƒëi·ªÉm danh m·ªçi l√∫c
          </p>
        </div>
        <div class="sessions-scroll" id="sessionsScroll">
          ${currentSessions.map(s => {
        const sessionStatus = getSessionStatus(s);
        return `
              <div class="session-box ${sessionStatus.statusClass} ${sessionStatus.canAttend ? '' : 'disabled'}" 
                   onclick="${sessionStatus.canAttend ? `selectSession(${s.id})` : 'showAttendanceRestriction()'}" 
                   id="session-${s.id}"
                   title="${sessionStatus.tooltip}">
                <div class="session-num">B${s.session_number}</div>
                <div class="session-date">${formatDateShort(s.session_date)}</div>
                <div class="session-status">${sessionStatus.statusText}</div>
              </div>
            `;
      }).join('')}
        </div>
        
        <div id="attendanceContent">
          <div style="text-align:center;padding:40px;color:#6b7280">
            <i class="fas fa-hand-pointer" style="font-size:32px;margin-bottom:12px"></i>
            <p>Ch·ªçn m·ªôt bu·ªïi h·ªçc ·ªü tr√™n ƒë·ªÉ ƒëi·ªÉm danh</p>
          </div>
        </div>
      `;
    }

    function getSessionStatus(session) {
      const now = new Date();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const sessionDate = new Date(session.session_date);
      sessionDate.setHours(0, 0, 0, 0);

      // Parse session time
      const [startHour, startMin] = (session.start_time || '08:00').split(':').map(Number);
      const [endHour, endMin] = (session.end_time || '09:30').split(':').map(Number);

      // Create session datetime objects
      const sessionStart = new Date(session.session_date);
      sessionStart.setHours(startHour, startMin, 0, 0);

      const sessionEnd = new Date(session.session_date);
      sessionEnd.setHours(endHour, endMin, 0, 0);

      // Time window: 5 minutes before start to 15 minutes after end
      const attendanceWindowStart = new Date(sessionStart.getTime() - 5 * 60 * 1000);
      const attendanceWindowEnd = new Date(sessionEnd.getTime() + 15 * 60 * 1000);

      // Check user role
      const isTeacher = auth.user?.role_name === 'TEACHER';
      const canAlwaysAttend = auth.hasRole('CM', 'OM', 'HOEC', 'ADMIN');

      // Determine status
      let statusClass, statusText, canAttend, tooltip;

      if (session.attendance_submitted) {
        statusClass = 'completed';
        statusText = '‚úì Xong';
        canAttend = canAlwaysAttend; // CM/Admin can edit
        tooltip = 'ƒê√£ ƒëi·ªÉm danh' + (canAlwaysAttend ? ' - C√≥ th·ªÉ s·ª≠a' : '');
      } else if (sessionDate > today) {
        // Future session
        statusClass = 'future';
        statusText = 'Ch∆∞a t·ªõi';
        canAttend = canAlwaysAttend;
        tooltip = isTeacher ? 'Ch∆∞a ƒë·∫øn ng√†y h·ªçc' : 'Bu·ªïi h·ªçc ch∆∞a di·ªÖn ra';
      } else if (sessionDate.getTime() === today.getTime()) {
        // Today's session
        if (now < attendanceWindowStart) {
          // Before time window
          statusClass = 'future';
          statusText = 'Ch·ªù...';
          canAttend = canAlwaysAttend;
          tooltip = isTeacher
            ? `C√≥ th·ªÉ ƒëi·ªÉm danh t·ª´ ${formatTime(attendanceWindowStart)}`
            : 'Ch∆∞a ƒë·∫øn gi·ªù ƒëi·ªÉm danh';
        } else if (now >= attendanceWindowStart && now <= attendanceWindowEnd) {
          // Within time window - Teacher can attend
          statusClass = 'pending';
          statusText = '‚ö† ƒêi·ªÉm danh';
          canAttend = true;
          tooltip = 'ƒêang trong th·ªùi gian ƒëi·ªÉm danh';
        } else {
          // After time window
          statusClass = 'pending';
          statusText = '‚ö† Qu√° gi·ªù';
          canAttend = canAlwaysAttend;
          tooltip = isTeacher
            ? 'ƒê√£ qu√° th·ªùi gian ƒëi·ªÉm danh (sau 15p). Li√™n h·ªá CM.'
            : 'C·∫ßn ƒëi·ªÉm danh';
        }
      } else {
        // Past session
        statusClass = 'pending';
        statusText = '‚ö† Tr·ªÖ';
        canAttend = canAlwaysAttend;
        tooltip = isTeacher
          ? 'Bu·ªïi h·ªçc ƒë√£ qua. Li√™n h·ªá CM ƒë·ªÉ ƒëi·ªÉm danh.'
          : 'C·∫ßn ƒëi·ªÉm danh b√π';
      }

      return { statusClass, statusText, canAttend, tooltip };
    }

    function formatTime(date) {
      return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
    }

    function showAttendanceRestriction() {
      const isTeacher = auth.user?.role_name === 'TEACHER';
      if (isTeacher) {
        ui.warning('B·∫°n ch·ªâ c√≥ th·ªÉ ƒëi·ªÉm danh trong kho·∫£ng: tr∆∞·ªõc 5 ph√∫t ~ sau 15 ph√∫t bu·ªïi h·ªçc. Li√™n h·ªá CM/OM n·∫øu c·∫ßn ƒëi·ªÉm danh ngo√†i th·ªùi gian n√†y.');
      } else {
        ui.warning('Bu·ªïi h·ªçc ch∆∞a di·ªÖn ra ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn ƒëi·ªÉm danh.');
      }

    }

    async function selectSession(sessionId) {
      selectedSessionId = sessionId;

      // Update visual
      document.querySelectorAll('.session-box').forEach(box => box.classList.remove('active'));
      document.getElementById(`session-${sessionId}`).classList.add('active');

      // Load attendance data
      try {
        const res = await api.get(`/attendance/session/${sessionId}`);
        const existingAttendance = res.data || [];

        // Build attendance data map
        attendanceData = {};
        currentStudents.forEach(s => {
          const existing = existingAttendance.find(a => a.student_id === s.id);
          attendanceData[s.id] = existing?.status || 'on_time';
        });

        renderAttendanceForm();
      } catch (e) {
        // No existing data, default to on_time
        currentStudents.forEach(s => {
          attendanceData[s.id] = 'on_time';
        });
        renderAttendanceForm();
      }
    }

    function renderAttendanceForm() {
      const session = currentSessions.find(s => s.id === selectedSessionId);
      if (!session) return;

      document.getElementById('attendanceContent').innerHTML = `
        <div style="background:#f9fafb;padding:16px;border-radius:12px;margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h4 style="margin:0">Bu·ªïi ${session.session_number} - ${formatDate(session.session_date)}</h4>
              <p style="margin:4px 0 0;color:#6b7280;font-size:13px">${session.start_time?.substring(0, 5) || ''} - ${session.end_time?.substring(0, 5) || ''}</p>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-sm btn-secondary" onclick="quickMarkAll('on_time')"><i class="fas fa-check-double"></i> T·∫•t c·∫£ ƒë√∫ng gi·ªù</button>
            </div>
          </div>
        </div>
        
        ${currentStudents.length ? `
          <table class="attendance-table">
            <thead><tr><th>H·ªçc sinh</th><th>Tr·∫°ng th√°i ƒëi·ªÉm danh</th></tr></thead>
            <tbody>
              ${currentStudents.map(s => {
        const current = attendanceData[s.id] || 'on_time';
        const hasWarning = (s.late_count || 0) + (s.absent_count || 0) >= 3;
        return `
                <tr>
                  <td>
                    <div class="student-info">
                      <div class="student-avatar">${s.full_name.charAt(0)}</div>
                      <div>
                        <div class="student-name">${escapeHtml(s.full_name)} ${hasWarning ? '<span class="warning-badge"><i class="fas fa-exclamation-triangle"></i></span>' : ''}</div>
                        <div class="student-code">${s.student_code || ''}</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="status-buttons">
                      <button class="status-btn on-time ${current === 'on_time' ? 'active' : ''}" onclick="setAttendance(${s.id}, 'on_time')">
                        <i class="fas fa-check"></i> ƒê√∫ng gi·ªù
                      </button>
                      <button class="status-btn late ${current === 'late' ? 'active' : ''}" onclick="setAttendance(${s.id}, 'late')">
                        <i class="fas fa-clock"></i> Mu·ªôn
                      </button>
                      <button class="status-btn excused ${current === 'excused' ? 'active' : ''}" onclick="setAttendance(${s.id}, 'excused')">
                        <i class="fas fa-envelope"></i> C√≥ ph√©p
                      </button>
                      <button class="status-btn absent ${current === 'absent' ? 'active' : ''}" onclick="setAttendance(${s.id}, 'absent')">
                        <i class="fas fa-times"></i> Kh√¥ng ph√©p
                      </button>
                    </div>
                  </td>
                </tr>
              `;
      }).join('')}
            </tbody>
          </table>
          
          <div style="margin-top:20px;display:flex;justify-content:flex-end;gap:12px">
            <button class="btn btn-secondary" onclick="renderAttendanceTab()">H·ªßy</button>
            <button class="btn btn-primary" onclick="saveAttendance()"><i class="fas fa-save"></i> L∆∞u ƒëi·ªÉm danh</button>
          </div>
        ` : '<p class="text-muted">Kh√¥ng c√≥ h·ªçc sinh ƒë·ªÉ ƒëi·ªÉm danh</p>'}
      `;
    }

    function setAttendance(studentId, status) {
      attendanceData[studentId] = status;

      // Update button visual
      const row = document.querySelector(`tr:has([onclick="setAttendance(${studentId}, 'on_time')"])`);
      if (row) {
        row.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
        row.querySelector(`.status-btn.${status.replace('_', '-')}`).classList.add('active');
      }
    }

    function quickMarkAll(status) {
      currentStudents.forEach(s => {
        attendanceData[s.id] = status;
      });
      renderAttendanceForm();
    }

    async function saveAttendance() {
      if (!selectedSessionId) return;

      const attendances = Object.entries(attendanceData).map(([studentId, status]) => ({
        studentId: parseInt(studentId),
        status: status
      }));

      try {
        await api.post(`/attendance/session/${selectedSessionId}/mark`, { attendances });
        ui.success('L∆∞u ƒëi·ªÉm danh th√†nh c√¥ng');

        // Reload class data
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    // ============================================
    // TAB: NH·∫¨N X√âT SAU BU·ªîI H·ªåC
    // ============================================
    let feedbackSessionId = null;
    let feedbackData = {};

    function renderFeedbackTab() {
      if (!currentSessions.length) {
        document.getElementById('tab-feedback').innerHTML = '<p class="text-muted text-center">Ch∆∞a c√≥ bu·ªïi h·ªçc n√†o</p>';
        return;
      }

      // Show sessions list
      document.getElementById('tab-feedback').innerHTML = `
        <div style="margin-bottom:16px">
          <h4 style="margin:0 0 12px"><i class="fas fa-comment-alt"></i> Nh·∫≠n x√©t sau bu·ªïi h·ªçc</h4>
          <p style="color:#6b7280;font-size:13px;margin:0">Ch·ªçn bu·ªïi h·ªçc ƒë·ªÉ xem/th√™m nh·∫≠n x√©t cho h·ªçc sinh</p>
        </div>
        
        <div class="sessions-scroll" style="margin-bottom:20px">
          ${currentSessions.map(s => `
            <div class="session-box ${s.attendance_submitted ? 'completed' : 'future'}" 
                 id="feedback-session-${s.id}" onclick="selectFeedbackSession(${s.id})">
              <div class="session-num">${s.session_number}</div>
              <div class="session-date">${formatDate(s.session_date)}</div>
            </div>
          `).join('')}
        </div>
        
        <div id="feedbackContent">
          <p class="text-muted text-center">üëÜ Ch·ªçn bu·ªïi h·ªçc ƒë·ªÉ xem nh·∫≠n x√©t</p>
        </div>
      `;
    }

    async function selectFeedbackSession(sessionId) {
      feedbackSessionId = sessionId;

      // Update visual
      document.querySelectorAll('#tab-feedback .session-box').forEach(box => box.classList.remove('active'));
      document.getElementById(`feedback-session-${sessionId}`).classList.add('active');

      // Load existing feedbacks
      try {
        const res = await api.get(`/sessions/${sessionId}/feedbacks`);
        const existingFeedbacks = res.data || [];

        feedbackData = {};
        currentStudents.forEach(s => {
          const existing = existingFeedbacks.find(f => f.student_id === s.id);
          feedbackData[s.id] = {
            rating: existing?.rating || 0,
            feedback: existing?.feedback || '',
            homework_assigned: existing?.homework_assigned || false,
            parent_notified: existing?.parent_notified || false
          };
        });

        renderFeedbackForm();
      } catch (e) {
        console.error(e);
        currentStudents.forEach(s => {
          feedbackData[s.id] = { rating: 0, feedback: '', homework_assigned: false, parent_notified: false };
        });
        renderFeedbackForm();
      }
    }

    function renderFeedbackForm() {
      const session = currentSessions.find(s => s.id === feedbackSessionId);
      if (!session) return;

      document.getElementById('feedbackContent').innerHTML = `
        <div style="background:#f9fafb;padding:16px;border-radius:12px;margin-bottom:16px">
          <h4 style="margin:0">Bu·ªïi ${session.session_number} - ${formatDate(session.session_date)}</h4>
        </div>
        
        ${currentStudents.length ? `
          <div class="feedback-list">
            ${currentStudents.map(s => {
        const fb = feedbackData[s.id] || {};
        return `
              <div class="feedback-item" style="background:white;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                  <div style="display:flex;align-items:center;gap:12px">
                    <div class="student-avatar" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;display:flex;align-items:center;justify-content:center;font-weight:600">${s.full_name.charAt(0)}</div>
                    <div>
                      <div style="font-weight:600">${escapeHtml(s.full_name)}</div>
                      <div style="font-size:12px;color:#6b7280">${s.student_code || ''}</div>
                    </div>
                  </div>
                  <div class="rating-stars" style="display:flex;gap:4px">
                    ${[1, 2, 3, 4, 5].map(star => `
                      <i class="fas fa-star" style="cursor:pointer;font-size:20px;color:${fb.rating >= star ? '#f59e0b' : '#d1d5db'}" 
                         onclick="setFeedbackRating(${s.id}, ${star})"></i>
                    `).join('')}
                  </div>
                </div>
                <textarea class="form-control" placeholder="Nh·∫≠n x√©t v·ªÅ h·ªçc sinh..." rows="2" style="margin-bottom:12px"
                          onchange="setFeedbackText(${s.id}, this.value)">${fb.feedback || ''}</textarea>
                <div style="display:flex;gap:16px;font-size:13px">
                  <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                    <input type="checkbox" ${fb.homework_assigned ? 'checked' : ''} onchange="setFeedbackCheckbox(${s.id}, 'homework_assigned', this.checked)">
                    <i class="fas fa-book"></i> ƒê√£ giao BTVN
                  </label>
                  <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                    <input type="checkbox" ${fb.parent_notified ? 'checked' : ''} onchange="setFeedbackCheckbox(${s.id}, 'parent_notified', this.checked)">
                    <i class="fas fa-bell"></i> ƒê√£ th√¥ng b√°o PH
                  </label>
                </div>
              </div>
            `;
      }).join('')}
          </div>
          
          <div style="margin-top:20px;display:flex;justify-content:flex-end;gap:12px">
            <button class="btn btn-secondary" onclick="renderFeedbackTab()">H·ªßy</button>
            <button class="btn btn-primary" onclick="saveFeedbacks()"><i class="fas fa-save"></i> L∆∞u nh·∫≠n x√©t</button>
          </div>
        ` : '<p class="text-muted">Kh√¥ng c√≥ h·ªçc sinh</p>'}
      `;
    }

    function setFeedbackRating(studentId, rating) {
      feedbackData[studentId].rating = rating;
      // Update stars visual
      const item = document.querySelector(`[onclick="setFeedbackRating(${studentId}, 1)"]`).closest('.feedback-item');
      item.querySelectorAll('.fa-star').forEach((star, idx) => {
        star.style.color = idx < rating ? '#f59e0b' : '#d1d5db';
      });
    }

    function setFeedbackText(studentId, text) {
      feedbackData[studentId].feedback = text;
    }

    function setFeedbackCheckbox(studentId, field, checked) {
      feedbackData[studentId][field] = checked;
    }

    async function saveFeedbacks() {
      if (!feedbackSessionId) { ui.warning('Ch∆∞a ch·ªçn bu·ªïi h·ªçc'); return; }

      try {
        // Save each student feedback
        for (const studentId of Object.keys(feedbackData)) {
          const fb = feedbackData[studentId];
          await api.post(`/sessions/${feedbackSessionId}/feedbacks`, {
            student_id: parseInt(studentId),
            rating: fb.rating,
            feedback: fb.feedback,
            homework_assigned: fb.homework_assigned,
            parent_notified: fb.parent_notified
          });
        }

        ui.success('ƒê√£ l∆∞u nh·∫≠n x√©t th√†nh c√¥ng');
      } catch (e) { ui.error(e.message); }
    }

    // ============================================
    // ADD STUDENT FROM WAITING LIST
    // ============================================
    async function openAddStudentModal() {
      selectedStudentIds = [];
      document.getElementById('selectedCount').textContent = 'ƒê√£ ch·ªçn: 0 h·ªçc sinh';
      document.getElementById('studentSearchInput').value = '';
      document.getElementById('waitingStudentsList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      modal.show('addStudentModal');

      try {
        // Load students with status waiting, pending, or active (ƒë·ªÉ c√≥ th·ªÉ th√™m v√†o l·ªõp)
        const branchId = currentClass.branch_id;
        const [res1, res2, res3] = await Promise.all([
          api.get(`/students?status=waiting&branchId=${branchId}&limit=100`),
          api.get(`/students?status=pending&branchId=${branchId}&limit=100`),
          api.get(`/students?status=active&branchId=${branchId}&limit=100`)
        ]);

        waitingStudents = [...(res1.data || []), ...(res2.data || []), ...(res3.data || [])];

        // Remove duplicates by id
        waitingStudents = waitingStudents.filter((s, i, arr) => arr.findIndex(x => x.id === s.id) === i);

        // Filter out students already in class
        const existingIds = currentStudents.map(s => s.id);
        waitingStudents = waitingStudents.filter(s => !existingIds.includes(s.id));

        renderWaitingStudents();
      } catch (e) {
        document.getElementById('waitingStudentsList').innerHTML = '<p class="text-danger">L·ªói t·∫£i d·ªØ li·ªáu</p>';
      }
    }

    function renderWaitingStudents() {
      const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
      let filtered = waitingStudents;

      if (searchTerm) {
        filtered = waitingStudents.filter(s =>
          s.full_name.toLowerCase().includes(searchTerm) ||
          (s.parent_phone || '').includes(searchTerm) ||
          (s.student_code || '').toLowerCase().includes(searchTerm)
        );
      }

      if (!filtered.length) {
        document.getElementById('waitingStudentsList').innerHTML = `
          <div style="text-align:center;padding:40px;color:#6b7280">
            <i class="fas fa-user-clock" style="font-size:48px;margin-bottom:12px;color:#d1d5db"></i>
            <p>Kh√¥ng c√≥ h·ªçc sinh ƒëang ch·ªù l·ªõp</p>
          </div>
        `;
        return;
      }

      document.getElementById('waitingStudentsList').innerHTML = filtered.map(s => `
        <div class="student-select-item ${selectedStudentIds.includes(s.id) ? 'selected' : ''}" onclick="toggleStudentSelect(${s.id})">
          <input type="checkbox" ${selectedStudentIds.includes(s.id) ? 'checked' : ''} onclick="event.stopPropagation();toggleStudentSelect(${s.id})">
          <div class="student-avatar" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;display:flex;align-items:center;justify-content:center;font-weight:600">${s.full_name.charAt(0)}</div>
          <div class="student-select-info">
            <div class="student-select-name">${escapeHtml(s.full_name)}</div>
            <div class="student-select-meta">
              <span><i class="fas fa-phone"></i> ${s.parent_phone || '-'}</span>
              <span style="margin-left:12px"><i class="fas fa-book"></i> ${s.subject_name || 'Ch∆∞a ch·ªçn m√¥n'}</span>
              <span style="margin-left:12px;color:${s.status === 'active' ? '#10b981' : '#f59e0b'}"><i class="fas fa-${s.status === 'active' ? 'check-circle' : 'clock'}"></i> ${s.status === 'waiting' ? 'ƒê·ª£i l·ªõp' : s.status === 'pending' ? 'Ch·ªù x·∫øp l·ªõp' : 'ƒêang h·ªçc'}</span>
            </div>
          </div>
          <code style="font-size:11px;color:#9ca3af">${s.student_code || ''}</code>
        </div>
      `).join('');
    }

    function filterWaitingStudents() {
      renderWaitingStudents();
    }

    function toggleStudentSelect(studentId) {
      const idx = selectedStudentIds.indexOf(studentId);
      if (idx > -1) {
        selectedStudentIds.splice(idx, 1);
      } else {
        selectedStudentIds.push(studentId);
      }

      document.getElementById('selectedCount').textContent = `ƒê√£ ch·ªçn: ${selectedStudentIds.length} h·ªçc sinh`;
      renderWaitingStudents();
    }

    async function addSelectedStudents() {
      if (!selectedStudentIds.length) {
        ui.warning('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 h·ªçc sinh');
        return;
      }

      try {
        let addedCount = 0;
        for (const studentId of selectedStudentIds) {
          await api.post(`/classes/${currentClass.id}/students`, { studentId });
          addedCount++;
        }

        ui.success(`ƒê√£ th√™m ${addedCount} h·ªçc sinh v√†o l·ªõp`);
        modal.hide('addStudentModal');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    async function removeStudent(studentId) {
      if (!confirm('X√≥a h·ªçc sinh kh·ªèi l·ªõp n√†y?')) return;
      try {
        await api.delete(`/classes/${currentClass.id}/students/${studentId}`);
        ui.success('ƒê√£ x√≥a h·ªçc sinh kh·ªèi l·ªõp');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    async function generateSessions() {
      if (!confirm('T·∫°o bu·ªïi h·ªçc t·ª± ƒë·ªông d·ª±a tr√™n l·ªãch h·ªçc?')) return;
      try {
        await api.post('/sessions/generate', { classId: currentClass.id });
        ui.success('ƒê√£ t·∫°o bu·ªïi h·ªçc');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    // ============================================
    // TAB: B√ÄI T·∫¨P V·ªÄ NH√Ä (BTVN)
    // ============================================
    function renderAssignmentsTab() {
      document.getElementById('tab-assignments').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h4 style="margin:0"><i class="fas fa-book-open"></i> B√†i t·∫≠p v·ªÅ nh√† (${currentAssignments.length})</h4>
          ${auth.hasRole('TEACHER', 'CM', 'ADMIN') ? `<button class="btn btn-primary" onclick="openAssignmentModal()"><i class="fas fa-plus"></i> Giao BTVN</button>` : ''}
        </div>
        
        ${currentAssignments.length ? `
          <div class="assignments-list">
            ${currentAssignments.map(a => `
              <div class="assignment-card">
                <div class="assignment-header">
                  <div class="assignment-title">
                    <i class="fas fa-tasks"></i>
                    ${escapeHtml(a.title)}
                  </div>
                  ${a.session_number ? `<span class="badge badge-info">Bu·ªïi ${a.session_number}</span>` : ''}
                </div>
                ${a.description ? `<div class="assignment-desc">${escapeHtml(a.description)}</div>` : ''}
                <div class="assignment-meta">
                  ${a.due_date ? `<span><i class="fas fa-clock"></i> H·∫°n: ${formatDate(a.due_date)} ${a.due_time ? a.due_time.substring(0, 5) : ''}</span>` : '<span><i class="fas fa-clock"></i> Kh√¥ng gi·ªõi h·∫°n</span>'}
                  <span><i class="fas fa-file-alt"></i> ${a.submission_count || 0} b√†i n·ªôp</span>
                  <span><i class="fas fa-check-circle"></i> ${a.graded_count || 0} ƒë√£ ch·∫•m</span>
                  <span><i class="fas fa-user"></i> ${a.created_by_name || '-'}</span>
                </div>
                <div class="assignment-actions">
                  <button class="btn btn-sm btn-secondary" onclick="viewSubmissions(${a.id})"><i class="fas fa-eye"></i> Xem b√†i n·ªôp</button>
                  ${auth.hasRole('TEACHER', 'CM', 'ADMIN') ? `
                    <button class="btn btn-sm btn-secondary" onclick="editAssignment(${a.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAssignment(${a.id})"><i class="fas fa-trash"></i></button>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        ` : `
          <div class="empty-state" style="padding:40px">
            <i class="fas fa-book-open" style="font-size:48px;color:#d1d5db"></i>
            <p>Ch∆∞a c√≥ b√†i t·∫≠p v·ªÅ nh√†</p>
            ${auth.hasRole('TEACHER', 'CM', 'ADMIN') ? `<button class="btn btn-primary" onclick="openAssignmentModal()"><i class="fas fa-plus"></i> Giao BTVN ƒë·∫ßu ti√™n</button>` : ''}
          </div>
        `}
      `;
    }

    function openAssignmentModal(assignmentId = null) {
      document.getElementById('assignmentModalTitle').innerHTML = assignmentId
        ? '<i class="fas fa-edit"></i> S·ª≠a b√†i t·∫≠p'
        : '<i class="fas fa-book-open"></i> Giao b√†i t·∫≠p v·ªÅ nh√†';
      document.getElementById('assignmentId').value = assignmentId || '';

      // Populate session dropdown
      document.getElementById('assignmentSessionSelect').innerHTML =
        '<option value="">-- Kh√¥ng g·∫Øn bu·ªïi c·ª• th·ªÉ --</option>' +
        currentSessions.map(s => `<option value="${s.id}">Bu·ªïi ${s.session_number} - ${formatDate(s.session_date)}</option>`).join('');

      if (!assignmentId) {
        form.reset(document.getElementById('assignmentForm'));
      }

      modal.show('assignmentModal');
    }

    async function editAssignment(id) {
      try {
        const res = await api.get(`/assignments/${id}`);
        const a = res.data;

        openAssignmentModal(id);

        form.setData(document.getElementById('assignmentForm'), {
          sessionId: a.session_id || '',
          title: a.title,
          description: a.description || '',
          dueDate: a.due_date ? a.due_date.substring(0, 10) : '',
          dueTime: a.due_time ? a.due_time.substring(0, 5) : '23:59'
        });
      } catch (e) { ui.error(e.message); }
    }

    async function saveAssignment() {
      const formEl = document.getElementById('assignmentForm');
      if (!form.validate(formEl)) { ui.error('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ b√†i t·∫≠p'); return; }

      const data = form.getData(formEl);
      data.classId = currentClass.id;

      const id = document.getElementById('assignmentId').value;

      try {
        if (id) {
          await api.put(`/assignments/${id}`, data);
          ui.success('C·∫≠p nh·∫≠t b√†i t·∫≠p th√†nh c√¥ng');
        } else {
          await api.post('/assignments', data);
          ui.success('Giao b√†i t·∫≠p th√†nh c√¥ng');
        }
        modal.hide('assignmentModal');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    async function deleteAssignment(id) {
      if (!confirm('X√≥a b√†i t·∫≠p n√†y? T·∫•t c·∫£ b√†i n·ªôp c≈©ng s·∫Ω b·ªã x√≥a.')) return;
      try {
        await api.delete(`/assignments/${id}`);
        ui.success('ƒê√£ x√≥a b√†i t·∫≠p');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    async function viewSubmissions(assignmentId) {
      try {
        const [assignmentRes, submissionsRes] = await Promise.all([
          api.get(`/assignments/${assignmentId}`),
          api.get(`/assignments/${assignmentId}/submissions`)
        ]);

        const assignment = assignmentRes.data;
        const submissions = submissionsRes.data || [];

        document.getElementById('submissionsList').innerHTML = `
          <div style="margin-bottom:16px;padding:16px;background:#f9fafb;border-radius:8px">
            <h4 style="margin:0 0 8px">${escapeHtml(assignment.title)}</h4>
            <p style="margin:0;color:#6b7280;font-size:13px">${escapeHtml(assignment.description || 'Kh√¥ng c√≥ m√¥ t·∫£')}</p>
          </div>
          
          ${submissions.length ? `
            <div class="submissions-list">
              ${submissions.map(s => `
                <div class="submission-item">
                  <div class="student-avatar">${s.student_name?.charAt(0) || 'S'}</div>
                  <div class="submission-info">
                    <div class="submission-name">${escapeHtml(s.student_name)} <code style="font-size:11px;color:#9ca3af">${s.student_code || ''}</code></div>
                    <div class="submission-time">N·ªôp l√∫c: ${formatDateTime(s.submitted_at)}</div>
                    ${s.content ? `<div style="margin-top:8px;padding:8px;background:#f3f4f6;border-radius:4px;font-size:13px">${escapeHtml(s.content)}</div>` : ''}
                  </div>
                  <div>
                    ${s.status === 'graded'
            ? `<span class="submission-grade graded">${s.grade} ƒëi·ªÉm</span>`
            : `<span class="submission-grade pending">Ch∆∞a ch·∫•m</span>`
          }
                    ${auth.hasRole('TEACHER', 'ADMIN') && s.status !== 'graded' ? `
                      <button class="btn btn-sm btn-primary" onclick="gradeSubmission(${s.id})" style="margin-left:8px"><i class="fas fa-check"></i> Ch·∫•m</button>
                    ` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          ` : `
            <div style="text-align:center;padding:40px;color:#6b7280">
              <i class="fas fa-inbox" style="font-size:48px;margin-bottom:12px;color:#d1d5db"></i>
              <p>Ch∆∞a c√≥ h·ªçc sinh n·ªôp b√†i</p>
            </div>
          `}
        `;

        modal.show('submissionsModal');
      } catch (e) { ui.error(e.message); }
    }

    async function gradeSubmission(submissionId) {
      const grade = prompt('Nh·∫≠p ƒëi·ªÉm (0-10):');
      if (grade === null) return;

      const gradeNum = parseFloat(grade);
      if (isNaN(gradeNum) || gradeNum < 0 || gradeNum > 10) {
        ui.error('ƒêi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn 10');
        return;
      }

      const feedback = prompt('Nh·∫≠n x√©t (t√πy ch·ªçn):') || '';

      try {
        await api.post(`/assignments/${submissionId}/grade`, { grade: gradeNum, feedback });
        ui.success('Ch·∫•m ƒëi·ªÉm th√†nh c√¥ng');
        modal.hide('submissionsModal');
        viewClass(currentClass.id);
      } catch (e) { ui.error(e.message); }
    }

    // Helpers
    function escapeHtml(str) {
      return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('vi-VN');
    }

    function formatDateShort(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return `${d.getDate()}/${d.getMonth() + 1}`;
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleString('vi-VN');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>