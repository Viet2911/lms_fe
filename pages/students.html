<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªçc vi√™n - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card.active {
      border-color: var(--primary);
      background: rgba(52, 168, 83, 0.08);
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .stat-icon.primary {
      background: #dbeafe;
      color: #2563eb;
    }

    .stat-icon.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .stat-icon.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .stat-icon.info {
      background: #e0e7ff;
      color: #4f46e5;
    }

    .stat-icon.danger {
      background: #fee2e2;
      color: #dc2626;
    }

    .stat-icon.gray {
      background: #f3f4f6;
      color: #6b7280;
    }

    .stat-icon.purple {
      background: #f3e8ff;
      color: #9333ea;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.active {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.paused {
      background: #e0e7ff;
      color: #4338ca;
    }

    .status-badge.waiting {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.expired {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.expiring_soon {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.quit_paid {
      background: #fecaca;
      color: #dc2626;
    }

    .status-badge.quit_refund {
      background: #fed7aa;
      color: #c2410c;
    }

    .status-badge.reserved {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .student-info {
      display: flex;
      flex-direction: column;
    }

    .student-name {
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
    }

    .student-name:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    .student-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .sessions-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .sessions-badge.low {
      background: #fee2e2;
      color: #dc2626;
    }

    .sessions-badge.normal {
      background: #dcfce7;
      color: #166534;
    }

    .detail-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .detail-section h4 {
      margin: 0 0 12px;
      color: var(--primary);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-row {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 120px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .detail-value {
      flex: 1;
      font-size: 13px;
      color: var(--text-primary);
    }

    .form-section {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .form-section h4 {
      margin: 0 0 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-section.blue {
      background: linear-gradient(135deg, #dbeafe, #e0e7ff);
    }

    .form-section.blue h4 {
      color: #1e40af;
    }

    .form-section.yellow {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
    }

    .form-section.yellow h4 {
      color: #92400e;
    }

    .form-section.green {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    }

    .form-section.green h4 {
      color: #166534;
    }

    .form-section.pink {
      background: linear-gradient(135deg, #fce7f3, #fbcfe8);
    }

    .form-section.pink h4 {
      color: #9d174d;
    }

    .form-section.purple {
      background: linear-gradient(135deg, #ede9fe, #ddd6fe);
    }

    .form-section.purple h4 {
      color: #6b21a8;
    }

    .summary-box {
      background: #1f2937;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
    }

    .gift-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #fdf2f8;
      border: 1px solid #f9a8d4;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gift-checkbox:hover {
      background: #fce7f3;
    }

    .gift-checkbox.checked {
      background: #db2777;
      color: white;
      border-color: #db2777;
    }

    .gift-checkbox.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f3f4f6;
      border-color: #e5e7eb;
    }

    .gift-checkbox input {
      display: none;
    }

    .gift-qty {
      font-size: 11px;
      opacity: 0.7;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid #374151;
    }
  </style>
</head>

<body>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')"><i
            class="fas fa-bars"></i></button>
        <h1><i class="fas fa-user-graduate"></i> H·ªçc vi√™n</h1>
      </div>
      <div class="topbar-right">
        <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-sync"></i></button>
        <button class="btn btn-primary" onclick="openCreateModal()" id="btnCreate"><i class="fas fa-plus"></i> Th√™m h·ªçc
          vi√™n</button>
      </div>
    </div>
    <div class="stats-grid" id="statsGrid"></div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-body" style="padding:16px">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <div class="search-box" style="flex:1;min-width:250px">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="T√¨m t√™n, SƒêT, m√£ h·ªçc vi√™n..."
              onkeyup="if(event.key==='Enter')loadData()">
          </div>
          <select id="classFilter" class="form-control" style="width:180px" onchange="loadData()">
            <option value="">T·∫•t c·∫£ l·ªõp</option>
          </select>
          <select id="feeMonthFilter" class="form-control" style="width:180px" onchange="loadData()">
            <option value="">H·∫øt ph√≠ t·∫•t c·∫£</option>
            <option value="0">Th√°ng n√†y</option>
            <option value="1">Th√°ng sau</option>
            <option value="2">2 th√°ng t·ªõi</option>
            <option value="3">3 th√°ng t·ªõi</option>
          </select>
          <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-search"></i> T√¨m</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>H·ªçc vi√™n</th>
              <th>Ph·ª• huynh</th>
              <th>L·ªõp</th>
              <th class="text-center">Bu·ªïi c√≤n</th>
              <th class="text-center">H·∫øt ph√≠</th>
              <th class="text-center">Tr·∫°ng th√°i</th>
              <th class="text-center">Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="dataTable">
            <tr>
              <td colspan="7" class="text-center">ƒêang t·∫£i...</td>
            </tr>
          </tbody>
        </table>
        <div id="pagination" class="pagination"></div>
      </div>
    </div>
  </main>

  <!-- Form Modal -->
  <div class="modal" id="formModal">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-header">
        <div class="modal-title" id="formTitle"><i class="fas fa-user-graduate"></i> Th√™m h·ªçc vi√™n m·ªõi</div>
        <button class="modal-close" onclick="closeFormModal()">&times;</button>
      </div>
      <div class="modal-body" style="max-height:80vh;overflow-y:auto">
        <input type="hidden" id="formId">
        <!-- Th√¥ng tin h·ªçc sinh -->
        <div class="form-section blue">
          <h4><i class="fas fa-child"></i> Th√¥ng tin H·ªçc sinh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label class="required">H·ªç t√™n h·ªçc sinh</label><input type="text"
                id="fStudentName" class="form-control"></div>
            <div class="form-group"><label>NƒÉm sinh</label><input type="number" id="fBirthYear" class="form-control"
                placeholder="2015"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Gi·ªõi t√≠nh</label>
              <select id="fGender" class="form-control">
                <option value="">Ch·ªçn</option>
                <option value="male">Nam</option>
                <option value="female">N·ªØ</option>
              </select>
            </div>
            <div class="form-group" style="flex:2"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="fAddress"
                class="form-control"></div>
          </div>
        </div>
        <!-- Th√¥ng tin ph·ª• huynh -->
        <div class="form-section yellow">
          <h4><i class="fas fa-users"></i> Th√¥ng tin Ph·ª• huynh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label class="required">H·ªç t√™n PH</label><input type="text"
                id="fParentName" class="form-control"></div>
            <div class="form-group"><label class="required">SƒêT</label><input type="tel" id="fParentPhone"
                class="form-control"></div>
          </div>
          <div class="form-group"><label>Email</label><input type="email" id="fParentEmail" class="form-control"></div>
        </div>
        <!-- Th√¥ng tin kh√≥a h·ªçc -->
        <div class="form-section green">
          <h4><i class="fas fa-book"></i> Th√¥ng tin Kh√≥a h·ªçc</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="required">G√≥i h·ªçc ph√≠</label>
              <select id="fPackage" class="form-control" onchange="onPackageChange()">
                <option value="">-- Ch·ªçn g√≥i --</option>
              </select>
            </div>
            <div class="form-group">
              <label>H·ªçc ph√≠ g·ªëc</label>
              <input type="text" id="fFeeOriginal" class="form-control" value="0ƒë" readonly
                style="background:#f3f4f6;font-weight:bold">
            </div>
          </div>
          <!-- Gi·∫£m gi√° -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#16a34a;font-weight:600"><i class="fas fa-percent"></i> Gi·∫£m gi√°</label>
            <div class="form-row" style="margin-top:8px">
              <div class="form-group" style="flex:2;margin-bottom:0">
                <select id="fPromoProgram" class="form-control" onchange="applyPromoProgram()">
                  <option value="">-- Kh√¥ng √°p d·ª•ng --</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <input type="text" id="fPromoDiscount" class="form-control" value="0ƒë" readonly
                  style="background:#dcfce7;color:#16a34a;font-weight:bold;text-align:right">
              </div>
            </div>
          </div>
          <!-- H·ªçc b·ªïng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <label style="color:#2563eb;font-weight:600;margin:0"><i class="fas fa-graduation-cap"></i> H·ªçc b·ªïng t·∫∑ng
                k√®m</label>
              <span id="fDefaultScholarshipBadge"
                style="background:#dbeafe;color:#2563eb;padding:4px 10px;border-radius:12px;font-size:12px;display:none">M·∫∑c
                ƒë·ªãnh: <strong id="fDefaultScholarshipMonths">0</strong> th√°ng</span>
            </div>
            <div class="form-row" style="align-items:center">
              <div class="form-group" style="margin-bottom:0;flex:1">
                <input type="number" id="fScholarshipMonths" class="form-control" value="0" min="0" max="12"
                  onchange="onScholarshipChange()" style="font-size:18px;font-weight:bold;text-align:center">
              </div>
              <span style="padding:0 12px;color:#6b7280">th√°ng</span>
            </div>
            <div id="fScholarshipWarning"
              style="display:none;background:#fef3c7;color:#92400e;padding:8px 12px;border-radius:6px;margin-top:8px;font-size:12px">
              <i class="fas fa-exclamation-triangle"></i> V∆∞·ª£t m·ª©c m·∫∑c ƒë·ªãnh, c·∫ßn GDV duy·ªát
            </div>
          </div>
          <!-- Qu√† t·∫∑ng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#db2777;font-weight:600"><i class="fas fa-gift"></i> Qu√† t·∫∑ng</label>
            <div id="giftCheckboxes" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px">
              <span class="text-muted">ƒêang t·∫£i...</span>
            </div>
          </div>
          <!-- T·ªïng k·∫øt -->
          <div class="summary-box">
            <div class="summary-row"><span>Kh√≥a h·ªçc ch√≠nh:</span><span id="fMainCourseMonths">0 th√°ng</span></div>
            <div class="summary-row"><span>H·ªçc b·ªïng t·∫∑ng:</span><span id="fBonusMonths" style="color:#4ade80">+0
                th√°ng</span></div>
            <div class="summary-total">
              <span style="font-size:16px"><strong>H·ªåC PH√ç TH·ª∞C ƒê√ìNG:</strong></span>
              <span id="fFeeTotal" style="font-size:24px;font-weight:bold;color:#fbbf24">0ƒë</span>
            </div>
          </div>
        </div>
        <!-- Thanh to√°n -->
        <div class="form-section pink">
          <h4><i class="fas fa-credit-card"></i> Thanh to√°n</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Tr·∫°ng th√°i</label>
              <select id="fPaymentStatus" class="form-control" onchange="updatePaymentFields()">
                <option value="pending">Ch∆∞a ƒë√≥ng</option>
                <option value="deposit">ƒê·∫∑t c·ªçc</option>
                <option value="partial">ƒê√≥ng 1 ph·∫ßn</option>
                <option value="paid">ƒê√£ ƒë√≥ng ƒë·ªß</option>
              </select>
            </div>
            <div class="form-group" id="fDepositGroup" style="display:none">
              <label>Ti·ªÅn c·ªçc</label>
              <input type="text" id="fDepositAmount" class="form-control" value="0ƒë"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
            <div class="form-group" id="fPaidGroup" style="display:none">
              <label>ƒê√£ thanh to√°n</label>
              <input type="text" id="fPaidAmount" class="form-control" value="0ƒë"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
          </div>
          <div id="fRemainingRow" style="display:none;background:white;padding:12px;border-radius:8px;margin-top:8px">
            <div style="display:flex;justify-content:space-between">
              <span>C√≤n ph·∫£i ƒë√≥ng:</span>
              <span id="fRemaining" style="font-size:18px;font-weight:bold;color:#dc2626">0ƒë</span>
            </div>
          </div>
        </div>
        <div class="form-group"><label>Ghi ch√∫</label><textarea id="fNote" class="form-control" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeFormModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveStudent()"><i class="fas fa-save"></i> L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content" style="max-width:700px">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-user-graduate"></i> Chi ti·∫øt h·ªçc vi√™n</div>
        <button class="modal-close" onclick="closeDetailModal()">&times;</button>
      </div>
      <div class="modal-body" id="detailContent"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDetailModal()">ƒê√≥ng</button>
        <button class="btn btn-purple" onclick="openDocumentsModal(currentDetailId)"
          style="background:#7c3aed;color:white"><i class="fas fa-file-invoice-dollar"></i> Gi·∫•y t·ªù h·ªçc ph√≠</button>
        <button class="btn btn-info" onclick="showPaymentQR(currentDetailId)"><i class="fas fa-qrcode"></i> QR Thanh
          to√°n</button>
        <button class="btn btn-primary" onclick="editStudent(currentDetailId)"><i class="fas fa-edit"></i> S·ª≠a</button>
      </div>
    </div>
  </div>

  <!-- Documents Modal - Gi·∫•y t·ªù h·ªçc ph√≠ -->
  <div class="modal" id="documentsModal">
    <div class="modal-content" style="max-width:650px">
      <div class="modal-header" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white">
        <div class="modal-title"><i class="fas fa-file-invoice-dollar"></i> Gi·∫•y t·ªù h·ªçc ph√≠</div>
        <button class="modal-close" onclick="closeDocumentsModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body" style="padding:20px">
        <input type="hidden" id="docStudentId">
        <!-- Student Info -->
        <div id="docStudentInfo"
          style="display:flex;align-items:center;gap:12px;padding:12px;background:#f3f4f6;border-radius:8px;margin-bottom:16px">
          <div
            style="width:50px;height:50px;border-radius:50%;background:#7c3aed;color:white;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold">
            ?</div>
          <div>
            <div style="font-weight:600;font-size:16px">T√™n h·ªçc vi√™n</div>
            <div style="color:#6b7280;font-size:13px">M√£ h·ªçc vi√™n</div>
          </div>
        </div>

        <!-- Upload Area -->
        <div style="margin-bottom:20px">
          <label style="font-weight:600;color:#374151;margin-bottom:8px;display:block"><i class="fas fa-upload"></i> T·∫£i
            l√™n gi·∫•y t·ªù m·ªõi</label>
          <div class="upload-zone"
            style="border:2px dashed #7c3aed;border-radius:12px;padding:24px;text-align:center;cursor:pointer;background:#faf5ff;transition:all 0.2s"
            onclick="document.getElementById('docUploadInput').click()"
            onmouseover="this.style.background='#ede9fe';this.style.borderColor='#6d28d9'"
            onmouseout="this.style.background='#faf5ff';this.style.borderColor='#7c3aed'">
            <i class="fas fa-cloud-upload-alt" style="font-size:40px;color:#7c3aed;margin-bottom:12px"></i>
            <div style="color:#6d28d9;font-weight:600;font-size:15px">Click ƒë·ªÉ ch·ªçn file</div>
            <div style="color:#9ca3af;font-size:13px;margin-top:4px">Phi·∫øu thu, ƒê∆°n ƒëƒÉng k√Ω h·ªçc, H·ª£p ƒë·ªìng, Bi√™n lai...
            </div>
            <div style="color:#a78bfa;font-size:12px;margin-top:8px">PDF, JPG, PNG ‚Ä¢ T·ªëi ƒëa 5MB</div>
            <input type="file" id="docUploadInput" style="display:none" accept=".pdf,.jpg,.jpeg,.png"
              onchange="uploadDocumentFile(this.files[0])">
          </div>
        </div>

        <!-- Documents List -->
        <div>
          <label style="font-weight:600;color:#374151;margin-bottom:8px;display:block"><i
              class="fas fa-folder-open"></i> Danh s√°ch gi·∫•y t·ªù</label>
          <div id="documentsListContainer" style="max-height:300px;overflow-y:auto">
            <div style="text-align:center;color:#9ca3af;padding:20px">ƒêang t·∫£i...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDocumentsModal()">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal" id="qrModal">
    <div class="modal-content" style="max-width:450px">
      <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white">
        <div class="modal-title"><i class="fas fa-qrcode"></i> Thanh to√°n h·ªçc ph√≠</div>
        <button class="modal-close" onclick="closeQRModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body" style="text-align:center;padding:24px">
        <input type="hidden" id="qrStudentId">
        <input type="hidden" id="qrRemainingRaw" value="0">
        <div id="qrStudentInfo" style="margin-bottom:16px"></div>
        <img id="qrImage" src="" alt="QR Code" style="max-width:220px;border-radius:8px;margin-bottom:16px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
          <div style="background:#dcfce7;padding:12px;border-radius:8px">
            <div style="color:#166534;font-size:12px">ƒê√£ ƒë√≥ng</div>
            <div style="color:#15803d;font-size:18px;font-weight:700" id="qrPaidAmount">0ƒë</div>
          </div>
          <div style="background:#fee2e2;padding:12px;border-radius:8px">
            <div style="color:#991b1b;font-size:12px">C√≤n ph·∫£i ƒë√≥ng</div>
            <div style="color:#dc2626;font-size:18px;font-weight:700" id="qrRemainingAmount">0ƒë</div>
          </div>
        </div>
        <button class="btn btn-success" onclick="confirmPaymentFromQR()" style="width:100%;padding:12px;font-size:16px">
          <i class="fas fa-check-double"></i> X√°c nh·∫≠n ƒë√£ nh·∫≠n thanh to√°n
        </button>
      </div>
      <div class="modal-footer" style="justify-content:center">
        <button class="btn btn-primary" onclick="downloadEnrollmentForm()"><i class="fas fa-file-word"></i> Xu·∫•t ƒë∆°n
          nh·∫≠p h·ªçc</button>
        <button class="btn btn-secondary" onclick="closeQRModal()">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Renewal Modal -->
  <div class="modal" id="renewalModal">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-header" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white">
        <div class="modal-title"><i class="fas fa-sync-alt"></i> T√°i ph√≠ / Gia h·∫°n</div>
        <button class="modal-close" onclick="closeRenewalModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body" style="max-height:80vh;overflow-y:auto">
        <!-- Student Info -->
        <div
          style="background:linear-gradient(135deg,#fef3c7,#fde68a);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#92400e"><i class="fas fa-user-graduate"></i> Th√¥ng tin H·ªçc vi√™n</h4>
          <div id="renewalStudentInfo"></div>
        </div>

        <!-- Lo·∫°i gia h·∫°n -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Lo·∫°i gia h·∫°n</label>
            <select class="form-control" id="renewalType" onchange="toggleNewClassSelect()">
              <option value="extend">Gia h·∫°n th√™m (th√™m v√†o l·ªô tr√¨nh hi·ªán t·∫°i)</option>
              <option value="new">Kh√≥a m·ªõi (ƒëƒÉng k√Ω l·ªõp m·ªõi)</option>
            </select>
          </div>
          <div class="form-group" id="newClassGroup" style="display:none">
            <label class="form-label">Ch·ªçn l·ªõp m·ªõi</label>
            <select class="form-control" id="renewalNewClass"></select>
          </div>
        </div>

        <!-- Kh√≥a h·ªçc -->
        <div
          style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#166534"><i class="fas fa-book"></i> Th√¥ng tin Kh√≥a h·ªçc</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="form-label required">G√≥i h·ªçc ph√≠</label>
              <select class="form-control" id="renewalPackage" onchange="onRenewalPackageChange()"></select>
            </div>
            <div class="form-group">
              <label class="form-label">H·ªçc ph√≠ g·ªëc</label>
              <input type="text" id="renewalFeeOriginal" class="form-control" value="0ƒë" readonly
                style="background:#f3f4f6;font-weight:bold">
            </div>
          </div>

          <!-- Gi·∫£m gi√° -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#16a34a;font-weight:600"><i class="fas fa-percent"></i> Gi·∫£m gi√°</label>
            <div class="form-row" style="margin-top:8px">
              <div class="form-group" style="flex:2;margin-bottom:0">
                <select id="renewalPromotion" class="form-control" onchange="calculateRenewalFee()">
                  <option value="">-- Kh√¥ng √°p d·ª•ng --</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <input type="text" id="renewalPromoDiscount" class="form-control" value="0ƒë" readonly
                  style="background:#dcfce7;color:#16a34a;font-weight:bold;text-align:right">
              </div>
            </div>
          </div>

          <!-- H·ªçc b·ªïng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <label style="color:#2563eb;font-weight:600;margin:0"><i class="fas fa-graduation-cap"></i> H·ªçc b·ªïng t·∫∑ng
                k√®m</label>
              <span id="renewalDefaultScholarshipBadge"
                style="background:#dbeafe;color:#2563eb;padding:4px 10px;border-radius:12px;font-size:12px;display:none">M·∫∑c
                ƒë·ªãnh: <strong id="renewalDefaultScholarshipMonths">0</strong> th√°ng</span>
            </div>
            <div class="form-row" style="align-items:center">
              <div class="form-group" style="margin-bottom:0;flex:1">
                <input type="number" id="renewalScholarship" class="form-control" value="0" min="0" max="12"
                  onchange="calculateRenewalFee()" style="font-size:18px;font-weight:bold;text-align:center">
              </div>
              <span style="padding:0 12px;color:#6b7280">th√°ng (th√™m mi·ªÖn ph√≠)</span>
            </div>
          </div>

          <!-- T·ªïng k·∫øt -->
          <div style="background:#1f2937;color:white;padding:16px;border-radius:8px;margin-top:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Kh√≥a h·ªçc ch√≠nh:</span><span id="renewalMainMonths">0 th√°ng</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>H·ªçc b·ªïng t·∫∑ng:</span><span id="renewalBonusMonths" style="color:#4ade80">+0 th√°ng</span>
            </div>
            <div
              style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid #374151">
              <span style="font-size:16px"><strong>H·ªåC PH√ç TH·ª∞C ƒê√ìNG:</strong></span>
              <span id="renewalFeeTotal" style="font-size:24px;font-weight:bold;color:#fbbf24">0ƒë</span>
            </div>
          </div>
        </div>

        <!-- Thanh to√°n -->
        <div
          style="background:linear-gradient(135deg,#fce7f3,#fbcfe8);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#9d174d"><i class="fas fa-credit-card"></i> Thanh to√°n</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Tr·∫°ng th√°i</label>
              <select id="renewalPaymentStatus" class="form-control" onchange="updateRenewalPaymentFields()">
                <option value="pending">Ch∆∞a ƒë√≥ng</option>
                <option value="deposit">ƒê·∫∑t c·ªçc</option>
                <option value="partial">ƒê√≥ng 1 ph·∫ßn</option>
                <option value="paid">ƒê√£ ƒë√≥ng ƒë·ªß</option>
              </select>
            </div>
            <div class="form-group" id="renewalDepositGroup" style="display:none">
              <label>Ti·ªÅn c·ªçc</label>
              <input type="text" id="renewalDeposit" class="form-control" value="0ƒë"
                oninput="formatRenewalCurrency(this);calculateRenewalFee()">
            </div>
            <div class="form-group" id="renewalPaidGroup" style="display:none">
              <label>ƒê√£ thanh to√°n</label>
              <input type="text" id="renewalPaidAmount" class="form-control" value="0ƒë"
                oninput="formatRenewalCurrency(this);calculateRenewalFee()">
            </div>
          </div>
          <div id="renewalRemainingRow"
            style="display:none;background:white;padding:12px;border-radius:8px;margin-top:8px">
            <div style="display:flex;justify-content:space-between">
              <span>C√≤n ph·∫£i ƒë√≥ng:</span>
              <span id="renewalRemaining" style="font-size:18px;font-weight:bold;color:#dc2626">0ƒë</span>
            </div>
          </div>
        </div>

        <div class="form-group"><label>Ghi ch√∫</label><textarea id="renewalNote" class="form-control"
            rows="2"></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeRenewalModal()">H·ªßy</button>
        <button class="btn btn-primary" onclick="submitRenewal()" style="background:#f59e0b;border-color:#f59e0b"><i
            class="fas fa-check"></i> X√°c nh·∫≠n t√°i ph√≠</button>
      </div>
    </div>
  </div>

  <!-- Renewal Success Modal with QR -->
  <div class="modal" id="renewalSuccessModal">
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white">
        <div class="modal-title"><i class="fas fa-check-circle"></i> T√°i ph√≠ th√†nh c√¥ng!</div>
        <button class="modal-close" onclick="closeRenewalSuccessModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body" style="text-align:center;padding:24px">
        <div style="margin-bottom:20px">
          <i class="fas fa-user-graduate" style="font-size:48px;color:#22c55e;margin-bottom:12px"></i>
          <h3 style="margin:0;color:#166534" id="renewalSuccessName">H·ªçc vi√™n</h3>
          <p style="color:#6b7280;margin:4px 0" id="renewalSuccessCode">M√£: ---</p>
        </div>

        <div id="renewalQRSection" style="display:none">
          <div style="background:#f9fafb;padding:16px;border-radius:12px;margin-bottom:16px">
            <h4 style="margin:0 0 12px;color:#1f2937"><i class="fas fa-qrcode"></i> QR Thanh to√°n</h4>
            <img id="renewalQRImage" src="" alt="QR Code" style="max-width:200px;border-radius:8px">
          </div>
          <div style="margin-bottom:16px">
            <div style="background:#fee2e2;padding:12px;border-radius:8px">
              <div style="color:#991b1b;font-size:13px" id="renewalQRLabel">S·ªë ti·ªÅn c·∫ßn chuy·ªÉn</div>
              <div style="color:#dc2626;font-size:20px;font-weight:700" id="renewalSuccessRemaining">0ƒë</div>
            </div>
          </div>
          <button class="btn btn-success" onclick="confirmRenewalPayment()"
            style="width:100%;padding:12px;font-size:16px">
            <i class="fas fa-check-double"></i> X√°c nh·∫≠n ƒë√£ nh·∫≠n thanh to√°n
          </button>
        </div>

        <div id="renewalFullPaidSection" style="display:none;padding:20px">
          <i class="fas fa-check-double" style="font-size:48px;color:#22c55e;margin-bottom:12px"></i>
          <p style="color:#166534;font-weight:600">ƒê√£ thanh to√°n ƒë·∫ßy ƒë·ªß!</p>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:center">
        <button class="btn btn-secondary" onclick="closeRenewalSuccessModal()">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/sidebar.js"></script>
  <script>
    let students = [], packages = [], promoPrograms = [], availableGifts = [];
    let currentFilter = null, currentDetailId = null;
    let selectedPackage = null, defaultScholarshipMonths = 0;

    const statusConfig = {
      pending: { label: 'Ch·ªù x·∫øp l·ªõp', icon: 'warning' },
      waiting: { label: 'ƒêang ƒë·ª£i l·ªõp', icon: 'info' },
      active: { label: 'ƒêang h·ªçc', icon: 'success' },
      expiring_soon: { label: 'S·∫Øp h·∫øt ph√≠', icon: 'warning' },
      paused: { label: 'T·∫°m d·ª´ng', icon: 'info' },
      expired: { label: 'H·∫øt h·ªçc ph√≠', icon: 'danger' },
      quit_paid: { label: 'Ngh·ªâ b·ªè ph√≠', icon: 'danger' },
      quit_refund: { label: 'Ngh·ªâ r√∫t ph√≠', icon: 'warning' },
      reserved: { label: 'B·∫£o l∆∞u', icon: 'purple' }
    };

    async function init() {
      await auth.requireAuth();
      buildSidebar('sidebar');
      await Promise.all([loadOptions(), loadStats()]);
      await loadData();
    }

    async function loadOptions() {
      const params = branch.current?.id ? `?branch_id=${branch.current.id}` : '';
      try {
        const pkgRes = await api.get('/packages' + params);
        packages = pkgRes.data || [];
      } catch (e) { packages = []; }
      try {
        const promoRes = await api.get('/promotions' + params);
        promoPrograms = promoRes.data || [];
      } catch (e) { promoPrograms = []; }
      try {
        // Load qu√† t·∫∑ng t·ª´ promotion_items
        const giftRes = await api.get('/promotions/items');
        availableGifts = (giftRes.data || []).filter(g => g.stock_quantity > 0);
      } catch (e) { availableGifts = []; }
      try {
        const classRes = await api.get('/classes' + params);
        document.getElementById('classFilter').innerHTML = '<option value="">T·∫•t c·∫£ l·ªõp</option>' +
          (classRes.data || []).map(c => `<option value="${c.id}">${c.class_name || c.name || 'L·ªõp ' + c.id}</option>`).join('');
      } catch (e) { }
    }

    async function loadStats() {
      try {
        const params = branch.current?.id ? `?branch_id=${branch.current.id}` : '';
        const res = await api.get('/students/stats' + params);
        const stats = res.data || {};

        // Update fee filter dropdown with counts
        const feeFilter = document.getElementById('feeMonthFilter');
        const currentValue = feeFilter.value;
        feeFilter.innerHTML = `
          <option value="">H·∫øt ph√≠ t·∫•t c·∫£</option>
          <option value="0">Th√°ng n√†y (${stats.expiring_this_month || 0})</option>
          <option value="1">Th√°ng sau (${stats.expiring_next_month || 0})</option>
          <option value="2">2 th√°ng t·ªõi (${stats.expiring_2_months || 0})</option>
          <option value="3">3 th√°ng t·ªõi (${stats.expiring_3_months || 0})</option>
        `;
        feeFilter.value = currentValue;

        document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card ${!currentFilter ? 'active' : ''}" onclick="filterByStatus(null)">
            <div class="stat-icon primary"><i class="fas fa-users"></i></div>
            <div><div class="stat-value">${stats.total || 0}</div><div class="stat-label">T·ªïng</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'active' ? 'active' : ''}" onclick="filterByStatus('active')">
            <div class="stat-icon success"><i class="fas fa-user-check"></i></div>
            <div><div class="stat-value">${stats.active || 0}</div><div class="stat-label">ƒêang h·ªçc</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'waiting' ? 'active' : ''}" onclick="filterByStatus('waiting')">
            <div class="stat-icon info"><i class="fas fa-clock"></i></div>
            <div><div class="stat-value">${stats.waiting || 0}</div><div class="stat-label">ƒê·ª£i l·ªõp</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'expiring_soon' ? 'active' : ''}" onclick="filterByStatus('expiring_soon')">
            <div class="stat-icon warning"><i class="fas fa-hourglass-half"></i></div>
            <div><div class="stat-value">${stats.expiring_soon || 0}</div><div class="stat-label">S·∫Øp h·∫øt ph√≠</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'expired' ? 'active' : ''}" onclick="filterByStatus('expired')">
            <div class="stat-icon danger"><i class="fas fa-exclamation-circle"></i></div>
            <div><div class="stat-value">${stats.expired || 0}</div><div class="stat-label">H·∫øt ph√≠</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'paused' ? 'active' : ''}" onclick="filterByStatus('paused')">
            <div class="stat-icon gray"><i class="fas fa-pause"></i></div>
            <div><div class="stat-value">${stats.paused || 0}</div><div class="stat-label">T·∫°m d·ª´ng</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'reserved' ? 'active' : ''}" onclick="filterByStatus('reserved')">
            <div class="stat-icon purple"><i class="fas fa-bookmark"></i></div>
            <div><div class="stat-value">${stats.reserved || 0}</div><div class="stat-label">B·∫£o l∆∞u</div></div>
          </div>
        `;
      } catch (e) { console.error(e); }
    }

    function filterByStatus(status) { currentFilter = status; loadStats(); loadData(); }

    async function loadData(page = 1) {
      try {
        const search = document.getElementById('searchInput').value;
        const classId = document.getElementById('classFilter').value;
        const feeMonth = document.getElementById('feeMonthFilter').value;
        const params = new URLSearchParams();

        // Add branch if selected
        if (branch.current?.id) params.append('branch_id', branch.current.id);
        if (search) params.append('search', search);
        if (classId) params.append('class_id', classId);
        if (currentFilter) params.append('status', currentFilter);
        if (feeMonth !== '') params.append('fee_end_month', feeMonth); // L·ªçc theo th√°ng h·∫øt ph√≠
        params.append('page', page);
        params.append('limit', 20);

        const url = '/students?' + params.toString();
        const res = await api.get(url);
        students = res.data || [];
        renderTable(students, res.pagination);
      } catch (e) {
        document.getElementById('dataTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
      }
    }

    function renderTable(items, pagination) {
      const tbody = document.getElementById('dataTable');
      if (!items.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>'; return; }
      tbody.innerHTML = items.map(s => {
        const status = statusConfig[s.status] || { label: s.status };
        const sessionsClass = (s.sessions_remaining || 0) <= 4 ? 'low' : 'normal';
        const showRenewal = ['expired', 'expiring_soon'].includes(s.status) || ['expired', 'expiring_soon'].includes(s.fee_status) || (s.sessions_remaining || 0) <= 4;
        // T√≠nh c√≤n n·ª£ = h·ªçc ph√≠ - ƒë√£ ƒë√≥ng
        const remaining = Math.max(0, (s.tuition_fee || 0) - (s.paid_amount || 0));
        const showQR = remaining > 0; // Ch·ªâ hi·ªán QR khi c√≤n n·ª£ ti·ªÅn

        // Format ng√†y h·∫øt ph√≠
        let feeEndDisplay = '-';
        let feeEndClass = '';
        if (s.fee_end_date) {
          const feeEnd = new Date(s.fee_end_date);
          const today = new Date();
          const diffDays = Math.ceil((feeEnd - today) / (1000 * 60 * 60 * 24));
          feeEndDisplay = feeEnd.toLocaleDateString('vi-VN');
          if (diffDays < 0) feeEndClass = 'text-danger font-weight-bold';
          else if (diffDays <= 30) feeEndClass = 'text-warning font-weight-bold';
        }

        return `<tr>
          <td><div class="student-info"><span class="student-name" onclick="viewDetail(${s.id})">${s.full_name}</span><span class="student-meta">${s.student_code || ''} ‚Ä¢ ${s.birth_year || ''}</span></div></td>
          <td><div>${s.parent_name || '-'}</div><div style="font-size:12px;color:var(--text-secondary)">${s.parent_phone || ''}</div></td>
          <td>${s.class_name || '<span class="text-muted">Ch∆∞a x·∫øp</span>'}</td>
          <td class="text-center"><span class="sessions-badge ${sessionsClass}">${s.sessions_remaining || 0} bu·ªïi</span></td>
          <td class="text-center"><span class="${feeEndClass}">${feeEndDisplay}</span></td>
          <td class="text-center"><span class="status-badge ${s.status}">${status.label}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-info" onclick="viewDetail(${s.id})" title="Xem"><i class="fas fa-eye"></i></button>
            <button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})" title="S·ª≠a"><i class="fas fa-edit"></i></button>
            ${showQR ? `<button class="btn btn-sm btn-success" onclick="showPaymentQR(${s.id})" title="C√≤n n·ª£ ${formatCurrency(remaining)}"><i class="fas fa-qrcode"></i></button>` : ''}
            ${showRenewal && auth.hasRole('CM', 'OM', 'BM', 'HOEC', 'HOCM', 'QLCS', 'CHU', 'GDV', 'ADMIN') ?
            `<button class="btn btn-sm btn-warning" onclick="openRenewalModal(${s.id})" title="T√°i ph√≠" style="background:#f59e0b;border-color:#f59e0b"><i class="fas fa-sync-alt"></i></button>` : ''
          }
          </td>
        </tr>`;
      }).join('');
      document.getElementById('pagination').innerHTML = pagination && pagination.totalPages > 1 ? ui.pagination(pagination, loadData) : '';
    }

    // === Form Functions ===
    function openCreateModal() {
      document.getElementById('formId').value = '';
      document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-graduate"></i> Th√™m h·ªçc vi√™n m·ªõi';
      resetForm();
      populateDropdowns();
      document.getElementById('formModal').classList.add('show');
    }

    async function editStudent(id) {
      try {
        const res = await api.get('/students/' + id);
        const s = res.data;
        document.getElementById('formId').value = s.id;
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i> S·ª≠a: ' + s.full_name;
        document.getElementById('fStudentName').value = s.full_name || '';
        document.getElementById('fBirthYear').value = s.birth_year || '';
        document.getElementById('fGender').value = s.gender || '';
        document.getElementById('fAddress').value = s.address || '';
        document.getElementById('fParentName').value = s.parent_name || '';
        document.getElementById('fParentPhone').value = s.parent_phone || '';
        document.getElementById('fParentEmail').value = s.parent_email || '';
        document.getElementById('fNote').value = s.note || '';
        // Set gift checkbox
        renderGiftCheckboxes(s.gift_id);
        document.getElementById('fScholarshipMonths').value = s.scholarship_months || 0;
        populateDropdowns(s.package_id);
        const paidAmount = s.paid_amount || 0, totalFee = s.tuition_fee || 0;
        if (paidAmount >= totalFee && totalFee > 0) document.getElementById('fPaymentStatus').value = 'paid';
        else if (paidAmount > 0) { document.getElementById('fPaymentStatus').value = 'partial'; document.getElementById('fPaidAmount').value = formatCurrency(paidAmount); }
        else document.getElementById('fPaymentStatus').value = 'pending';
        updatePaymentFields();
        calculateTotals();
        closeDetailModal();
        document.getElementById('formModal').classList.add('show');
      } catch (e) { ui.error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin'); }
    }

    function resetForm() {
      ['fStudentName', 'fBirthYear', 'fAddress', 'fParentName', 'fParentPhone', 'fParentEmail', 'fNote'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('fGender').value = '';
      document.getElementById('fPackage').value = '';
      document.getElementById('fPromoProgram').value = '';
      document.getElementById('fScholarshipMonths').value = '0';
      renderGiftCheckboxes(); // Reset gift checkboxes
      document.getElementById('fPaymentStatus').value = 'pending';
      document.getElementById('fDepositAmount').value = '0ƒë';
      document.getElementById('fPaidAmount').value = '0ƒë';
      document.getElementById('fFeeOriginal').value = '0ƒë';
      document.getElementById('fPromoDiscount').value = '0ƒë';
      document.getElementById('fFeeTotal').textContent = '0ƒë';
      document.getElementById('fMainCourseMonths').textContent = '0 th√°ng';
      document.getElementById('fBonusMonths').textContent = '+0 th√°ng';
      document.getElementById('fDefaultScholarshipBadge').style.display = 'none';
      document.getElementById('fScholarshipWarning').style.display = 'none';
      selectedPackage = null;
      defaultScholarshipMonths = 0;
      updatePaymentFields();
    }

    function populateDropdowns(pkgId = null) {
      const pkgSelect = document.getElementById('fPackage');
      pkgSelect.innerHTML = '<option value="">-- Ch·ªçn g√≥i --</option>' + packages.map(p =>
        `<option value="${p.id}" data-price="${p.base_price || p.price}" data-months="${p.months}" data-scholarship="${p.default_scholarship_months || 0}" ${p.id == pkgId ? 'selected' : ''}>${p.name} - ${formatCurrency(p.base_price || p.price)}</option>`
      ).join('');
      const promoSelect = document.getElementById('fPromoProgram');
      promoSelect.innerHTML = '<option value="">-- Kh√¥ng √°p d·ª•ng --</option>' + promoPrograms.map(p =>
        `<option value="${p.id}" data-type="${p.discount_type}" data-value="${p.discount_value}">${p.name}</option>`
      ).join('');
      if (pkgId) onPackageChange();
    }

    function renderGiftCheckboxes(selectedGiftId = null) {
      const container = document.getElementById('giftCheckboxes');
      if (!availableGifts.length) {
        container.innerHTML = '<span class="text-muted">Kh√¥ng c√≥ qu√† t·∫∑ng</span>';
        return;
      }
      container.innerHTML = availableGifts.map(g => `
        <label class="gift-checkbox ${g.stock_quantity <= 0 ? 'disabled' : ''} ${selectedGiftId == g.id ? 'checked' : ''}" onclick="toggleGift(this, ${g.id}, ${g.stock_quantity})">
          <input type="checkbox" name="gift" value="${g.id}" data-name="${g.name}" ${selectedGiftId == g.id ? 'checked' : ''} ${g.stock_quantity <= 0 ? 'disabled' : ''}>
          üéÅ ${g.name} <span class="gift-qty">(${g.stock_quantity})</span>
        </label>
      `).join('');
    }

    function toggleGift(el, giftId, stockQty) {
      if (stockQty <= 0) return;
      // Ch·ªâ cho ch·ªçn 1 qu√†
      document.querySelectorAll('.gift-checkbox').forEach(cb => {
        cb.classList.remove('checked');
        cb.querySelector('input').checked = false;
      });
      el.classList.add('checked');
      el.querySelector('input').checked = true;
    }

    function getSelectedGift() {
      const checked = document.querySelector('.gift-checkbox.checked input');
      if (!checked) return { gift_id: null, gift_name: null };
      return { gift_id: checked.value, gift_name: checked.dataset.name };
    }

    function onPackageChange() {
      const select = document.getElementById('fPackage');
      const option = select.options[select.selectedIndex];
      if (!option.value) {
        selectedPackage = null; defaultScholarshipMonths = 0;
        document.getElementById('fFeeOriginal').value = '0ƒë';
        document.getElementById('fMainCourseMonths').textContent = '0 th√°ng';
        document.getElementById('fDefaultScholarshipBadge').style.display = 'none';
      } else {
        selectedPackage = { price: parseFloat(option.dataset.price) || 0, months: parseInt(option.dataset.months) || 0 };
        defaultScholarshipMonths = parseInt(option.dataset.scholarship) || 0;
        document.getElementById('fFeeOriginal').value = formatCurrency(selectedPackage.price);
        document.getElementById('fMainCourseMonths').textContent = selectedPackage.months + ' th√°ng';
        if (defaultScholarshipMonths > 0) {
          document.getElementById('fDefaultScholarshipBadge').style.display = 'inline-block';
          document.getElementById('fDefaultScholarshipMonths').textContent = defaultScholarshipMonths;
        } else { document.getElementById('fDefaultScholarshipBadge').style.display = 'none'; }
      }
      calculateTotals();
    }

    function applyPromoProgram() { calculateTotals(); }

    function onScholarshipChange() {
      const months = parseInt(document.getElementById('fScholarshipMonths').value) || 0;
      document.getElementById('fScholarshipWarning').style.display = (months > defaultScholarshipMonths && defaultScholarshipMonths > 0) ? 'block' : 'none';
      document.getElementById('fBonusMonths').textContent = '+' + months + ' th√°ng';
      calculateTotals();
    }

    function calculateTotals() {
      if (!selectedPackage) { document.getElementById('fFeeTotal').textContent = '0ƒë'; return; }
      let originalFee = selectedPackage.price, discount = 0;
      const promoSelect = document.getElementById('fPromoProgram');
      const promoOption = promoSelect.options[promoSelect.selectedIndex];
      if (promoOption && promoOption.value) {
        const type = promoOption.dataset.type, val = parseFloat(promoOption.dataset.value) || 0;
        discount = type === 'percent' ? originalFee * val / 100 : val;
      }
      document.getElementById('fPromoDiscount').value = formatCurrency(discount);
      document.getElementById('fFeeTotal').textContent = formatCurrency(Math.max(0, originalFee - discount));
      updateRemaining();
    }

    function updatePaymentFields() {
      const status = document.getElementById('fPaymentStatus').value;
      document.getElementById('fDepositGroup').style.display = status === 'deposit' ? 'block' : 'none';
      document.getElementById('fPaidGroup').style.display = (status === 'partial' || status === 'paid') ? 'block' : 'none';
      document.getElementById('fRemainingRow').style.display = (status === 'deposit' || status === 'partial') ? 'block' : 'none';
      if (status === 'paid') document.getElementById('fPaidAmount').value = document.getElementById('fFeeTotal').textContent;
      updateRemaining();
    }

    function updateRemaining() {
      const total = parseCurrency(document.getElementById('fFeeTotal').textContent);
      const status = document.getElementById('fPaymentStatus').value;
      let paid = 0;
      if (status === 'deposit') paid = parseCurrency(document.getElementById('fDepositAmount').value);
      else if (status === 'partial' || status === 'paid') paid = parseCurrency(document.getElementById('fPaidAmount').value);
      document.getElementById('fRemaining').textContent = formatCurrency(Math.max(0, total - paid));
    }

    function closeFormModal() {
      document.getElementById('formModal').classList.remove('show');
    }

    // ==================== DOCUMENTS MODAL ====================
    let currentDocStudentId = null;

    async function openDocumentsModal(studentId) {
      currentDocStudentId = studentId;
      document.getElementById('docStudentId').value = studentId;

      // Load student info
      try {
        const res = await api.get('/students/' + studentId);
        const s = res.data;
        document.getElementById('docStudentInfo').innerHTML = `
          <div style="width:50px;height:50px;border-radius:50%;background:#7c3aed;color:white;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold">${(s.full_name || '?')[0].toUpperCase()}</div>
          <div>
            <div style="font-weight:600;font-size:16px">${s.full_name}</div>
            <div style="color:#6b7280;font-size:13px">${s.student_code} ‚Ä¢ H·ªçc ph√≠: ${formatCurrency(s.fee_total || s.tuition_fee || 0)}</div>
          </div>
        `;
      } catch (e) { }

      // Load documents
      await loadDocumentsList(studentId);

      document.getElementById('documentsModal').classList.add('show');
    }

    function closeDocumentsModal() {
      document.getElementById('documentsModal').classList.remove('show');
      currentDocStudentId = null;
    }

    async function loadDocumentsList(studentId) {
      const container = document.getElementById('documentsListContainer');
      container.innerHTML = '<div style="text-align:center;color:#9ca3af;padding:20px"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</div>';

      try {
        const res = await api.get('/students/' + studentId + '/documents');
        const docs = res.data || [];

        if (docs.length === 0) {
          container.innerHTML = `
            <div style="text-align:center;padding:30px;color:#9ca3af">
              <i class="fas fa-folder-open" style="font-size:40px;margin-bottom:12px;opacity:0.5"></i>
              <div>Ch∆∞a c√≥ gi·∫•y t·ªù n√†o</div>
            </div>
          `;
        } else {
          container.innerHTML = docs.map(d => `
            <div style="display:flex;align-items:center;gap:12px;padding:12px;background:#f9fafb;border-radius:10px;margin-bottom:10px;border:1px solid #e5e7eb">
              <div style="width:45px;height:45px;border-radius:8px;background:${d.file_type?.includes('pdf') ? '#fef2f2' : '#eff6ff'};display:flex;align-items:center;justify-content:center">
                <i class="fas ${d.file_type?.includes('pdf') ? 'fa-file-pdf' : 'fa-file-image'}" style="font-size:20px;color:${d.file_type?.includes('pdf') ? '#dc2626' : '#3b82f6'}"></i>
              </div>
              <div style="flex:1;min-width:0">
                <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#374151">${d.file_name}</div>
                <div style="font-size:12px;color:#6b7280;margin-top:2px">
                  <span style="background:#ede9fe;color:#7c3aed;padding:2px 8px;border-radius:10px;font-weight:500">${d.doc_type_display || getDocTypeLabel(d.doc_type)}</span>
                  <span style="margin-left:8px">${new Date(d.created_at).toLocaleDateString('vi-VN')}</span>
                  ${d.uploaded_by_name ? '<span style="margin-left:8px">‚Ä¢ ' + d.uploaded_by_name + '</span>' : ''}
                </div>
              </div>
              <a href="${d.file_url}" target="_blank" class="btn" style="padding:8px 12px;background:#3b82f6;color:white;border-radius:6px;text-decoration:none" title="Xem file">
                <i class="fas fa-eye"></i>
              </a>
              ${auth.hasRole('ACCOUNTANT', 'ADMIN', 'GDV', 'QLCS', 'CHU') ? `
              <button onclick="deleteDocument(${d.id})" class="btn" style="padding:8px 12px;background:#fee2e2;color:#dc2626;border:none;border-radius:6px;cursor:pointer" title="X√≥a">
                <i class="fas fa-trash"></i>
              </button>` : ''}
            </div>
          `).join('');
        }
      } catch (e) {
        container.innerHTML = '<div style="text-align:center;color:#dc2626;padding:20px"><i class="fas fa-exclamation-triangle"></i> L·ªói t·∫£i d·ªØ li·ªáu</div>';
      }
    }

    function getDocTypeLabel(type) {
      const labels = { 'receipt': 'Phi·∫øu thu', 'registration_form': 'ƒê∆°n ƒëƒÉng k√Ω', 'contract': 'H·ª£p ƒë·ªìng', 'other': 'Kh√°c' };
      return labels[type] || type;
    }

    async function uploadDocumentFile(file) {
      if (!file || !currentDocStudentId) return;

      // Validate
      const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
      if (!allowedTypes.includes(file.type)) {
        ui.error('Ch·ªâ h·ªó tr·ª£ file PDF, JPG, PNG');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        ui.error('File kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
        return;
      }

      // Ask for document type
      const docTypeChoice = prompt(
        'Ch·ªçn lo·∫°i gi·∫•y t·ªù cho file: ' + file.name + '\n\n' +
        '1. Phi·∫øu thu\n' +
        '2. ƒê∆°n ƒëƒÉng k√Ω h·ªçc\n' +
        '3. H·ª£p ƒë·ªìng\n' +
        '4. Kh√°c\n\n' +
        'Nh·∫≠p s·ªë (1-4):',
        '1'
      );

      if (!docTypeChoice) {
        document.getElementById('docUploadInput').value = '';
        return;
      }

      const docTypes = { '1': 'receipt', '2': 'registration_form', '3': 'contract', '4': 'other' };
      const docType = docTypes[docTypeChoice] || 'other';

      const formData = new FormData();
      formData.append('file', file);
      formData.append('doc_type', docType);

      try {
        await api.upload('/students/' + currentDocStudentId + '/documents', formData);
        ui.success('T·∫£i l√™n th√†nh c√¥ng!');
        loadDocumentsList(currentDocStudentId);
      } catch (e) {
        ui.error('L·ªói t·∫£i l√™n: ' + (e.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
      } finally {
        document.getElementById('docUploadInput').value = '';
      }
    }

    async function deleteDocument(docId) {
      if (!confirm('X√≥a gi·∫•y t·ªù n√†y?')) return;
      try {
        await api.delete('/students/documents/' + docId);
        ui.success('ƒê√£ x√≥a');
        loadDocumentsList(currentDocStudentId);
      } catch (e) {
        ui.error('L·ªói x√≥a: ' + (e.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
      }
    }

    async function saveStudent() {
      const id = document.getElementById('formId').value;
      const studentName = document.getElementById('fStudentName').value.trim();
      const parentName = document.getElementById('fParentName').value.trim();
      const parentPhone = document.getElementById('fParentPhone').value.trim();
      if (!studentName || !parentName || !parentPhone) { ui.warning('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc'); return; }
      const paymentStatus = document.getElementById('fPaymentStatus').value;
      let paidAmount = 0;
      if (paymentStatus === 'deposit') paidAmount = parseCurrency(document.getElementById('fDepositAmount').value);
      else if (paymentStatus === 'partial' || paymentStatus === 'paid') paidAmount = parseCurrency(document.getElementById('fPaidAmount').value);
      const data = {
        full_name: studentName, birth_year: document.getElementById('fBirthYear').value || null,
        gender: document.getElementById('fGender').value || null, address: document.getElementById('fAddress').value || null,
        parent_name: parentName, parent_phone: parentPhone, parent_email: document.getElementById('fParentEmail').value || null,
        note: document.getElementById('fNote').value || null, package_id: document.getElementById('fPackage').value || null,
        tuition_fee: parseCurrency(document.getElementById('fFeeTotal').textContent),
        discount_amount: parseCurrency(document.getElementById('fPromoDiscount').value),
        scholarship_months: parseInt(document.getElementById('fScholarshipMonths').value) || 0,
        gift_id: getSelectedGift().gift_id, gift_name: getSelectedGift().gift_name, paid_amount: paidAmount, payment_status: paymentStatus
      };
      try {
        let studentId = id;
        const selectedGift = getSelectedGift();

        if (id) {
          await api.put('/students/' + id, data);
          ui.success('C·∫≠p nh·∫≠t th√†nh c√¥ng');
        } else {
          const res = await api.post('/students', data);
          studentId = res.data?.id;
          ui.success('Th√™m h·ªçc vi√™n th√†nh c√¥ng');
        }

        // N·∫øu c√≥ ch·ªçn qu√† t·∫∑ng v√† l√† t·∫°o m·ªõi ‚Üí tr·ª´ stock
        if (selectedGift.gift_id && studentId && !id) {
          try {
            await api.post('/promotions/items/' + selectedGift.gift_id + '/give', {
              student_id: studentId,
              note: 'T·∫∑ng cho h·ªçc vi√™n ' + data.full_name
            });
          } catch (giftErr) {
            ui.warning('L∆∞u h·ªçc vi√™n OK nh∆∞ng tr·ª´ qu√† th·∫•t b·∫°i: ' + giftErr.message);
          }
        }

        closeFormModal(); loadData(); loadStats(); loadOptions(); // Reload gifts
      } catch (e) { ui.error(e.message || 'C√≥ l·ªói x·∫£y ra'); }
    }

    // === Detail & QR ===
    async function viewDetail(id) {
      try {
        const res = await api.get('/students/' + id);
        const s = res.data;
        currentDetailId = id;
        const status = statusConfig[s.status] || { label: s.status };
        document.getElementById('detailContent').innerHTML = `
          <div style="display:flex;gap:16px;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)">
            <div style="width:60px;height:60px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold">${(s.full_name || '?')[0].toUpperCase()}</div>
            <div style="flex:1"><h3 style="margin:0">${s.full_name}</h3><div style="color:var(--text-secondary)">${s.student_code || ''}</div></div>
            <span class="status-badge ${s.status}">${status.label}</span>
          </div>
          <div class="detail-section"><h4><i class="fas fa-child"></i> Th√¥ng tin h·ªçc sinh</h4>
            <div class="detail-row"><span class="detail-label">NƒÉm sinh</span><span class="detail-value">${s.birth_year || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Gi·ªõi t√≠nh</span><span class="detail-value">${s.gender === 'male' ? 'Nam' : s.gender === 'female' ? 'N·ªØ' : '-'}</span></div>
            <div class="detail-row"><span class="detail-label">ƒê·ªãa ch·ªâ</span><span class="detail-value">${s.address || '-'}</span></div>
          </div>
          <div class="detail-section"><h4><i class="fas fa-users"></i> Th√¥ng tin ph·ª• huynh</h4>
            <div class="detail-row"><span class="detail-label">H·ªç t√™n</span><span class="detail-value">${s.parent_name || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">SƒêT</span><span class="detail-value">${s.parent_phone || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value">${s.parent_email || '-'}</span></div>
          </div>
          <div class="detail-section"><h4><i class="fas fa-book"></i> Th√¥ng tin h·ªçc t·∫≠p</h4>
            <div class="detail-row"><span class="detail-label">L·ªõp</span><span class="detail-value">${s.class_name || 'Ch∆∞a x·∫øp l·ªõp'}</span></div>
            <div class="detail-row"><span class="detail-label">G√≥i h·ªçc</span><span class="detail-value">${s.package_name || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">H·ªçc b·ªïng</span><span class="detail-value" style="color:#16a34a">${s.scholarship_months ? s.scholarship_months + ' th√°ng' : '-'}</span></div>
            <div class="detail-row"><span class="detail-label">T·ªïng kh√≥a h·ªçc</span><span class="detail-value">${s.package_months && s.scholarship_months ? (s.package_months + s.scholarship_months) + ' th√°ng' : (s.package_months ? s.package_months + ' th√°ng' : '-')}</span></div>
            <div class="detail-row"><span class="detail-label">T·ªïng bu·ªïi</span><span class="detail-value">${s.total_sessions || 0} bu·ªïi</span></div>
            <div class="detail-row"><span class="detail-label">Bu·ªïi c√≤n l·∫°i</span><span class="detail-value"><strong>${s.remaining_sessions || 0}</strong> bu·ªïi</span></div>
          </div>
          <div class="detail-section"><h4><i class="fas fa-credit-card"></i> Thanh to√°n</h4>
            <div class="detail-row"><span class="detail-label">H·ªçc ph√≠</span><span class="detail-value">${formatCurrency(s.tuition_fee)}</span></div>
            <div class="detail-row"><span class="detail-label">ƒê√£ ƒë√≥ng</span><span class="detail-value" style="color:#16a34a;font-weight:600">${formatCurrency(s.paid_amount)}</span></div>
            <div class="detail-row"><span class="detail-label">C√≤n l·∫°i</span><span class="detail-value" style="color:#dc2626;font-weight:600">${formatCurrency(Math.max(0, (s.tuition_fee || 0) - (s.paid_amount || 0)))}</span></div>
          </div>
          <div class="detail-section"><h4><i class="fas fa-file-alt"></i> T√†i li·ªáu</h4>
            <div id="studentDocuments" style="margin-bottom:12px">ƒêang t·∫£i...</div>
            ${auth.hasRole('ACCOUNTANT', 'EC', 'HOEC', 'CM', 'OM', 'QLCS', 'CHU', 'GDV', 'ADMIN') ? `
            <div class="upload-zone" style="border:2px dashed #d1d5db;border-radius:8px;padding:16px;text-align:center;cursor:pointer" onclick="document.getElementById('docFileInput').click()">
              <i class="fas fa-cloud-upload-alt" style="font-size:24px;color:#9ca3af;margin-bottom:8px"></i>
              <div style="color:#6b7280;font-size:14px">T·∫£i l√™n phi·∫øu thu, ƒë∆°n ƒëƒÉng k√Ω...</div>
              <input type="file" id="docFileInput" style="display:none" accept=".pdf,.jpg,.jpeg,.png" onchange="uploadStudentDoc(this.files[0])">
            </div>` : ''}
          </div>`;
        loadStudentDocuments(s.id);
        document.getElementById('detailModal').classList.add('show');
      } catch (e) { ui.error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin'); }
    }

    function closeDetailModal() { document.getElementById('detailModal').classList.remove('show'); }

    // Load student documents
    async function loadStudentDocuments(studentId) {
      const container = document.getElementById('studentDocuments');
      if (!container) return;
      try {
        const res = await api.get('/students/' + studentId + '/documents');
        const docs = res.data || [];
        if (docs.length === 0) {
          container.innerHTML = '<div style="color:#9ca3af;font-size:14px">Ch∆∞a c√≥ t√†i li·ªáu</div>';
        } else {
          container.innerHTML = docs.map(d => `
            <div style="display:flex;align-items:center;gap:8px;padding:8px;background:#f9fafb;border-radius:6px;margin-bottom:8px">
              <i class="fas ${d.file_type === 'pdf' ? 'fa-file-pdf text-danger' : 'fa-file-image text-primary'}"></i>
              <div style="flex:1;min-width:0">
                <div style="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${d.file_name}</div>
                <div style="font-size:12px;color:#6b7280">${d.doc_type_display || d.doc_type} ‚Ä¢ ${new Date(d.created_at).toLocaleDateString('vi-VN')}</div>
              </div>
              <a href="${d.file_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i></a>
              ${auth.hasRole('ACCOUNTANT', 'ADMIN', 'GDV') ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteStudentDoc(${d.id})"><i class="fas fa-trash"></i></button>` : ''}
            </div>
          `).join('');
        }
      } catch (e) {
        container.innerHTML = '<div style="color:#dc2626;font-size:14px">L·ªói t·∫£i t√†i li·ªáu</div>';
      }
    }

    // Upload student document
    async function uploadStudentDoc(file) {
      if (!file || !currentDetailId) return;
      const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
      if (!allowedTypes.includes(file.type)) {
        ui.error('Ch·ªâ h·ªó tr·ª£ file PDF, JPG, PNG');
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        ui.error('File kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
        return;
      }

      // H·ªèi lo·∫°i t√†i li·ªáu
      const docType = prompt('Lo·∫°i t√†i li·ªáu:\n1. Phi·∫øu thu\n2. ƒê∆°n ƒëƒÉng k√Ω h·ªçc\n3. H·ª£p ƒë·ªìng\n4. Kh√°c\n\nNh·∫≠p s·ªë (1-4):', '1');
      const docTypes = { '1': 'receipt', '2': 'registration_form', '3': 'contract', '4': 'other' };
      const selectedType = docTypes[docType] || 'other';

      const formData = new FormData();
      formData.append('file', file);
      formData.append('doc_type', selectedType);

      try {
        await api.upload('/students/' + currentDetailId + '/documents', formData);
        ui.success('T·∫£i l√™n th√†nh c√¥ng');
        loadStudentDocuments(currentDetailId);
      } catch (e) {
        ui.error('L·ªói t·∫£i l√™n: ' + (e.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
      } finally {
        document.getElementById('docFileInput').value = '';
      }
    }

    // Delete student document
    async function deleteStudentDoc(docId) {
      if (!confirm('X√≥a t√†i li·ªáu n√†y?')) return;
      try {
        await api.delete('/students/documents/' + docId);
        ui.success('ƒê√£ x√≥a');
        loadStudentDocuments(currentDetailId);
      } catch (e) {
        ui.error('L·ªói x√≥a: ' + (e.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
      }
    }

    async function showPaymentQR(id) {
      try {
        const res = await api.get('/students/' + id);
        const s = res.data;
        const tuitionFee = s.tuition_fee || 0;
        const paidAmount = s.paid_amount || 0;
        const remaining = Math.max(0, tuitionFee - paidAmount);

        // N·∫øu payment_status = paid nh∆∞ng ch∆∞a th·ª±c s·ª± nh·∫≠n ti·ªÅn (paid_amount < tuition_fee)
        // th√¨ hi·ªán QR v·ªõi s·ªë ti·ªÅn = h·ªçc ph√≠
        const qrAmount = remaining > 0 ? remaining : tuitionFee;
        const qrLabel = remaining > 0 ? 'C√≤n ph·∫£i ƒë√≥ng' : 'H·ªçc ph√≠ ƒë√£ x√°c nh·∫≠n';

        document.getElementById('qrStudentId').value = id;
        document.getElementById('qrRemainingRaw').value = qrAmount;
        document.getElementById('qrStudentInfo').innerHTML = `<h3 style="margin:0">${s.full_name}</h3><div style="color:var(--text-secondary)">${s.student_code}</div>`;
        const qrUrl = `https://img.vietqr.io/image/970422-0866766189-compact2.png?amount=${qrAmount}&addInfo=${encodeURIComponent('HP ' + s.student_code)}`;
        document.getElementById('qrImage').src = qrUrl;
        document.getElementById('qrPaidAmount').textContent = formatCurrency(paidAmount);
        document.getElementById('qrRemainingAmount').textContent = formatCurrency(qrAmount);
        closeDetailModal();
        document.getElementById('qrModal').classList.add('show');
      } catch (e) { ui.error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin'); }
    }

    function closeQRModal() { document.getElementById('qrModal').classList.remove('show'); }

    async function confirmPaymentFromQR() {
      const studentId = document.getElementById('qrStudentId').value;
      const remaining = parseFloat(document.getElementById('qrRemainingRaw').value) || 0;
      if (remaining <= 0) { ui.info('H·ªçc vi√™n ƒë√£ thanh to√°n ƒë·ªß'); return; }
      if (!confirm(`X√°c nh·∫≠n ƒë√£ nh·∫≠n ${formatCurrency(remaining)} t·ª´ ph·ª• huynh?`)) return;
      try {
        await api.post('/students/' + studentId + '/confirm-payment', { amount: remaining, paymentMethod: 'bank_transfer', note: 'Thanh to√°n qua QR' });
        ui.success('X√°c nh·∫≠n thanh to√°n th√†nh c√¥ng');
        closeQRModal(); loadData(); loadStats();
      } catch (e) { ui.error(e.message || 'L·ªói x√°c nh·∫≠n thanh to√°n'); }
    }

    async function downloadEnrollmentForm() {
      const studentId = document.getElementById('qrStudentId').value || currentDetailId;
      if (!studentId) return;
      window.open(`${API_URL}/enrollment/${studentId}/form?token=${auth.getToken()}`, '_blank');
    }

    // === Helpers ===
    function formatCurrency(val) { return val ? new Intl.NumberFormat('vi-VN').format(val) + 'ƒë' : '0ƒë'; }
    function parseCurrency(str) { return parseInt(String(str).replace(/[^\d]/g, '')) || 0; }
    function formatCurrencyField(input) { const val = parseCurrency(input.value); if (val > 0) input.value = formatCurrency(val); }

    // === Renewal Functions ===
    let currentRenewalStudent = null;
    let renewalDefaultScholarship = 0;

    async function openRenewalModal(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) {
        try {
          const res = await api.get('/students/' + studentId);
          currentRenewalStudent = res.data;
        } catch (e) { ui.error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin'); return; }
      } else {
        currentRenewalStudent = student;
      }

      // Fill student info
      document.getElementById('renewalStudentInfo').innerHTML = `
        <div class="form-row">
          <div class="form-group"><label>H·ªç t√™n</label><div style="font-weight:600;font-size:16px">${currentRenewalStudent.full_name}</div></div>
          <div class="form-group"><label>M√£ HV</label><div>${currentRenewalStudent.student_code || '-'}</div></div>
          <div class="form-group"><label>L·ªõp hi·ªán t·∫°i</label><div>${currentRenewalStudent.class_name || 'Ch∆∞a x·∫øp l·ªõp'}</div></div>
          <div class="form-group"><label>Bu·ªïi c√≤n</label><div><span class="sessions-badge ${(currentRenewalStudent.sessions_remaining || 0) <= 4 ? 'low' : 'normal'}">${currentRenewalStudent.sessions_remaining || 0} bu·ªïi</span></div></div>
        </div>
      `;

      // Load packages for renewal
      const pkgSelect = document.getElementById('renewalPackage');
      pkgSelect.innerHTML = '<option value="">-- Ch·ªçn g√≥i --</option>' + packages.map(p => {
        const months = p.months || 0;
        const sessions = p.sessions_count || p.sessions || 0;
        return `<option value="${p.id}" data-price="${p.price}" data-months="${months}" data-sessions="${sessions}" data-scholarship="${p.default_scholarship_months || 0}">${p.name} - ${formatCurrency(p.price)}</option>`;
      }).join('');

      // Load promotion programs
      const promoSelect = document.getElementById('renewalPromotion');
      promoSelect.innerHTML = '<option value="">-- Kh√¥ng √°p d·ª•ng --</option>';
      try {
        const promoRes = await api.get('/promotions/programs?is_active=1');
        (promoRes.data || []).forEach(p => {
          const desc = p.discount_type === 'percent' ? `${p.discount_value}%` : formatCurrency(p.discount_value);
          promoSelect.innerHTML += `<option value="${p.id}" data-type="${p.discount_type}" data-value="${p.discount_value}">${p.name} (-${desc})</option>`;
        });
      } catch (e) { }

      // Load classes for "new course" option
      const classSelect = document.getElementById('renewalNewClass');
      classSelect.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';
      try {
        const branchQuery = branch.buildQuery({});
        const classRes = await api.get('/classes?status=active' + branchQuery.replace('?', '&'));
        (classRes.data || []).forEach(c => {
          classSelect.innerHTML += `<option value="${c.id}">${c.class_name || c.name} (${c.student_count || 0}/${c.max_students || 15})</option>`;
        });
      } catch (e) { }

      // Reset form
      document.getElementById('renewalType').value = 'extend';
      document.getElementById('renewalScholarship').value = '0';
      document.getElementById('renewalPaymentStatus').value = 'pending';
      document.getElementById('renewalDeposit').value = '0ƒë';
      document.getElementById('renewalPaidAmount').value = '0ƒë';
      document.getElementById('renewalNote').value = '';
      document.getElementById('newClassGroup').style.display = 'none';
      renewalDefaultScholarship = 0;
      updateRenewalPaymentFields();
      calculateRenewalFee();

      document.getElementById('renewalModal').classList.add('show');
    }

    function closeRenewalModal() {
      document.getElementById('renewalModal').classList.remove('show');
      currentRenewalStudent = null;
    }

    function toggleNewClassSelect() {
      const type = document.getElementById('renewalType').value;
      document.getElementById('newClassGroup').style.display = type === 'new' ? 'block' : 'none';
    }

    function onRenewalPackageChange() {
      const pkgSelect = document.getElementById('renewalPackage');
      const option = pkgSelect.options[pkgSelect.selectedIndex];
      const price = parseFloat(option?.dataset?.price) || 0;
      const months = parseInt(option?.dataset?.months) || 0;
      renewalDefaultScholarship = parseInt(option?.dataset?.scholarship) || 0;

      document.getElementById('renewalFeeOriginal').value = formatCurrency(price);
      document.getElementById('renewalScholarship').value = renewalDefaultScholarship;

      if (renewalDefaultScholarship > 0) {
        document.getElementById('renewalDefaultScholarshipBadge').style.display = 'inline';
        document.getElementById('renewalDefaultScholarshipMonths').textContent = renewalDefaultScholarship;
      } else {
        document.getElementById('renewalDefaultScholarshipBadge').style.display = 'none';
      }

      calculateRenewalFee();
    }

    function updateRenewalPaymentFields() {
      const status = document.getElementById('renewalPaymentStatus').value;
      document.getElementById('renewalDepositGroup').style.display = status === 'deposit' ? 'block' : 'none';
      document.getElementById('renewalPaidGroup').style.display = ['partial', 'paid'].includes(status) ? 'block' : 'none';
      document.getElementById('renewalRemainingRow').style.display = status !== 'pending' ? 'block' : 'none';
      calculateRenewalFee();
    }

    function formatRenewalCurrency(input) {
      let val = input.value.replace(/[^\d]/g, '');
      if (val) input.value = parseInt(val).toLocaleString('vi-VN') + 'ƒë';
      else input.value = '0ƒë';
    }

    function calculateRenewalFee() {
      const pkgSelect = document.getElementById('renewalPackage');
      const option = pkgSelect.options[pkgSelect.selectedIndex];
      const originalPrice = parseFloat(option?.dataset?.price) || 0;
      const pkgMonths = parseInt(option?.dataset?.months) || 0;

      // Promotion discount
      const promoSelect = document.getElementById('renewalPromotion');
      const promoOption = promoSelect.options[promoSelect.selectedIndex];
      let promoDiscount = 0;
      if (promoOption?.value) {
        const discType = promoOption.dataset.type;
        const discValue = parseFloat(promoOption.dataset.value) || 0;
        promoDiscount = discType === 'percent' ? Math.round(originalPrice * discValue / 100) : discValue;
      }

      // H·ªçc b·ªïng = th√™m th√°ng mi·ªÖn ph√≠, KH√îNG tr·ª´ ti·ªÅn
      const scholarshipMonths = parseInt(document.getElementById('renewalScholarship').value) || 0;
      const totalMonths = pkgMonths + scholarshipMonths;

      const finalPrice = Math.max(0, originalPrice - promoDiscount);

      // Payment
      const status = document.getElementById('renewalPaymentStatus').value;
      let paidAmount = 0;
      if (status === 'deposit') {
        paidAmount = parseInt(document.getElementById('renewalDeposit').value.replace(/[^\d]/g, '')) || 0;
      } else if (status === 'partial') {
        paidAmount = parseInt(document.getElementById('renewalPaidAmount').value.replace(/[^\d]/g, '')) || 0;
      } else if (status === 'paid') {
        paidAmount = finalPrice;
        document.getElementById('renewalPaidAmount').value = formatCurrency(finalPrice);
      }
      const remaining = Math.max(0, finalPrice - paidAmount);

      document.getElementById('renewalPromoDiscount').value = formatCurrency(promoDiscount);
      document.getElementById('renewalMainMonths').textContent = pkgMonths + ' th√°ng';
      document.getElementById('renewalBonusMonths').textContent = '+' + scholarshipMonths + ' th√°ng';
      document.getElementById('renewalFeeTotal').textContent = formatCurrency(finalPrice);
      document.getElementById('renewalRemaining').textContent = formatCurrency(remaining);
    }

    function getRenewalQRUrl(amount, description) {
      // TODO: Get bank info from branch settings
      const bankId = 'MB';
      const accountNo = '0389718154';
      const template = 'compact2';
      return `https://img.vietqr.io/image/${bankId}-${accountNo}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(description)}`;
    }

    async function submitRenewal() {
      if (!currentRenewalStudent) return;

      const pkgSelect = document.getElementById('renewalPackage');
      if (!pkgSelect.value) { ui.error('Vui l√≤ng ch·ªçn g√≥i h·ªçc'); return; }

      const renewalType = document.getElementById('renewalType').value;
      if (renewalType === 'new' && !document.getElementById('renewalNewClass').value) {
        ui.error('Vui l√≤ng ch·ªçn l·ªõp m·ªõi');
        return;
      }

      const paymentStatus = document.getElementById('renewalPaymentStatus').value;
      const depositAmount = parseInt(document.getElementById('renewalDeposit').value.replace(/[^\d]/g, '')) || 0;
      const paidAmount = parseInt(document.getElementById('renewalPaidAmount').value.replace(/[^\d]/g, '')) || 0;

      const pkgOption = pkgSelect.options[pkgSelect.selectedIndex];
      const originalPrice = parseFloat(pkgOption?.dataset?.price) || 0;
      const promoSelect = document.getElementById('renewalPromotion');
      const promoOption = promoSelect.options[promoSelect.selectedIndex];
      let promoDiscount = 0;
      if (promoOption?.value) {
        const discType = promoOption.dataset.type;
        const discValue = parseFloat(promoOption.dataset.value) || 0;
        promoDiscount = discType === 'percent' ? Math.round(originalPrice * discValue / 100) : discValue;
      }
      const finalPrice = Math.max(0, originalPrice - promoDiscount);
      const actualPaid = paymentStatus === 'deposit' ? depositAmount : (paymentStatus === 'paid' ? finalPrice : paidAmount);
      const remaining = Math.max(0, finalPrice - actualPaid);

      const data = {
        student_id: currentRenewalStudent.id,
        package_id: parseInt(pkgSelect.value),
        renewal_type: renewalType,
        new_class_id: renewalType === 'new' ? parseInt(document.getElementById('renewalNewClass').value) : null,
        promotion_id: document.getElementById('renewalPromotion').value || null,
        scholarship_months: parseInt(document.getElementById('renewalScholarship').value) || 0,
        deposit_amount: depositAmount,
        paid_amount: actualPaid,
        payment_status: paymentStatus,
        note: document.getElementById('renewalNote').value
      };

      try {
        // L∆∞u th√¥ng tin student tr∆∞·ªõc khi close modal
        const studentName = currentRenewalStudent.full_name;
        const studentCode = currentRenewalStudent.student_code || '---';
        const studentId = currentRenewalStudent.id;

        await api.post('/renewals', data);

        // Close modal (this sets currentRenewalStudent to null)
        document.getElementById('renewalModal').classList.remove('show');

        // T√≠nh s·ªë ti·ªÅn c·∫ßn thu
        const qrAmount = paymentStatus === 'paid' ? finalPrice : (remaining > 0 ? remaining : finalPrice);
        const qrLabel = paymentStatus === 'paid' ? 'H·ªçc ph√≠ c·∫ßn chuy·ªÉn' : 'C√≤n ph·∫£i ƒë√≥ng';

        // L∆∞u ƒë·ªÉ x√°c nh·∫≠n thanh to√°n sau
        lastRenewalStudentId = studentId;
        lastRenewalAmount = qrAmount;

        // Show success modal with QR
        document.getElementById('renewalSuccessName').textContent = studentName;
        document.getElementById('renewalSuccessCode').textContent = 'M√£: ' + studentCode;
        document.getElementById('renewalQRSection').style.display = 'block';
        document.getElementById('renewalFullPaidSection').style.display = 'none';
        document.getElementById('renewalSuccessRemaining').textContent = formatCurrency(qrAmount);
        document.getElementById('renewalQRLabel').textContent = qrLabel;
        const desc = studentCode + ' ' + studentName.substring(0, 15) + ' Tai phi';
        document.getElementById('renewalQRImage').src = getRenewalQRUrl(qrAmount, desc);

        document.getElementById('renewalSuccessModal').classList.add('show');
        currentRenewalStudent = null;
        loadData();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    function closeRenewalSuccessModal() {
      document.getElementById('renewalSuccessModal').classList.remove('show');
    }

    let lastRenewalStudentId = null;
    let lastRenewalAmount = 0;

    async function confirmRenewalPayment() {
      if (!lastRenewalStudentId || lastRenewalAmount <= 0) {
        ui.error('Kh√¥ng c√≥ th√¥ng tin thanh to√°n');
        return;
      }

      if (!confirm(`X√°c nh·∫≠n ƒë√£ nh·∫≠n ${formatCurrency(lastRenewalAmount)} t·ª´ ph·ª• huynh?`)) return;

      try {
        await api.post('/students/' + lastRenewalStudentId + '/confirm-payment', {
          amount: lastRenewalAmount,
          paymentMethod: 'bank_transfer',
          note: 'Thanh to√°n t√°i ph√≠ qua QR'
        });
        ui.success('ƒê√£ x√°c nh·∫≠n thanh to√°n th√†nh c√¥ng!');
        closeRenewalSuccessModal();
        lastRenewalStudentId = null;
        lastRenewalAmount = 0;
        loadData();
        loadStats();
      } catch (e) {
        ui.error(e.message || 'L·ªói x√°c nh·∫≠n thanh to√°n');
      }
    }

    init();
  </script>
</body>

</html>