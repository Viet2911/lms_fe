<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Học viên - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card.active {
      border-color: var(--primary);
      background: rgba(52, 168, 83, 0.08);
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .stat-icon.primary {
      background: #dbeafe;
      color: #2563eb;
    }

    .stat-icon.success {
      background: #dcfce7;
      color: #16a34a;
    }

    .stat-icon.warning {
      background: #fef3c7;
      color: #d97706;
    }

    .stat-icon.info {
      background: #e0e7ff;
      color: #4f46e5;
    }

    .stat-icon.danger {
      background: #fee2e2;
      color: #dc2626;
    }

    .stat-icon.gray {
      background: #f3f4f6;
      color: #6b7280;
    }

    .stat-icon.purple {
      background: #f3e8ff;
      color: #9333ea;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.active {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.paused {
      background: #e0e7ff;
      color: #4338ca;
    }

    .status-badge.waiting {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge.expired {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-badge.quit_paid {
      background: #fecaca;
      color: #dc2626;
    }

    .status-badge.quit_refund {
      background: #fed7aa;
      color: #c2410c;
    }

    .status-badge.reserved {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .student-info {
      display: flex;
      flex-direction: column;
    }

    .student-name {
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
    }

    .student-name:hover {
      color: var(--primary);
      text-decoration: underline;
    }

    .student-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .sessions-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .sessions-badge.low {
      background: #fee2e2;
      color: #dc2626;
    }

    .sessions-badge.normal {
      background: #dcfce7;
      color: #166534;
    }

    .detail-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .detail-section h4 {
      margin: 0 0 12px;
      color: var(--primary);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-row {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 120px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .detail-value {
      flex: 1;
      font-size: 13px;
      color: var(--text-primary);
    }

    .form-section {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .form-section h4 {
      margin: 0 0 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-section.blue {
      background: linear-gradient(135deg, #dbeafe, #e0e7ff);
    }

    .form-section.blue h4 {
      color: #1e40af;
    }

    .form-section.yellow {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
    }

    .form-section.yellow h4 {
      color: #92400e;
    }

    .form-section.green {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    }

    .form-section.green h4 {
      color: #166534;
    }

    .form-section.pink {
      background: linear-gradient(135deg, #fce7f3, #fbcfe8);
    }

    .form-section.pink h4 {
      color: #9d174d;
    }

    .summary-box {
      background: #1f2937;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .summary-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid #374151;
    }
  </style>
</head>

<body>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')"><i
            class="fas fa-bars"></i></button>
        <h1><i class="fas fa-user-graduate"></i> Học viên</h1>
      </div>
      <div class="topbar-right">
        <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-sync"></i></button>
        <button class="btn btn-primary" onclick="openCreateModal()" id="btnCreate"><i class="fas fa-plus"></i> Thêm học
          viên</button>
      </div>
    </div>
    <div class="stats-grid" id="statsGrid"></div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-body" style="padding:16px">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <div class="search-box" style="flex:1;min-width:250px">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Tìm tên, SĐT, mã học viên..."
              onkeyup="if(event.key==='Enter')loadData()">
          </div>
          <select id="classFilter" class="form-control" style="width:180px" onchange="loadData()">
            <option value="">Tất cả lớp</option>
          </select>
          <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-search"></i> Tìm</button>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>Học viên</th>
              <th>Phụ huynh</th>
              <th>Lớp</th>
              <th class="text-center">Buổi còn</th>
              <th class="text-center">Trạng thái</th>
              <th class="text-center">Thao tác</th>
            </tr>
          </thead>
          <tbody id="dataTable">
            <tr>
              <td colspan="6" class="text-center">Đang tải...</td>
            </tr>
          </tbody>
        </table>
        <div id="pagination" class="pagination"></div>
      </div>
    </div>
  </main>

  <!-- Form Modal -->
  <div class="modal" id="formModal">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-header">
        <div class="modal-title" id="formTitle"><i class="fas fa-user-graduate"></i> Thêm học viên mới</div>
        <button class="modal-close" onclick="closeFormModal()">&times;</button>
      </div>
      <div class="modal-body" style="max-height:80vh;overflow-y:auto">
        <input type="hidden" id="formId">
        <!-- Thông tin học sinh -->
        <div class="form-section blue">
          <h4><i class="fas fa-child"></i> Thông tin Học sinh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label class="required">Họ tên học sinh</label><input type="text"
                id="fStudentName" class="form-control"></div>
            <div class="form-group"><label>Năm sinh</label><input type="number" id="fBirthYear" class="form-control"
                placeholder="2015"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Giới tính</label>
              <select id="fGender" class="form-control">
                <option value="">Chọn</option>
                <option value="male">Nam</option>
                <option value="female">Nữ</option>
              </select>
            </div>
            <div class="form-group" style="flex:2"><label>Địa chỉ</label><input type="text" id="fAddress"
                class="form-control"></div>
          </div>
        </div>
        <!-- Thông tin phụ huynh -->
        <div class="form-section yellow">
          <h4><i class="fas fa-users"></i> Thông tin Phụ huynh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label class="required">Họ tên PH</label><input type="text"
                id="fParentName" class="form-control"></div>
            <div class="form-group"><label class="required">SĐT</label><input type="tel" id="fParentPhone"
                class="form-control"></div>
          </div>
          <div class="form-group"><label>Email</label><input type="email" id="fParentEmail" class="form-control"></div>
        </div>
        <!-- Thông tin khóa học -->
        <div class="form-section green">
          <h4><i class="fas fa-book"></i> Thông tin Khóa học</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="required">Gói học phí</label>
              <select id="fPackage" class="form-control" onchange="onPackageChange()">
                <option value="">-- Chọn gói --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Học phí gốc</label>
              <input type="text" id="fFeeOriginal" class="form-control" value="0đ" readonly
                style="background:#f3f4f6;font-weight:bold">
            </div>
          </div>
          <!-- Giảm giá -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#16a34a;font-weight:600"><i class="fas fa-percent"></i> Giảm giá</label>
            <div class="form-row" style="margin-top:8px">
              <div class="form-group" style="flex:2;margin-bottom:0">
                <select id="fPromoProgram" class="form-control" onchange="applyPromoProgram()">
                  <option value="">-- Không áp dụng --</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <input type="text" id="fPromoDiscount" class="form-control" value="0đ" readonly
                  style="background:#dcfce7;color:#16a34a;font-weight:bold;text-align:right">
              </div>
            </div>
          </div>
          <!-- Học bổng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <label style="color:#2563eb;font-weight:600;margin:0"><i class="fas fa-graduation-cap"></i> Học bổng tặng
                kèm</label>
              <span id="fDefaultScholarshipBadge"
                style="background:#dbeafe;color:#2563eb;padding:4px 10px;border-radius:12px;font-size:12px;display:none">Mặc
                định: <strong id="fDefaultScholarshipMonths">0</strong> tháng</span>
            </div>
            <div class="form-row" style="align-items:center">
              <div class="form-group" style="margin-bottom:0;flex:1">
                <input type="number" id="fScholarshipMonths" class="form-control" value="0" min="0" max="12"
                  onchange="onScholarshipChange()" style="font-size:18px;font-weight:bold;text-align:center">
              </div>
              <span style="padding:0 12px;color:#6b7280">tháng</span>
            </div>
            <div id="fScholarshipWarning"
              style="display:none;background:#fef3c7;color:#92400e;padding:8px 12px;border-radius:6px;margin-top:8px;font-size:12px">
              <i class="fas fa-exclamation-triangle"></i> Vượt mức mặc định, cần GDV duyệt
            </div>
          </div>
          <!-- Quà tặng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#db2777;font-weight:600"><i class="fas fa-gift"></i> Quà tặng</label>
            <input type="text" id="fGiftName" class="form-control" placeholder="VD: Balo, Áo thun..."
              style="margin-top:8px">
          </div>
          <!-- Tổng kết -->
          <div class="summary-box">
            <div class="summary-row"><span>Khóa học chính:</span><span id="fMainCourseMonths">0 tháng</span></div>
            <div class="summary-row"><span>Học bổng tặng:</span><span id="fBonusMonths" style="color:#4ade80">+0
                tháng</span></div>
            <div class="summary-total">
              <span style="font-size:16px"><strong>HỌC PHÍ THỰC ĐÓNG:</strong></span>
              <span id="fFeeTotal" style="font-size:24px;font-weight:bold;color:#fbbf24">0đ</span>
            </div>
          </div>
        </div>
        <!-- Thanh toán -->
        <div class="form-section pink">
          <h4><i class="fas fa-credit-card"></i> Thanh toán</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Trạng thái</label>
              <select id="fPaymentStatus" class="form-control" onchange="updatePaymentFields()">
                <option value="pending">Chưa đóng</option>
                <option value="deposit">Đặt cọc</option>
                <option value="partial">Đóng 1 phần</option>
                <option value="paid">Đã đóng đủ</option>
              </select>
            </div>
            <div class="form-group" id="fDepositGroup" style="display:none">
              <label>Tiền cọc</label>
              <input type="text" id="fDepositAmount" class="form-control" value="0đ"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
            <div class="form-group" id="fPaidGroup" style="display:none">
              <label>Đã thanh toán</label>
              <input type="text" id="fPaidAmount" class="form-control" value="0đ"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
          </div>
          <div id="fRemainingRow" style="display:none;background:white;padding:12px;border-radius:8px;margin-top:8px">
            <div style="display:flex;justify-content:space-between">
              <span>Còn phải đóng:</span>
              <span id="fRemaining" style="font-size:18px;font-weight:bold;color:#dc2626">0đ</span>
            </div>
          </div>
        </div>
        <div class="form-group"><label>Ghi chú</label><textarea id="fNote" class="form-control" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeFormModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveStudent()"><i class="fas fa-save"></i> Lưu</button>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="modal-content" style="max-width:700px">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-user-graduate"></i> Chi tiết học viên</div>
        <button class="modal-close" onclick="closeDetailModal()">&times;</button>
      </div>
      <div class="modal-body" id="detailContent"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDetailModal()">Đóng</button>
        <button class="btn btn-info" onclick="showPaymentQR(currentDetailId)"><i class="fas fa-qrcode"></i> QR Thanh
          toán</button>
        <button class="btn btn-primary" onclick="editStudent(currentDetailId)"><i class="fas fa-edit"></i> Sửa</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal" id="qrModal">
    <div class="modal-content" style="max-width:450px">
      <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white">
        <div class="modal-title"><i class="fas fa-qrcode"></i> Thanh toán học phí</div>
        <button class="modal-close" onclick="closeQRModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body" style="text-align:center;padding:24px">
        <input type="hidden" id="qrStudentId">
        <input type="hidden" id="qrRemainingRaw" value="0">
        <div id="qrStudentInfo" style="margin-bottom:16px"></div>
        <img id="qrImage" src="" alt="QR Code" style="max-width:220px;border-radius:8px;margin-bottom:16px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
          <div style="background:#dcfce7;padding:12px;border-radius:8px">
            <div style="color:#166534;font-size:12px">Đã đóng</div>
            <div style="color:#15803d;font-size:18px;font-weight:700" id="qrPaidAmount">0đ</div>
          </div>
          <div style="background:#fee2e2;padding:12px;border-radius:8px">
            <div style="color:#991b1b;font-size:12px">Còn phải đóng</div>
            <div style="color:#dc2626;font-size:18px;font-weight:700" id="qrRemainingAmount">0đ</div>
          </div>
        </div>
        <button class="btn btn-success" onclick="confirmPaymentFromQR()" style="width:100%;padding:12px;font-size:16px">
          <i class="fas fa-check-double"></i> Xác nhận đã nhận thanh toán
        </button>
      </div>
      <div class="modal-footer" style="justify-content:center">
        <button class="btn btn-primary" onclick="downloadEnrollmentForm()"><i class="fas fa-file-word"></i> Xuất đơn
          nhập học</button>
        <button class="btn btn-secondary" onclick="closeQRModal()">Đóng</button>
      </div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/sidebar.js"></script>
  <script>
    let students = [], packages = [], promoPrograms = [];
    let currentFilter = null, currentDetailId = null;
    let selectedPackage = null, defaultScholarshipMonths = 0;

    const statusConfig = {
      pending: { label: 'Chờ xếp lớp', icon: 'warning' },
      waiting: { label: 'Đang đợi lớp', icon: 'info' },
      active: { label: 'Đang học', icon: 'success' },
      paused: { label: 'Tạm dừng', icon: 'info' },
      expired: { label: 'Hết học phí', icon: 'danger' },
      quit_paid: { label: 'Nghỉ bỏ phí', icon: 'danger' },
      quit_refund: { label: 'Nghỉ rút phí', icon: 'warning' },
      reserved: { label: 'Bảo lưu', icon: 'purple' }
    };

    async function init() {
      await auth.requireAuth();
      buildSidebar('sidebar');
      await Promise.all([loadOptions(), loadStats()]);
      await loadData();
    }

    async function loadOptions() {
      const params = branch.current?.id ? `?branch_id=${branch.current.id}` : '';
      try {
        const pkgRes = await api.get('/packages' + params);
        packages = pkgRes.data || [];
      } catch (e) { packages = []; }
      try {
        const promoRes = await api.get('/promotions' + params);
        promoPrograms = promoRes.data || [];
      } catch (e) { promoPrograms = []; }
      try {
        const classRes = await api.get('/classes' + params);
        document.getElementById('classFilter').innerHTML = '<option value="">Tất cả lớp</option>' +
          (classRes.data || []).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      } catch (e) { }
    }

    async function loadStats() {
      try {
        const params = branch.current?.id ? `?branch_id=${branch.current.id}` : '';
        const res = await api.get('/students/stats' + params);
        const stats = res.data || {};
        document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card ${!currentFilter ? 'active' : ''}" onclick="filterByStatus(null)">
            <div class="stat-icon primary"><i class="fas fa-users"></i></div>
            <div><div class="stat-value">${stats.total || 0}</div><div class="stat-label">Tổng</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'active' ? 'active' : ''}" onclick="filterByStatus('active')">
            <div class="stat-icon success"><i class="fas fa-user-check"></i></div>
            <div><div class="stat-value">${stats.active || 0}</div><div class="stat-label">Đang học</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'waiting' ? 'active' : ''}" onclick="filterByStatus('waiting')">
            <div class="stat-icon info"><i class="fas fa-clock"></i></div>
            <div><div class="stat-value">${stats.waiting || 0}</div><div class="stat-label">Đợi lớp</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'expired' ? 'active' : ''}" onclick="filterByStatus('expired')">
            <div class="stat-icon danger"><i class="fas fa-exclamation-circle"></i></div>
            <div><div class="stat-value">${stats.expired || 0}</div><div class="stat-label">Hết phí</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'paused' ? 'active' : ''}" onclick="filterByStatus('paused')">
            <div class="stat-icon gray"><i class="fas fa-pause"></i></div>
            <div><div class="stat-value">${stats.paused || 0}</div><div class="stat-label">Tạm dừng</div></div>
          </div>
          <div class="stat-card ${currentFilter === 'reserved' ? 'active' : ''}" onclick="filterByStatus('reserved')">
            <div class="stat-icon purple"><i class="fas fa-bookmark"></i></div>
            <div><div class="stat-value">${stats.reserved || 0}</div><div class="stat-label">Bảo lưu</div></div>
          </div>
        `;
      } catch (e) { console.error(e); }
    }

    function filterByStatus(status) { currentFilter = status; loadStats(); loadData(); }

    async function loadData(page = 1) {
      try {
        const search = document.getElementById('searchInput').value;
        const classId = document.getElementById('classFilter').value;
        const params = new URLSearchParams();

        // Add branch if selected
        if (branch.current?.id) params.append('branch_id', branch.current.id);
        if (search) params.append('search', search);
        if (classId) params.append('class_id', classId);
        if (currentFilter) params.append('status', currentFilter);
        params.append('page', page);
        params.append('limit', 20);

        const url = '/students?' + params.toString();
        const res = await api.get(url);
        students = res.data || [];
        renderTable(students, res.pagination);
      } catch (e) {
        document.getElementById('dataTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Lỗi tải dữ liệu</td></tr>';
      }
    }

    function renderTable(items, pagination) {
      const tbody = document.getElementById('dataTable');
      if (!items.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Không có dữ liệu</td></tr>'; return; }
      tbody.innerHTML = items.map(s => {
        const status = statusConfig[s.status] || { label: s.status };
        const sessionsClass = (s.sessions_remaining || 0) <= 4 ? 'low' : 'normal';
        return `<tr>
          <td><div class="student-info"><span class="student-name" onclick="viewDetail(${s.id})">${s.full_name}</span><span class="student-meta">${s.student_code || ''} • ${s.birth_year || ''}</span></div></td>
          <td><div>${s.parent_name || '-'}</div><div style="font-size:12px;color:var(--text-secondary)">${s.parent_phone || ''}</div></td>
          <td>${s.class_name || '<span class="text-muted">Chưa xếp</span>'}</td>
          <td class="text-center"><span class="sessions-badge ${sessionsClass}">${s.sessions_remaining || 0} buổi</span></td>
          <td class="text-center"><span class="status-badge ${s.status}">${status.label}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-info" onclick="viewDetail(${s.id})" title="Xem"><i class="fas fa-eye"></i></button>
            <button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})" title="Sửa"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-success" onclick="showPaymentQR(${s.id})" title="QR"><i class="fas fa-qrcode"></i></button>
          </td>
        </tr>`;
      }).join('');
      document.getElementById('pagination').innerHTML = pagination && pagination.totalPages > 1 ? ui.pagination(pagination, loadData) : '';
    }

    // === Form Functions ===
    function openCreateModal() {
      document.getElementById('formId').value = '';
      document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-graduate"></i> Thêm học viên mới';
      resetForm();
      populateDropdowns();
      document.getElementById('formModal').classList.add('show');
    }

    async function editStudent(id) {
      try {
        const res = await api.get('/students/' + id);
        const s = res.data;
        document.getElementById('formId').value = s.id;
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i> Sửa: ' + s.full_name;
        document.getElementById('fStudentName').value = s.full_name || '';
        document.getElementById('fBirthYear').value = s.birth_year || '';
        document.getElementById('fGender').value = s.gender || '';
        document.getElementById('fAddress').value = s.address || '';
        document.getElementById('fParentName').value = s.parent_name || '';
        document.getElementById('fParentPhone').value = s.parent_phone || '';
        document.getElementById('fParentEmail').value = s.parent_email || '';
        document.getElementById('fNote').value = s.note || '';
        document.getElementById('fGiftName').value = s.gift_name || '';
        document.getElementById('fScholarshipMonths').value = s.scholarship_months || 0;
        populateDropdowns(s.package_id);
        const paidAmount = s.paid_amount || 0, totalFee = s.tuition_fee || 0;
        if (paidAmount >= totalFee && totalFee > 0) document.getElementById('fPaymentStatus').value = 'paid';
        else if (paidAmount > 0) { document.getElementById('fPaymentStatus').value = 'partial'; document.getElementById('fPaidAmount').value = formatCurrency(paidAmount); }
        else document.getElementById('fPaymentStatus').value = 'pending';
        updatePaymentFields();
        calculateTotals();
        closeDetailModal();
        document.getElementById('formModal').classList.add('show');
      } catch (e) { ui.error('Không thể tải thông tin'); }
    }

    function resetForm() {
      ['fStudentName', 'fBirthYear', 'fAddress', 'fParentName', 'fParentPhone', 'fParentEmail', 'fNote', 'fGiftName'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('fGender').value = '';
      document.getElementById('fPackage').value = '';
      document.getElementById('fPromoProgram').value = '';
      document.getElementById('fScholarshipMonths').value = '0';
      document.getElementById('fPaymentStatus').value = 'pending';
      document.getElementById('fDepositAmount').value = '0đ';
      document.getElementById('fPaidAmount').value = '0đ';
      document.getElementById('fFeeOriginal').value = '0đ';
      document.getElementById('fPromoDiscount').value = '0đ';
      document.getElementById('fFeeTotal').textContent = '0đ';
      document.getElementById('fMainCourseMonths').textContent = '0 tháng';
      document.getElementById('fBonusMonths').textContent = '+0 tháng';
      document.getElementById('fDefaultScholarshipBadge').style.display = 'none';
      document.getElementById('fScholarshipWarning').style.display = 'none';
      selectedPackage = null;
      defaultScholarshipMonths = 0;
      updatePaymentFields();
    }

    function populateDropdowns(pkgId = null) {
      const pkgSelect = document.getElementById('fPackage');
      pkgSelect.innerHTML = '<option value="">-- Chọn gói --</option>' + packages.map(p =>
        `<option value="${p.id}" data-price="${p.base_price || p.price}" data-months="${p.months}" data-scholarship="${p.default_scholarship_months || 0}" ${p.id == pkgId ? 'selected' : ''}>${p.name} - ${formatCurrency(p.base_price || p.price)}</option>`
      ).join('');
      const promoSelect = document.getElementById('fPromoProgram');
      promoSelect.innerHTML = '<option value="">-- Không áp dụng --</option>' + promoPrograms.map(p =>
        `<option value="${p.id}" data-type="${p.discount_type}" data-value="${p.discount_value}">${p.name}</option>`
      ).join('');
      if (pkgId) onPackageChange();
    }

    function onPackageChange() {
      const select = document.getElementById('fPackage');
      const option = select.options[select.selectedIndex];
      if (!option.value) {
        selectedPackage = null; defaultScholarshipMonths = 0;
        document.getElementById('fFeeOriginal').value = '0đ';
        document.getElementById('fMainCourseMonths').textContent = '0 tháng';
        document.getElementById('fDefaultScholarshipBadge').style.display = 'none';
      } else {
        selectedPackage = { price: parseFloat(option.dataset.price) || 0, months: parseInt(option.dataset.months) || 0 };
        defaultScholarshipMonths = parseInt(option.dataset.scholarship) || 0;
        document.getElementById('fFeeOriginal').value = formatCurrency(selectedPackage.price);
        document.getElementById('fMainCourseMonths').textContent = selectedPackage.months + ' tháng';
        if (defaultScholarshipMonths > 0) {
          document.getElementById('fDefaultScholarshipBadge').style.display = 'inline-block';
          document.getElementById('fDefaultScholarshipMonths').textContent = defaultScholarshipMonths;
        } else { document.getElementById('fDefaultScholarshipBadge').style.display = 'none'; }
      }
      calculateTotals();
    }

    function applyPromoProgram() { calculateTotals(); }

    function onScholarshipChange() {
      const months = parseInt(document.getElementById('fScholarshipMonths').value) || 0;
      document.getElementById('fScholarshipWarning').style.display = (months > defaultScholarshipMonths && defaultScholarshipMonths > 0) ? 'block' : 'none';
      document.getElementById('fBonusMonths').textContent = '+' + months + ' tháng';
      calculateTotals();
    }

    function calculateTotals() {
      if (!selectedPackage) { document.getElementById('fFeeTotal').textContent = '0đ'; return; }
      let originalFee = selectedPackage.price, discount = 0;
      const promoSelect = document.getElementById('fPromoProgram');
      const promoOption = promoSelect.options[promoSelect.selectedIndex];
      if (promoOption && promoOption.value) {
        const type = promoOption.dataset.type, val = parseFloat(promoOption.dataset.value) || 0;
        discount = type === 'percent' ? originalFee * val / 100 : val;
      }
      document.getElementById('fPromoDiscount').value = formatCurrency(discount);
      document.getElementById('fFeeTotal').textContent = formatCurrency(Math.max(0, originalFee - discount));
      updateRemaining();
    }

    function updatePaymentFields() {
      const status = document.getElementById('fPaymentStatus').value;
      document.getElementById('fDepositGroup').style.display = status === 'deposit' ? 'block' : 'none';
      document.getElementById('fPaidGroup').style.display = (status === 'partial' || status === 'paid') ? 'block' : 'none';
      document.getElementById('fRemainingRow').style.display = (status === 'deposit' || status === 'partial') ? 'block' : 'none';
      if (status === 'paid') document.getElementById('fPaidAmount').value = document.getElementById('fFeeTotal').textContent;
      updateRemaining();
    }

    function updateRemaining() {
      const total = parseCurrency(document.getElementById('fFeeTotal').textContent);
      const status = document.getElementById('fPaymentStatus').value;
      let paid = 0;
      if (status === 'deposit') paid = parseCurrency(document.getElementById('fDepositAmount').value);
      else if (status === 'partial' || status === 'paid') paid = parseCurrency(document.getElementById('fPaidAmount').value);
      document.getElementById('fRemaining').textContent = formatCurrency(Math.max(0, total - paid));
    }

    function closeFormModal() { document.getElementById('formModal').classList.remove('show'); }

    async function saveStudent() {
      const id = document.getElementById('formId').value;
      const studentName = document.getElementById('fStudentName').value.trim();
      const parentName = document.getElementById('fParentName').value.trim();
      const parentPhone = document.getElementById('fParentPhone').value.trim();
      if (!studentName || !parentName || !parentPhone) { ui.warning('Vui lòng nhập đầy đủ thông tin bắt buộc'); return; }
      const paymentStatus = document.getElementById('fPaymentStatus').value;
      let paidAmount = 0;
      if (paymentStatus === 'deposit') paidAmount = parseCurrency(document.getElementById('fDepositAmount').value);
      else if (paymentStatus === 'partial' || paymentStatus === 'paid') paidAmount = parseCurrency(document.getElementById('fPaidAmount').value);
      const data = {
        full_name: studentName, birth_year: document.getElementById('fBirthYear').value || null,
        gender: document.getElementById('fGender').value || null, address: document.getElementById('fAddress').value || null,
        parent_name: parentName, parent_phone: parentPhone, parent_email: document.getElementById('fParentEmail').value || null,
        note: document.getElementById('fNote').value || null, package_id: document.getElementById('fPackage').value || null,
        tuition_fee: parseCurrency(document.getElementById('fFeeTotal').textContent),
        discount_amount: parseCurrency(document.getElementById('fPromoDiscount').value),
        scholarship_months: parseInt(document.getElementById('fScholarshipMonths').value) || 0,
        gift_name: document.getElementById('fGiftName').value || null, paid_amount: paidAmount, payment_status: paymentStatus
      };
      try {
        if (id) { await api.put('/students/' + id, data); ui.success('Cập nhật thành công'); }
        else { await api.post('/students', data); ui.success('Thêm học viên thành công'); }
        closeFormModal(); loadData(); loadStats();
      } catch (e) { ui.error(e.message || 'Có lỗi xảy ra'); }
    }

    // === Detail & QR ===
    async function viewDetail(id) {
      try {
        const res = await api.get('/students/' + id);
        const s = res.data;
        currentDetailId = id;
        const status = statusConfig[s.status] || { label: s.status };
        document.getElementById('detailContent').innerHTML = `
          <div style="display:flex;gap:16px;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)">
            <div style="width:60px;height:60px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold">${(s.full_name || '?')[0].toUpperCase()}</div>
            <div style="flex:1"><h3 style="margin:0">${s.full_name}</h3><div style="color:var(--text-secondary)">${s.student_code || ''}</div></div>
            <span class="status-badge ${s.status}">${status.label}</span>
          </div>
          <div class="detail-section"><h4><i class="fas fa-child"></i> Thông tin học sinh</h4>
            <div class="detail-row"><span class="detail-label">Năm sinh</span><span class="detail-value">${s.birth_year || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Giới tính</span><span class="detail-value">${s.gender === 'male' ? 'Nam' : s.gender === 'female' ? 'Nữ' : '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Địa chỉ</span><span class="detail-value">${s.address || '-'}</span></div>
          </div>
          <div class="detail-section"><h4><i class="fas fa-users"></i> Thông tin phụ huynh</h4>
            <div class="detail-row"><span class="detail-label">Họ tên</span><span class="detail-value">${s.parent_name || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">SĐT</span><span class="detail-value">${s.parent_phone || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value">${s.parent_email || '-'}</span></div>
          </div>
          <div class="detail-section"><h4><i class="fas fa-book"></i> Thông tin học tập</h4>
            <div class="detail-row"><span class="detail-label">Lớp</span><span class="detail-value">${s.class_name || 'Chưa xếp lớp'}</span></div>
            <div class="detail-row"><span class="detail-label">Gói học</span><span class="detail-value">${s.package_name || '-'}</span></div>
            <div class="detail-row"><span class="detail-label">Buổi còn lại</span><span class="detail-value"><strong>${s.sessions_remaining || 0}</strong> buổi</span></div>
          </div>
          <div class="detail-section"><h4><i class="fas fa-credit-card"></i> Thanh toán</h4>
            <div class="detail-row"><span class="detail-label">Học phí</span><span class="detail-value">${formatCurrency(s.tuition_fee)}</span></div>
            <div class="detail-row"><span class="detail-label">Đã đóng</span><span class="detail-value" style="color:#16a34a;font-weight:600">${formatCurrency(s.paid_amount)}</span></div>
            <div class="detail-row"><span class="detail-label">Còn lại</span><span class="detail-value" style="color:#dc2626;font-weight:600">${formatCurrency(Math.max(0, (s.tuition_fee || 0) - (s.paid_amount || 0)))}</span></div>
          </div>`;
        document.getElementById('detailModal').classList.add('show');
      } catch (e) { ui.error('Không thể tải thông tin'); }
    }

    function closeDetailModal() { document.getElementById('detailModal').classList.remove('show'); }

    async function showPaymentQR(id) {
      try {
        const res = await api.get('/students/' + id);
        const s = res.data;
        const remaining = Math.max(0, (s.tuition_fee || 0) - (s.paid_amount || 0));
        document.getElementById('qrStudentId').value = id;
        document.getElementById('qrRemainingRaw').value = remaining;
        document.getElementById('qrStudentInfo').innerHTML = `<h3 style="margin:0">${s.full_name}</h3><div style="color:var(--text-secondary)">${s.student_code}</div>`;
        const qrUrl = `https://img.vietqr.io/image/970422-0866766189-compact2.png?amount=${remaining}&addInfo=${encodeURIComponent('HP ' + s.student_code)}`;
        document.getElementById('qrImage').src = qrUrl;
        document.getElementById('qrPaidAmount').textContent = formatCurrency(s.paid_amount);
        document.getElementById('qrRemainingAmount').textContent = formatCurrency(remaining);
        closeDetailModal();
        document.getElementById('qrModal').classList.add('show');
      } catch (e) { ui.error('Không thể tải thông tin'); }
    }

    function closeQRModal() { document.getElementById('qrModal').classList.remove('show'); }

    async function confirmPaymentFromQR() {
      const studentId = document.getElementById('qrStudentId').value;
      const remaining = parseFloat(document.getElementById('qrRemainingRaw').value) || 0;
      if (remaining <= 0) { ui.info('Học viên đã thanh toán đủ'); return; }
      if (!confirm(`Xác nhận đã nhận ${formatCurrency(remaining)} từ phụ huynh?`)) return;
      try {
        await api.post('/students/' + studentId + '/confirm-payment', { amount: remaining, paymentMethod: 'bank_transfer', note: 'Thanh toán qua QR' });
        ui.success('Xác nhận thanh toán thành công');
        closeQRModal(); loadData(); loadStats();
      } catch (e) { ui.error(e.message || 'Lỗi xác nhận thanh toán'); }
    }

    async function downloadEnrollmentForm() {
      const studentId = document.getElementById('qrStudentId').value || currentDetailId;
      if (!studentId) return;
      window.open(`${API_URL}/enrollment/${studentId}/form?token=${auth.getToken()}`, '_blank');
    }

    // === Helpers ===
    function formatCurrency(val) { return val ? new Intl.NumberFormat('vi-VN').format(val) + 'đ' : '0đ'; }
    function parseCurrency(str) { return parseInt(String(str).replace(/[^\d]/g, '')) || 0; }
    function formatCurrencyField(input) { const val = parseCurrency(input.value); if (val > 0) input.value = formatCurrency(val); }

    init();
  </script>
</body>

</html>