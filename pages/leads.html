<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Khách hàng tiềm năng - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.new {
      background: #f3f4f6;
      color: #6b7280;
    }

    .status-badge.scheduled {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .status-badge.attended {
      background: #fef3c7;
      color: #b45309;
    }

    .status-badge.waiting {
      background: #e0e7ff;
      color: #4f46e5;
    }

    .status-badge.converted {
      background: #dcfce7;
      color: #15803d;
    }

    .status-badge.cancelled {
      background: #fee2e2;
      color: #dc2626;
    }

    .status-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-tab {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--bg-card);
      cursor: pointer;
      font-size: 13px;
    }

    .status-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .status-tab .count {
      background: rgba(0, 0, 0, 0.1);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
    }

    .status-tab.active .count {
      background: rgba(255, 255, 255, 0.3);
    }

    .phone-link {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
    }

    .phone-link:hover {
      text-decoration: underline;
    }

    .view-toggle {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: 8px;
    }

    .view-toggle button {
      padding: 8px 12px;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 6px;
    }

    .view-toggle button.active {
      background: var(--bg-card);
      color: var(--primary);
    }

    .btn-purple {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .btn-purple:hover {
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .lead-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .lead-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .call-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin: 0 auto 16px;
    }

    .call-name {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
    }

    .call-phone {
      font-size: 16px;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 20px;
    }

    .call-status {
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .call-status.connecting {
      color: var(--warning);
      background: rgba(245, 158, 11, 0.1);
    }

    .call-status.connected {
      color: var(--success);
      background: rgba(34, 197, 94, 0.1);
    }

    .call-status.ended {
      color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }

    .call-timer {
      font-size: 32px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
      font-family: monospace;
    }

    .call-actions {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin: 20px 0;
    }

    .call-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 20px;
    }

    .call-btn.call {
      background: var(--success);
      color: white;
    }

    .call-btn.hangup {
      background: var(--danger);
      color: white;
    }

    .call-btn.mute {
      background: var(--bg-secondary);
    }

    .call-history {
      max-height: 200px;
      overflow-y: auto;
    }

    .call-history-item {
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    input[type="number"] {
      text-align: right;
    }
  </style>
</head>

<body>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')"><i
            class="fas fa-bars"></i></button>
        <h1><i class="fas fa-users"></i> Khách hàng tiềm năng</h1>
      </div>
      <div class="topbar-right">
        <div class="view-toggle">
          <button class="active" onclick="setView('table')" id="viewTable"><i class="fas fa-list"></i></button>
          <button onclick="setView('card')" id="viewCard"><i class="fas fa-th-large"></i></button>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()"><i class="fas fa-plus"></i> Thêm</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-info"><span class="stat-value" id="statTotal">0</span><span class="stat-label">Tổng</span>
        </div>
      </div>
      <div class="stat-card info">
        <div class="stat-icon"><i class="fas fa-calendar"></i></div>
        <div class="stat-info"><span class="stat-value" id="statScheduled">0</span><span class="stat-label">Đã
            hẹn</span></div>
      </div>
      <div class="stat-card warning">
        <div class="stat-icon"><i class="fas fa-user-check"></i></div>
        <div class="stat-info"><span class="stat-value" id="statAttended">0</span><span class="stat-label">Đã TN</span>
        </div>
      </div>
      <div class="stat-card success">
        <div class="stat-icon"><i class="fas fa-check"></i></div>
        <div class="stat-info"><span class="stat-value" id="statConverted">0</span><span class="stat-label">Chuyển
            đổi</span></div>
      </div>
    </div>

    <div class="card">
      <div class="card-body" style="padding:16px">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
          <div class="search-box" style="flex:1;min-width:200px"><i class="fas fa-search"></i><input type="text"
              id="searchInput" placeholder="Tìm tên, SĐT..." onkeyup="if(event.key==='Enter')loadData()"></div>
          <select id="sourceFilter" class="form-control" style="width:140px" onchange="loadData()">
            <option value="">Tất cả nguồn</option>
            <option value="facebook">Facebook</option>
            <option value="zalo">Zalo</option>
            <option value="walk-in">Walk-in</option>
            <option value="referral">Giới thiệu</option>
          </select>
          <button class="btn btn-secondary" onclick="loadData()"><i class="fas fa-sync"></i></button>
        </div>
        <div class="status-tabs" id="statusTabs"></div>
      </div>
    </div>

    <div class="card" id="tableView">
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>Mã</th>
              <th>Học sinh</th>
              <th>Phụ huynh</th>
              <th>SĐT</th>
              <th>Nguồn</th>
              <th>Trạng thái</th>
              <th>Ngày tạo</th>
              <th class="text-center">Thao tác</th>
            </tr>
          </thead>
          <tbody id="leadsTableBody">
            <tr>
              <td colspan="8" class="text-center">Đang tải...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="cardView" style="display:none">
      <div class="cards-grid" id="leadsGrid"></div>
    </div>
  </main>

  <!-- Form Modal -->
  <div class="modal" id="formModal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> Thêm Lead</div>
        <button class="modal-close" onclick="closeFormModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="leadForm">
          <input type="hidden" id="leadId">
          <div class="form-row">
            <div class="form-group"><label class="required">Tên học sinh</label><input type="text" name="studentName"
                class="form-control" required></div>
            <div class="form-group"><label>Năm sinh</label><input type="number" name="birthYear" class="form-control"
                placeholder="2015"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="required">Tên phụ huynh</label><input type="text" name="customerName"
                class="form-control" required></div>
            <div class="form-group"><label class="required">SĐT</label><input type="tel" name="customerPhone"
                class="form-control" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Email</label><input type="email" name="customerEmail" class="form-control">
            </div>
            <div class="form-group"><label>Nguồn</label><select name="source" class="form-control">
                <option value="facebook">Facebook</option>
                <option value="zalo">Zalo</option>
                <option value="walk-in">Walk-in</option>
                <option value="referral">Giới thiệu</option>
              </select></div>
          </div>
          <div class="form-group"><label>Ghi chú</label><textarea name="note" class="form-control" rows="2"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeFormModal()">Hủy</button>
        <button class="btn btn-primary" onclick="saveLead()"><i class="fas fa-save"></i> Lưu</button>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal" id="scheduleModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-calendar-plus"></i> Đặt lịch trải nghiệm</div>
        <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="scheduleLeadId">
        <div id="scheduleLeadInfo"
          style="background:var(--bg-secondary);padding:12px;border-radius:8px;margin-bottom:16px"></div>
        <div class="form-row">
          <div class="form-group"><label class="required">Ngày</label><input type="date" id="scheduleDate"
              class="form-control" required></div>
          <div class="form-group"><label class="required">Giờ</label><input type="time" id="scheduleTime"
              class="form-control" required></div>
        </div>
        <div class="form-group"><label>Bộ môn</label><select id="scheduleSubject" class="form-control">
            <option value="">-- Chọn bộ môn --</option>
          </select></div>
        <div class="form-group"><label>Ghi chú</label><textarea id="scheduleNote" class="form-control"
            rows="2"></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeScheduleModal()">Hủy</button>
        <button class="btn btn-success" onclick="saveSchedule()"><i class="fas fa-check"></i> Xác nhận</button>
      </div>
    </div>
  </div>

  <!-- Convert Modal -->
  <div class="modal" id="convertModal">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-user-graduate"></i> Chuyển đổi thành học sinh</div>
        <button class="modal-close" onclick="closeConvertModal()">&times;</button>
      </div>
      <div class="modal-body" style="max-height:80vh;overflow-y:auto">
        <input type="hidden" id="convertLeadId">

        <!-- Thông tin học sinh -->
        <div
          style="background:linear-gradient(135deg,#dbeafe,#e0e7ff);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#1e40af"><i class="fas fa-child"></i> Thông tin Học sinh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label class="required">Họ tên học sinh</label><input type="text"
                id="cvStudentName" class="form-control"></div>
            <div class="form-group"><label>Năm sinh</label><input type="number" id="cvStudentBirthYear"
                class="form-control" placeholder="2015"></div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label>Địa chỉ</label><input type="text" id="cvStudentAddress"
                class="form-control"></div>
            <div class="form-group"><label>Trường học</label><input type="text" id="cvStudentSchool"
                class="form-control"></div>
          </div>
        </div>

        <!-- Thông tin phụ huynh -->
        <div
          style="background:linear-gradient(135deg,#fef3c7,#fde68a);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#92400e"><i class="fas fa-users"></i> Thông tin Phụ huynh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2"><label class="required">Họ tên PH</label><input type="text"
                id="cvParentName" class="form-control"></div>
            <div class="form-group"><label class="required">SĐT</label><input type="tel" id="cvParentPhone"
                class="form-control"></div>
          </div>
          <div class="form-group"><label>Nghề nghiệp</label><input type="text" id="cvParentJob" class="form-control">
          </div>
        </div>

        <!-- Khóa học -->
        <div
          style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#166534"><i class="fas fa-book"></i> Thông tin Khóa học</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="required">Gói học phí</label>
              <select id="cvTuitionPackage" class="form-control" onchange="onPackageChange()">
                <option value="">-- Chọn gói --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Học phí gốc</label>
              <input type="text" id="cvFeeOriginal" class="form-control" value="0đ" readonly
                style="background:#f3f4f6;font-weight:bold">
            </div>
          </div>

          <!-- Giảm giá -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#16a34a;font-weight:600"><i class="fas fa-percent"></i> Giảm giá</label>
            <div class="form-row" style="margin-top:8px">
              <div class="form-group" style="flex:2;margin-bottom:0">
                <select id="cvPromoProgram" class="form-control" onchange="applyPromoProgram()">
                  <option value="">-- Không áp dụng --</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <input type="text" id="cvPromoDiscount" class="form-control" value="0đ" readonly
                  style="background:#dcfce7;color:#16a34a;font-weight:bold;text-align:right">
              </div>
            </div>
          </div>

          <!-- Học bổng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <label style="color:#2563eb;font-weight:600;margin:0"><i class="fas fa-graduation-cap"></i> Học bổng tặng
                kèm</label>
              <span id="cvDefaultScholarshipBadge"
                style="background:#dbeafe;color:#2563eb;padding:4px 10px;border-radius:12px;font-size:12px;display:none">Mặc
                định: <strong id="cvDefaultScholarshipMonths">0</strong> tháng</span>
            </div>
            <div class="form-row" style="align-items:center">
              <div class="form-group" style="margin-bottom:0;flex:1">
                <input type="number" id="cvScholarshipMonths" class="form-control" value="0" min="0" max="12"
                  onchange="onScholarshipChange()" style="font-size:18px;font-weight:bold;text-align:center">
              </div>
              <span style="padding:0 12px;color:#6b7280">tháng</span>
            </div>
          </div>

          <!-- Quà tặng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#db2777;font-weight:600"><i class="fas fa-gift"></i> Quà tặng</label>
            <div id="giftItemsContainer" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px"></div>
          </div>

          <!-- Tổng kết -->
          <div style="background:#1f2937;color:white;padding:16px;border-radius:8px;margin-top:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Khóa học chính:</span><span id="cvMainCourseMonths">0 tháng</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Học bổng tặng:</span><span id="cvBonusMonths" style="color:#4ade80">+0 tháng</span>
            </div>
            <div
              style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid #374151">
              <span style="font-size:16px"><strong>HỌC PHÍ THỰC ĐÓNG:</strong></span>
              <span id="cvFeeTotal" style="font-size:24px;font-weight:bold;color:#fbbf24">0đ</span>
            </div>
          </div>
        </div>

        <!-- Thanh toán -->
        <div
          style="background:linear-gradient(135deg,#fce7f3,#fbcfe8);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#9d174d"><i class="fas fa-credit-card"></i> Thanh toán</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Trạng thái</label>
              <select id="cvPaymentStatus" class="form-control" onchange="updatePaymentFields()">
                <option value="pending">Chưa đóng</option>
                <option value="deposit">Đặt cọc</option>
                <option value="partial">Đóng 1 phần</option>
                <option value="paid">Đã đóng đủ</option>
              </select>
            </div>
            <div class="form-group" id="depositGroup" style="display:none">
              <label>Tiền cọc</label>
              <input type="text" id="cvDepositAmount" class="form-control" value="0đ"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
            <div class="form-group" id="paidGroup" style="display:none">
              <label>Đã thanh toán</label>
              <input type="text" id="cvPaidAmount" class="form-control" value="0đ"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
          </div>
          <div id="remainingRow" style="display:none;background:white;padding:12px;border-radius:8px;margin-top:8px">
            <div style="display:flex;justify-content:space-between">
              <span>Còn phải đóng:</span>
              <span id="cvRemaining" style="font-size:18px;font-weight:bold;color:#dc2626">0đ</span>
            </div>
          </div>
        </div>

        <div class="form-group"><label>Ghi chú</label><textarea id="cvNote" class="form-control" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeConvertModal()">Hủy</button>
        <button class="btn btn-success" onclick="convertLead()"><i class="fas fa-check"></i> Chuyển đổi</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal" id="convertSuccessModal">
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white">
        <div class="modal-title"><i class="fas fa-check-circle"></i> Chuyển đổi thành công!</div>
        <button class="modal-close" onclick="closeConvertSuccessModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body" style="text-align:center;padding:24px">
        <input type="hidden" id="newStudentId">
        <input type="hidden" id="successRemainingRaw" value="0">

        <div style="margin-bottom:20px">
          <i class="fas fa-user-graduate" style="font-size:48px;color:#22c55e;margin-bottom:12px"></i>
          <h3 style="margin:0;color:#166534" id="successStudentName">Học sinh mới</h3>
          <p style="color:#6b7280;margin:4px 0" id="successStudentCode">Mã: ---</p>
        </div>

        <div id="successQRSection" style="display:none">
          <div style="background:#f9fafb;padding:16px;border-radius:12px;margin-bottom:16px">
            <h4 style="margin:0 0 12px;color:#1f2937"><i class="fas fa-qrcode"></i> QR Thanh toán</h4>
            <img id="successQRImage" src="" alt="QR Code" style="max-width:200px;border-radius:8px">
          </div>

          <div style="margin-bottom:16px">
            <div style="background:#dcfce7;padding:12px;border-radius:8px;margin-bottom:8px">
              <div style="color:#166534;font-size:13px">Đã đóng</div>
              <div style="color:#15803d;font-size:20px;font-weight:700" id="successPaidAmount">0đ</div>
            </div>
            <div style="background:#fee2e2;padding:12px;border-radius:8px">
              <div style="color:#991b1b;font-size:13px" id="successRemainingLabel">PH cần chuyển khoản</div>
              <div style="color:#dc2626;font-size:20px;font-weight:700" id="successRemainingAmount">0đ</div>
            </div>
          </div>

          <div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:16px">
            <div style="font-size:12px;color:#6b7280">Nội dung chuyển khoản:</div>
            <div style="font-weight:600;color:#1f2937" id="successPaymentDesc">---</div>
          </div>

          <button class="btn btn-success" onclick="confirmPaymentReceived()"
            style="width:100%;padding:12px;font-size:16px">
            <i class="fas fa-check-double"></i> Xác nhận đã nhận thanh toán
          </button>
        </div>

        <div id="successFullPaidSection" style="display:none;padding:20px">
          <i class="fas fa-check-double" style="font-size:48px;color:#22c55e;margin-bottom:12px"></i>
          <p style="color:#166534;font-weight:600">Đã thanh toán đầy đủ!</p>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:center;gap:12px">
        <button class="btn btn-primary" onclick="downloadEnrollmentForm()"><i class="fas fa-file-word"></i> Xuất đơn
          nhập học</button>
        <button class="btn btn-secondary" onclick="closeConvertSuccessModal()">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal" id="paymentModal">
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white">
        <div class="modal-title"><i class="fas fa-qrcode"></i> Thanh toán học phí</div>
        <button class="modal-close" onclick="closePaymentModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="paymentLeadId">
        <input type="hidden" id="paymentStudentId">
        <input type="hidden" id="paymentRemainingRaw" value="0">

        <div style="background:var(--bg-secondary);padding:12px;border-radius:8px;margin-bottom:16px;text-align:center">
          <div style="font-weight:600;font-size:16px" id="paymentStudentName">---</div>
          <div style="color:#6b7280;font-size:13px" id="paymentStudentCode">Mã: ---</div>
        </div>

        <div style="text-align:center;margin-bottom:16px">
          <div style="background:#f9fafb;padding:16px;border-radius:12px">
            <img id="paymentQRImage" src="" alt="QR Code" style="max-width:220px;border-radius:8px">
          </div>
        </div>

        <div class="form-row" style="margin-bottom:12px">
          <div class="form-group" style="flex:1">
            <div style="background:#dcfce7;padding:12px;border-radius:8px;text-align:center">
              <div style="color:#166534;font-size:12px">Học phí</div>
              <div style="color:#15803d;font-size:18px;font-weight:700" id="paymentFeeTotal">0đ</div>
            </div>
          </div>
          <div class="form-group" style="flex:1">
            <div style="background:#fee2e2;padding:12px;border-radius:8px;text-align:center">
              <div style="color:#991b1b;font-size:12px">Cần thanh toán</div>
              <div style="color:#dc2626;font-size:18px;font-weight:700" id="paymentRemaining">0đ</div>
            </div>
          </div>
        </div>

        <div style="background:#f3f4f6;padding:12px;border-radius:8px;text-align:center;margin-bottom:16px">
          <div style="font-size:12px;color:#6b7280">Nội dung chuyển khoản:</div>
          <div style="font-weight:600;color:#1f2937" id="paymentTransferDesc">---</div>
        </div>

        <button class="btn btn-success" onclick="confirmLeadPayment()" style="width:100%;padding:12px;font-size:16px"
          id="btnConfirmLeadPayment">
          <i class="fas fa-check-double"></i> Xác nhận đã nhận thanh toán
        </button>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" onclick="closePaymentModal()">Đóng</button></div>
    </div>
  </div>

  <!-- Call Modal -->
  <div class="modal" id="callModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-phone"></i> Cuộc gọi</div>
        <button class="modal-close" onclick="closeCallModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="callLeadId">
        <div class="call-avatar" id="callAvatar">N</div>
        <div class="call-name" id="callName">Tên</div>
        <div class="call-phone" id="callPhone">0901234567</div>
        <div class="call-status" id="callStatus">Sẵn sàng</div>
        <div class="call-timer" id="callTimer" style="display:none">00:00</div>
        <div class="call-actions">
          <button class="call-btn call" id="startCallBtn" onclick="startCall()"><i class="fas fa-phone"></i></button>
          <button class="call-btn hangup" id="hangupBtn" onclick="endCall()" style="display:none"><i
              class="fas fa-phone-slash"></i></button>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:20px;margin-top:20px">
          <div class="form-group"><label>Ghi chú</label><textarea id="callNote" class="form-control"
              rows="2"></textarea></div>
          <div class="form-group"><label>Kết quả</label>
            <select id="callResult" class="form-control">
              <option value="">--Chọn--</option>
              <option value="answered">Đã nghe</option>
              <option value="no_answer">Không nghe</option>
              <option value="busy">Máy bận</option>
              <option value="interested">Quan tâm</option>
              <option value="callback">Gọi lại</option>
            </select>
          </div>
          <button class="btn btn-primary btn-block" onclick="saveCallNote()"><i class="fas fa-save"></i> Lưu</button>
          <div style="margin-top:15px"><label><i class="fas fa-history"></i> Lịch sử</label>
            <div class="call-history" id="callHistory">
              <p class="text-muted text-center">Chưa có</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/sidebar.js"></script>
  <script>
    let leads = [], currentStatus = '', currentView = 'table', canDelete = false;
    const statusCfg = { new: { label: 'Mới' }, scheduled: { label: 'Đã hẹn' }, attended: { label: 'Đã TN' }, waiting: { label: 'Chờ xử lý' }, converted: { label: 'Chuyển đổi' }, cancelled: { label: 'Lỗi' } };

    // Payment config - sẽ được load từ API
    let paymentCfg = { bank_code: '970422', account_no: '0866766189', qr_template: 'compact2' };

    function getQRUrl(amount, description) {
      const desc = encodeURIComponent(description || 'Thanh toan');
      return 'https://img.vietqr.io/image/' + paymentCfg.bank_code + '-' + paymentCfg.account_no + '-' + paymentCfg.qr_template + '.png?amount=' + amount + '&addInfo=' + desc;
    }

    async function loadPaymentConfig() {
      try {
        const res = await api.get('/settings/payment');
        if (res.data && res.data.account_no) {
          paymentCfg = {
            bank_code: res.data.bank_code || '970422',
            account_no: res.data.account_no,
            qr_template: res.data.qr_template || 'compact2'
          };
        }
      } catch (e) { console.log('Using default payment config'); }
    }

    async function init() {
      if (!auth.checkAuth()) return;
      buildSidebar('sidebar');
      const user = auth.user;
      canDelete = ['ADMIN', 'HOEC', 'OM'].includes(user?.role_name?.toUpperCase());
      await loadPaymentConfig();
      await loadSubjects();
      await loadStats();
      await loadData();
    }

    let subjects = [];
    async function loadSubjects() { try { const res = await api.get('/common/subjects'); subjects = res.data || []; } catch (e) { console.error(e); } }

    async function loadStats() {
      try {
        const res = await api.get('/leads/stats');
        const s = res.data || {};
        document.getElementById('statTotal').textContent = s.total || 0;
        document.getElementById('statScheduled').textContent = s.scheduled || 0;
        document.getElementById('statAttended').textContent = (s.attended || 0) + (s.waiting || 0);
        document.getElementById('statConverted').textContent = s.converted || 0;
        document.getElementById('statusTabs').innerHTML =
          '<div class="status-tab ' + (!currentStatus ? 'active' : '') + '" onclick="filterStatus(\'\')">Tất cả<span class="count">' + (s.total || 0) + '</span></div>' +
          '<div class="status-tab ' + (currentStatus === 'new' ? 'active' : '') + '" onclick="filterStatus(\'new\')">Mới<span class="count">' + (s.new || 0) + '</span></div>' +
          '<div class="status-tab ' + (currentStatus === 'scheduled' ? 'active' : '') + '" onclick="filterStatus(\'scheduled\')">Đã hẹn<span class="count">' + (s.scheduled || 0) + '</span></div>' +
          '<div class="status-tab ' + (currentStatus === 'waiting' ? 'active' : '') + '" onclick="filterStatus(\'waiting\')">Chờ xử lý<span class="count">' + (s.waiting || 0) + '</span></div>' +
          '<div class="status-tab ' + (currentStatus === 'converted' ? 'active' : '') + '" onclick="filterStatus(\'converted\')">Chuyển đổi<span class="count">' + (s.converted || 0) + '</span></div>' +
          '<div class="status-tab ' + (currentStatus === 'cancelled' ? 'active' : '') + '" onclick="filterStatus(\'cancelled\')">Lỗi<span class="count">' + (s.cancelled || 0) + '</span></div>';
      } catch (e) { console.error(e); }
    }

    async function loadData() {
      const search = document.getElementById('searchInput').value;
      const source = document.getElementById('sourceFilter').value;
      try {
        const p = new URLSearchParams();
        if (currentStatus) p.append('status', currentStatus);
        if (search) p.append('search', search);
        if (source) p.append('source', source);
        const res = await api.get('/leads?' + p);
        leads = res.data || [];
        renderTable(); renderCards();
      } catch (e) { console.error(e); document.getElementById('leadsTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Lỗi</td></tr>'; }
    }

    function filterStatus(s) { currentStatus = s; loadStats(); loadData(); }
    function setView(v) { currentView = v; document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active')); document.getElementById('view' + v.charAt(0).toUpperCase() + v.slice(1)).classList.add('active'); document.getElementById('tableView').style.display = v === 'table' ? 'block' : 'none'; document.getElementById('cardView').style.display = v === 'card' ? 'block' : 'none'; }
    function escapeHtml(str) { return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

    function getActionButtons(l) {
      let btns = '';
      const sessionsAttended = parseInt(l.trial_sessions_attended) || 0;
      const sessionsMax = parseInt(l.trial_sessions_max) || 3;
      switch (l.status) {
        case 'new':
          btns = '<button class="btn btn-sm btn-success" onclick="openScheduleModal(' + l.id + ')" title="Đặt lịch TN"><i class="fas fa-calendar-plus"></i></button> ';
          btns += '<button class="btn btn-sm btn-secondary" onclick="markCancelled(' + l.id + ')" title="Đánh dấu lỗi"><i class="fas fa-ban"></i></button> ';
          break;
        case 'scheduled':
          btns = '<button class="btn btn-sm btn-success" onclick="markAttended(' + l.id + ')" title="Đã đến"><i class="fas fa-check"></i></button> ';
          btns += '<button class="btn btn-sm btn-warning" onclick="markNoShow(' + l.id + ')" title="Không đến"><i class="fas fa-times"></i></button> ';
          break;
        case 'attended':
        case 'waiting':
          btns = '<span class="badge" style="background:#8b5cf6;color:#fff;margin-right:6px">B' + sessionsAttended + '/' + sessionsMax + '</span> ';
          if (sessionsAttended < sessionsMax) btns += '<button class="btn btn-sm btn-purple" onclick="openScheduleModal(' + l.id + ')" title="Đặt buổi tiếp"><i class="fas fa-calendar-plus"></i></button> ';
          btns += '<button class="btn btn-sm btn-success" onclick="openConvertModal(' + l.id + ')" title="Chuyển đổi"><i class="fas fa-user-graduate"></i></button> ';
          break;
        case 'converted':
          const feeTotal = parseFloat(l.fee_total) || 0;
          const actualRevenue = parseFloat(l.actual_revenue) || 0;
          const remaining = feeTotal - actualRevenue;
          if (remaining <= 0) {
            btns = '<span class="badge" style="background:#22c55e;color:#fff"><i class="fas fa-check-double"></i> Đã TT đủ</span> ';
          } else if (actualRevenue > 0) {
            btns = '<span class="badge" style="background:#f59e0b;color:#fff"><i class="fas fa-clock"></i> Còn nợ</span> ';
            btns += '<button class="btn btn-sm btn-warning" onclick="openPaymentModal(' + l.id + ')" title="Thu nợ"><i class="fas fa-dollar-sign"></i></button> ';
          } else {
            btns = '<span class="badge" style="background:#ef4444;color:#fff"><i class="fas fa-exclamation"></i> Chưa TT</span> ';
            btns += '<button class="btn btn-sm btn-danger" onclick="openPaymentModal(' + l.id + ')" title="Thu tiền"><i class="fas fa-dollar-sign"></i></button> ';
          }
          break;
        case 'cancelled':
          btns = '<span class="text-danger"><i class="fas fa-ban"></i> Lỗi</span> ';
          break;
      }
      btns += '<button class="btn btn-sm btn-info" onclick="editLead(' + l.id + ')" title="Sửa"><i class="fas fa-edit"></i></button> ';
      if (canDelete) btns += '<button class="btn btn-sm btn-danger" onclick="deleteLead(' + l.id + ')" title="Xóa"><i class="fas fa-trash"></i></button>';
      return btns;
    }

    function renderTable() {
      const tb = document.getElementById('leadsTableBody');
      if (!leads.length) { tb.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Chưa có lead</td></tr>'; return; }
      tb.innerHTML = leads.map(l => '<tr><td><code>' + (l.code || '-') + '</code></td><td><strong>' + escapeHtml(l.student_name) + '</strong></td><td>' + escapeHtml(l.customer_name) + '</td><td><a href="javascript:void(0)" class="phone-link" onclick="openCallModal(' + l.id + ',\'' + escapeHtml(l.customer_name) + '\',\'' + l.customer_phone + '\')"><i class="fas fa-phone"></i> ' + l.customer_phone + '</a></td><td>' + (l.source || '-') + '</td><td><span class="status-badge ' + l.status + '">' + (statusCfg[l.status]?.label || l.status) + '</span></td><td>' + formatDate(l.created_at) + '</td><td class="text-center">' + getActionButtons(l) + '</td></tr>').join('');
    }

    function renderCards() {
      const c = document.getElementById('leadsGrid');
      if (!leads.length) { c.innerHTML = '<p class="text-muted">Chưa có lead</p>'; return; }
      c.innerHTML = leads.map(l => '<div class="lead-card"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><strong>' + escapeHtml(l.student_name) + '</strong><span class="status-badge ' + l.status + '">' + (statusCfg[l.status]?.label || l.status) + '</span></div><div style="font-size:13px;color:var(--text-secondary)"><div><i class="fas fa-user"></i> ' + escapeHtml(l.customer_name) + '</div><div><i class="fas fa-phone"></i> ' + l.customer_phone + '</div></div><div style="margin-top:10px;display:flex;gap:6px">' + getActionButtons(l) + '</div></div>').join('');
    }

    // Form Modal
    function openCreateModal() { document.getElementById('leadId').value = ''; document.getElementById('leadForm').reset(); document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Thêm Lead'; document.getElementById('formModal').classList.add('show'); }
    function closeFormModal() { document.getElementById('formModal').classList.remove('show'); }
    async function editLead(id) {
      try {
        const res = await api.get('/leads/' + id);
        const l = res.data;
        document.getElementById('leadId').value = l.id;
        document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Sửa Lead';
        const f = document.getElementById('leadForm');
        f.studentName.value = l.student_name || '';
        f.birthYear.value = l.birth_year || '';
        f.customerName.value = l.customer_name || '';
        f.customerPhone.value = l.customer_phone || '';
        f.customerEmail.value = l.customer_email || '';
        f.source.value = l.source || 'facebook';
        f.note.value = l.note || '';
        document.getElementById('formModal').classList.add('show');
      } catch (e) { ui.error(e.message); }
    }
    async function saveLead() {
      const f = document.getElementById('leadForm');
      const id = document.getElementById('leadId').value;
      const data = { studentName: f.studentName.value, studentBirthYear: f.birthYear.value || null, customerName: f.customerName.value, customerPhone: f.customerPhone.value, customerEmail: f.customerEmail.value || null, source: f.source.value, note: f.note.value || null };
      try {
        if (id) { await api.put('/leads/' + id, data); ui.success('Cập nhật thành công'); }
        else { await api.post('/leads', data); ui.success('Thêm thành công'); }
        closeFormModal(); loadStats(); loadData();
      } catch (e) { ui.error(e.message); }
    }
    async function deleteLead(id) { if (!confirm('Xóa lead này?')) return; try { await api.delete('/leads/' + id); ui.success('Đã xóa'); loadStats(); loadData(); } catch (e) { ui.error(e.message); } }

    // Schedule Modal
    let currentScheduleLead = null;
    async function openScheduleModal(id) {
      try {
        const res = await api.get('/leads/' + id);
        currentScheduleLead = res.data;
        document.getElementById('scheduleLeadId').value = id;
        document.getElementById('scheduleLeadInfo').innerHTML = '<strong>' + escapeHtml(currentScheduleLead.student_name) + '</strong><br><small>' + escapeHtml(currentScheduleLead.customer_name) + ' - ' + currentScheduleLead.customer_phone + '</small>';
        document.getElementById('scheduleSubject').innerHTML = '<option value="">-- Chọn bộ môn --</option>' + subjects.map(s => '<option value="' + s.id + '">' + escapeHtml(s.name) + '</option>').join('');
        const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
        document.getElementById('scheduleTime').value = '09:00';
        document.getElementById('scheduleSubject').value = currentScheduleLead.subject_id || '';
        document.getElementById('scheduleNote').value = '';
        document.getElementById('scheduleModal').classList.add('show');
      } catch (e) { ui.error(e.message); }
    }
    function closeScheduleModal() { document.getElementById('scheduleModal').classList.remove('show'); }
    async function saveSchedule() {
      const id = document.getElementById('scheduleLeadId').value;
      const date = document.getElementById('scheduleDate').value;
      const time = document.getElementById('scheduleTime').value;
      if (!date || !time) { ui.warning('Vui lòng chọn ngày và giờ'); return; }
      try {
        await api.post('/leads/' + id + '/schedule', { scheduledDate: date, scheduledTime: time, subjectId: document.getElementById('scheduleSubject').value || null, note: document.getElementById('scheduleNote').value || null });
        ui.success('Đã đặt lịch trải nghiệm');
        closeScheduleModal(); loadStats(); loadData();
      } catch (e) { ui.error(e.message); }
    }

    // Mark status
    async function markAttended(id) { if (!confirm('Xác nhận học sinh đã đến?')) return; try { await api.post('/leads/' + id + '/attended'); ui.success('Đã cập nhật'); loadStats(); loadData(); } catch (e) { ui.error(e.message); } }
    async function markNoShow(id) { if (!confirm('Xác nhận học sinh không đến?')) return; try { await api.post('/leads/' + id + '/no-show'); ui.success('Đã cập nhật'); loadStats(); loadData(); } catch (e) { ui.error(e.message); } }
    async function markCancelled(id) { const reason = prompt('Lý do:'); if (reason === null) return; try { await api.put('/leads/' + id, { status: 'cancelled', note: reason || 'Lỗi' }); ui.success('Đã cập nhật'); loadStats(); loadData(); } catch (e) { ui.error(e.message); } }

    // Convert Modal
    let currentConvertLead = null, promoData = { programs: [], items: [] }, packagesData = [], selectedPackage = null, defaultScholarshipMonths = 0;

    function formatCurrency(v) { return v ? new Intl.NumberFormat('vi-VN').format(v) + 'đ' : '0đ'; }
    function parseCurrency(str) { return parseInt(String(str).replace(/[^\d]/g, '')) || 0; }
    function formatCurrencyField(input) {
      const rawValue = parseCurrency(input.value);
      input.value = rawValue > 0 ? formatCurrency(rawValue) : '0đ';
      input.dataset.rawValue = rawValue;
    }

    function calcFeeTotal() {
      const orig = parseCurrency(document.getElementById('cvFeeOriginal').value);
      const promoDisc = parseCurrency(document.getElementById('cvPromoDiscount').value);
      const total = Math.max(0, orig - promoDisc);
      document.getElementById('cvFeeTotal').textContent = formatCurrency(total);
      document.getElementById('cvFeeTotal').dataset.rawValue = total;
      updateRemaining();
    }

    function updatePaymentFields() {
      const status = document.getElementById('cvPaymentStatus').value;
      document.getElementById('depositGroup').style.display = status === 'pending' ? 'none' : 'block';
      document.getElementById('paidGroup').style.display = (status === 'partial' || status === 'paid') ? 'block' : 'none';
      document.getElementById('remainingRow').style.display = status === 'pending' ? 'none' : 'block';
      if (status === 'paid') {
        const total = parseFloat(document.getElementById('cvFeeTotal').dataset.rawValue) || 0;
        document.getElementById('cvPaidAmount').value = formatCurrency(total);
        document.getElementById('cvPaidAmount').dataset.rawValue = total;
        document.getElementById('cvDepositAmount').value = '0đ';
        document.getElementById('cvDepositAmount').dataset.rawValue = 0;
      }
      updateRemaining();
    }

    function updateRemaining() {
      const total = parseFloat(document.getElementById('cvFeeTotal').dataset.rawValue) || 0;
      const deposit = parseCurrency(document.getElementById('cvDepositAmount').value);
      const paid = parseCurrency(document.getElementById('cvPaidAmount').value);
      document.getElementById('cvRemaining').textContent = formatCurrency(Math.max(0, total - deposit - paid));
    }

    function onPackageChange() {
      const packageId = document.getElementById('cvTuitionPackage').value;
      selectedPackage = packagesData.find(p => p.id == packageId);
      if (selectedPackage) {
        document.getElementById('cvFeeOriginal').value = formatCurrency(selectedPackage.price);
        document.getElementById('cvFeeOriginal').dataset.rawValue = selectedPackage.price;
        document.getElementById('cvMainCourseMonths').textContent = selectedPackage.months + ' tháng';
        document.getElementById('cvMainCourseMonths').dataset.months = selectedPackage.months;
        defaultScholarshipMonths = selectedPackage.default_scholarship_months || 0;
        document.getElementById('cvDefaultScholarshipMonths').textContent = defaultScholarshipMonths;
        document.getElementById('cvDefaultScholarshipBadge').style.display = 'inline-block';
        document.getElementById('cvScholarshipMonths').value = defaultScholarshipMonths;
      } else {
        document.getElementById('cvFeeOriginal').value = '0đ';
        document.getElementById('cvFeeOriginal').dataset.rawValue = 0;
        document.getElementById('cvMainCourseMonths').textContent = '0 tháng';
        document.getElementById('cvMainCourseMonths').dataset.months = 0;
        defaultScholarshipMonths = 0;
        document.getElementById('cvDefaultScholarshipBadge').style.display = 'none';
        document.getElementById('cvScholarshipMonths').value = 0;
      }
      applyPromoProgram();
      onScholarshipChange();
    }

    function onScholarshipChange() {
      const bonusMonths = parseInt(document.getElementById('cvScholarshipMonths').value) || 0;
      const mainMonths = parseInt(document.getElementById('cvMainCourseMonths').dataset.months) || 0;
      document.getElementById('cvBonusMonths').textContent = '+' + bonusMonths + ' tháng';
    }

    function applyPromoProgram() {
      const programId = document.getElementById('cvPromoProgram').value;
      if (!programId) {
        document.getElementById('cvPromoDiscount').value = '0đ';
        document.getElementById('cvPromoDiscount').dataset.rawValue = 0;
        calcFeeTotal();
        return;
      }
      const program = promoData.programs.find(p => p.id == programId);
      if (!program) return;
      const orig = parseCurrency(document.getElementById('cvFeeOriginal').value);
      let discount = 0;
      if (program.discount_type === 'percent') {
        discount = Math.round(orig * program.discount_value / 100);
        if (program.max_discount && discount > program.max_discount) discount = program.max_discount;
      } else {
        discount = program.discount_value;
      }
      document.getElementById('cvPromoDiscount').value = formatCurrency(discount);
      document.getElementById('cvPromoDiscount').dataset.rawValue = discount;
      calcFeeTotal();
    }

    async function openConvertModal(id) {
      try {
        const res = await api.get('/leads/' + id);
        currentConvertLead = res.data;
        document.getElementById('convertLeadId').value = id;
        document.getElementById('cvStudentName').value = currentConvertLead.student_name || '';
        document.getElementById('cvStudentBirthYear').value = currentConvertLead.birth_year || '';
        document.getElementById('cvStudentAddress').value = '';
        document.getElementById('cvStudentSchool').value = '';
        document.getElementById('cvParentName').value = currentConvertLead.customer_name || '';
        document.getElementById('cvParentPhone').value = currentConvertLead.customer_phone || '';
        document.getElementById('cvParentJob').value = '';
        document.getElementById('cvPaymentStatus').value = 'pending';
        document.getElementById('cvDepositAmount').value = '0đ'; document.getElementById('cvDepositAmount').dataset.rawValue = 0;
        document.getElementById('cvPaidAmount').value = '0đ'; document.getElementById('cvPaidAmount').dataset.rawValue = 0;
        document.getElementById('depositGroup').style.display = 'none';
        document.getElementById('paidGroup').style.display = 'none';
        document.getElementById('remainingRow').style.display = 'none';
        document.getElementById('cvNote').value = '';
        document.getElementById('cvFeeOriginal').value = '0đ'; document.getElementById('cvFeeOriginal').dataset.rawValue = 0;
        document.getElementById('cvPromoDiscount').value = '0đ'; document.getElementById('cvPromoDiscount').dataset.rawValue = 0;
        document.getElementById('cvFeeTotal').textContent = '0đ'; document.getElementById('cvFeeTotal').dataset.rawValue = 0;
        document.getElementById('cvMainCourseMonths').textContent = '0 tháng'; document.getElementById('cvMainCourseMonths').dataset.months = 0;
        document.getElementById('cvBonusMonths').textContent = '+0 tháng';
        document.getElementById('cvScholarshipMonths').value = 0;
        document.getElementById('cvDefaultScholarshipBadge').style.display = 'none';
        defaultScholarshipMonths = 0;
        await loadConvertData();
        document.getElementById('convertModal').classList.add('show');
      } catch (e) { ui.error(e.message); }
    }

    async function loadConvertData() {
      try {
        const promoRes = await api.get('/promotions/convert-data');
        promoData = promoRes.data || { programs: [], items: [] };
        const pkgRes = await api.get('/packages');
        packagesData = pkgRes.data || [];
        document.getElementById('cvTuitionPackage').innerHTML = '<option value="">-- Chọn gói --</option>' + packagesData.map(p => '<option value="' + p.id + '">' + escapeHtml(p.name) + ' (' + p.months + 'T - ' + formatCurrency(p.price) + ')</option>').join('');
        document.getElementById('cvPromoProgram').innerHTML = '<option value="">-- Không áp dụng --</option>' + promoData.programs.map(p => '<option value="' + p.id + '">' + escapeHtml(p.name) + ' (' + (p.discount_type === 'percent' ? p.discount_value + '%' : formatCurrency(p.discount_value)) + ')</option>').join('');
        const giftContainer = document.getElementById('giftItemsContainer');
        if (promoData.items && promoData.items.length) {
          giftContainer.innerHTML = promoData.items.map(i => '<label style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:#fff;border-radius:20px;cursor:pointer;border:1px solid #e5e7eb"><input type="checkbox" class="gift-checkbox" data-id="' + i.id + '" data-name="' + escapeHtml(i.name) + '"><span>🎁 ' + escapeHtml(i.name) + '</span><small style="color:#6b7280">(' + i.stock_quantity + ')</small></label>').join('');
        } else { giftContainer.innerHTML = '<span style="color:#6b7280">Chưa có quà tặng</span>'; }
      } catch (e) { console.error(e); }
    }

    function closeConvertModal() { document.getElementById('convertModal').classList.remove('show'); }

    async function convertLead() {
      const id = document.getElementById('convertLeadId').value;
      const studentName = document.getElementById('cvStudentName').value.trim();
      const parentName = document.getElementById('cvParentName').value.trim();
      const parentPhone = document.getElementById('cvParentPhone').value.trim();
      const packageId = document.getElementById('cvTuitionPackage').value;
      const feeOriginal = parseCurrency(document.getElementById('cvFeeOriginal').value);
      const promoDiscount = parseCurrency(document.getElementById('cvPromoDiscount').value);
      const feeTotal = parseFloat(document.getElementById('cvFeeTotal').dataset.rawValue) || 0;
      const scholarshipMonths = parseInt(document.getElementById('cvScholarshipMonths').value) || 0;
      const depositAmount = parseCurrency(document.getElementById('cvDepositAmount').value);
      const paidAmount = parseCurrency(document.getElementById('cvPaidAmount').value);
      const programId = document.getElementById('cvPromoProgram').value || null;

      if (!studentName) { ui.warning('Vui lòng nhập họ tên học sinh'); return; }
      if (!parentName || !parentPhone) { ui.warning('Vui lòng nhập thông tin phụ huynh'); return; }
      if (!packageId) { ui.warning('Vui lòng chọn gói học phí'); return; }

      const selectedGifts = [];
      document.querySelectorAll('.gift-checkbox:checked').forEach(cb => selectedGifts.push({ id: cb.dataset.id, name: cb.dataset.name }));

      // TÍNH TỔNG TIỀN ĐÃ ĐÓNG
      const totalPaid = depositAmount + paidAmount;

      try {
        const result = await api.post('/leads/' + id + '/convert', {
          studentName, birthYear: document.getElementById('cvStudentBirthYear').value,
          address: document.getElementById('cvStudentAddress').value, school: document.getElementById('cvStudentSchool').value,
          customerName: parentName, customerPhone: parentPhone, parentJob: document.getElementById('cvParentJob').value,
          packageId, feeOriginal, feeDiscount: promoDiscount, feeTotal, scholarshipMonths,
          defaultScholarshipMonths, scholarshipNeedsApproval: scholarshipMonths > defaultScholarshipMonths,
          depositAmount, paidAmount, paymentStatus: document.getElementById('cvPaymentStatus').value,
          programId, gifts: selectedGifts, note: document.getElementById('cvNote').value
        });

        closeConvertModal();

        const student = result.data || {};
        const studentId = student.id || student.studentId;
        const studentCode = student.student_code || student.studentCode || '';
        const paymentStatus = document.getElementById('cvPaymentStatus').value;

        document.getElementById('newStudentId').value = studentId;
        document.getElementById('successStudentName').textContent = studentName;
        document.getElementById('successStudentCode').textContent = 'Mã: ' + studentCode;

        const desc = encodeURIComponent(studentCode + ' ' + studentName.substring(0, 15));
        document.getElementById('successPaymentDesc').textContent = studentCode + ' ' + studentName.substring(0, 15);

        // LOGIC HIỂN THỊ QR THEO TRẠNG THÁI THANH TOÁN
        if (paymentStatus === 'pending') {
          // Chưa đóng: Không hiện QR, chỉ thông báo
          document.getElementById('successQRSection').style.display = 'none';
          document.getElementById('successFullPaidSection').style.display = 'none';
          document.getElementById('successPaidAmount').textContent = '0đ';
          document.getElementById('successRemainingAmount').textContent = formatCurrency(feeTotal);
          document.getElementById('successRemainingRaw').value = feeTotal;
        } else if (paymentStatus === 'deposit') {
          // Đặt cọc: QR hiện SỐ TIỀN CỌC để PH chuyển khoản
          document.getElementById('successQRSection').style.display = 'block';
          document.getElementById('successFullPaidSection').style.display = 'none';
          document.getElementById('successPaidAmount').textContent = '0đ (chờ CK)';
          document.getElementById('successRemainingAmount').textContent = formatCurrency(depositAmount);
          document.getElementById('successRemainingRaw').value = depositAmount;
          document.getElementById('successQRImage').src = getQRUrl(depositAmount, studentCode + ' ' + studentName.substring(0, 15));
        } else if (paymentStatus === 'partial') {
          // Đóng 1 phần: QR hiện số tiền đã đóng (cọc + paid)
          const amountToPay = depositAmount + paidAmount;
          document.getElementById('successQRSection').style.display = 'block';
          document.getElementById('successFullPaidSection').style.display = 'none';
          document.getElementById('successPaidAmount').textContent = '0đ (chờ CK)';
          document.getElementById('successRemainingAmount').textContent = formatCurrency(amountToPay);
          document.getElementById('successRemainingRaw').value = amountToPay;
          document.getElementById('successQRImage').src = getQRUrl(amountToPay, studentCode + ' ' + studentName.substring(0, 15));
        } else if (paymentStatus === 'paid') {
          // Đóng đủ: QR hiện TOÀN BỘ học phí
          document.getElementById('successQRSection').style.display = 'block';
          document.getElementById('successFullPaidSection').style.display = 'none';
          document.getElementById('successPaidAmount').textContent = '0đ (chờ CK)';
          document.getElementById('successRemainingAmount').textContent = formatCurrency(feeTotal);
          document.getElementById('successRemainingRaw').value = feeTotal;
          document.getElementById('successQRImage').src = getQRUrl(feeTotal, studentCode + ' ' + studentName.substring(0, 15));
        }

        document.getElementById('convertSuccessModal').classList.add('show');
        ui.success('Chuyển đổi thành công!');
        loadStats(); loadData();
      } catch (e) { ui.error(e.message); }
    }

    function closeConvertSuccessModal() { document.getElementById('convertSuccessModal').classList.remove('show'); }

    async function confirmPaymentReceived() {
      const studentId = document.getElementById('newStudentId').value;
      const amountToConfirm = parseFloat(document.getElementById('successRemainingRaw').value) || 0;
      if (!studentId || amountToConfirm <= 0) return;
      if (!confirm('Xác nhận đã nhận được ' + formatCurrency(amountToConfirm) + '?')) return;
      try {
        await api.post('/students/' + studentId + '/confirm-payment', { amount: amountToConfirm, paymentMethod: 'bank_transfer', note: 'Thanh toán qua QR' });
        ui.success('Đã ghi nhận thanh toán ' + formatCurrency(amountToConfirm));

        // Cập nhật hiển thị
        const currentPaid = parseCurrency(document.getElementById('successPaidAmount').textContent);
        const newPaid = currentPaid + amountToConfirm;
        document.getElementById('successPaidAmount').textContent = formatCurrency(newPaid);

        // Lấy tổng học phí để tính còn nợ
        // Ẩn QR section, hiện thông báo đã thanh toán
        document.getElementById('successQRSection').style.display = 'none';
        document.getElementById('successFullPaidSection').style.display = 'block';
        document.getElementById('successRemainingRaw').value = 0;

        loadStats(); loadData();
      } catch (e) { ui.error(e.message); }
    }

    function downloadEnrollmentForm() {
      const studentId = document.getElementById('newStudentId').value;
      if (!studentId) return;
      const token = localStorage.getItem('token');
      fetch(window.LMS_CONFIG.API_BASE + '/enrollment/' + studentId + '/form', { headers: { 'Authorization': 'Bearer ' + token } })
        .then(r => r.blob())
        .then(blob => { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Don_nhap_hoc_' + studentId + '.docx'; a.click(); })
        .catch(e => ui.error(e.message));
    }

    // Payment Modal
    async function openPaymentModal(id) {
      try {
        const res = await api.get('/leads/' + id);
        const lead = res.data;
        const feeTotal = parseFloat(lead.fee_total) || 0;
        const actualRev = parseFloat(lead.actual_revenue) || 0;
        const remaining = Math.max(0, feeTotal - actualRev);
        if (remaining <= 0) { ui.info('Đã đóng đủ!'); return; }
        document.getElementById('paymentLeadId').value = id;
        document.getElementById('paymentStudentId').value = lead.converted_student_id || '';
        document.getElementById('paymentRemainingRaw').value = remaining;
        document.getElementById('paymentStudentName').textContent = lead.student_name || '';
        document.getElementById('paymentStudentCode').textContent = 'Mã: ' + (lead.converted_student_code || lead.code || '');
        document.getElementById('paymentFeeTotal').textContent = formatCurrency(feeTotal);
        document.getElementById('paymentRemaining').textContent = formatCurrency(remaining);
        const transferDesc = (lead.converted_student_code || lead.code) + ' ' + (lead.student_name || '').substring(0, 15);
        document.getElementById('paymentTransferDesc').textContent = transferDesc;
        document.getElementById('paymentQRImage').src = getQRUrl(remaining, transferDesc);
        document.getElementById('btnConfirmLeadPayment').style.display = lead.converted_student_id ? 'block' : 'none';
        document.getElementById('paymentModal').classList.add('show');
      } catch (e) { ui.error(e.message); }
    }

    function closePaymentModal() { document.getElementById('paymentModal').classList.remove('show'); }

    async function confirmLeadPayment() {
      const studentId = document.getElementById('paymentStudentId').value;
      const remaining = parseFloat(document.getElementById('paymentRemainingRaw').value) || 0;
      if (!studentId || remaining <= 0) return;
      if (!confirm('Xác nhận đã nhận được ' + formatCurrency(remaining) + '?')) return;
      try {
        await api.post('/students/' + studentId + '/confirm-payment', { amount: remaining, paymentMethod: 'bank_transfer', note: 'Thanh toán qua QR' });
        ui.success('Đã ghi nhận thanh toán');
        closePaymentModal(); loadStats(); loadData();
      } catch (e) { ui.error(e.message); }
    }

    // Call Modal
    let callTimer = null, callSeconds = 0;
    function openCallModal(id, name, phone) {
      document.getElementById('callLeadId').value = id;
      document.getElementById('callName').textContent = name;
      document.getElementById('callPhone').textContent = phone;
      document.getElementById('callAvatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('callStatus').textContent = 'Sẵn sàng';
      document.getElementById('callStatus').className = 'call-status';
      document.getElementById('callTimer').style.display = 'none';
      document.getElementById('startCallBtn').style.display = 'inline-flex';
      document.getElementById('hangupBtn').style.display = 'none';
      document.getElementById('callNote').value = '';
      document.getElementById('callResult').value = '';
      loadCallHistory(id);
      document.getElementById('callModal').classList.add('show');
    }
    function closeCallModal() { document.getElementById('callModal').classList.remove('show'); if (callTimer) { clearInterval(callTimer); callTimer = null; } }
    function startCall() {
      const phone = document.getElementById('callPhone').textContent;
      document.getElementById('callStatus').textContent = 'Đang gọi...';
      document.getElementById('callStatus').className = 'call-status connecting';
      document.getElementById('startCallBtn').style.display = 'none';
      document.getElementById('hangupBtn').style.display = 'inline-flex';
      document.getElementById('callTimer').style.display = 'block';
      callSeconds = 0; document.getElementById('callTimer').textContent = '00:00';
      callTimer = setInterval(() => { callSeconds++; document.getElementById('callTimer').textContent = Math.floor(callSeconds / 60).toString().padStart(2, '0') + ':' + (callSeconds % 60).toString().padStart(2, '0'); }, 1000);
      window.open('tel:' + phone, '_self');
    }
    function endCall() {
      if (callTimer) { clearInterval(callTimer); callTimer = null; }
      document.getElementById('callStatus').textContent = 'Kết thúc';
      document.getElementById('callStatus').className = 'call-status ended';
      document.getElementById('startCallBtn').style.display = 'inline-flex';
      document.getElementById('hangupBtn').style.display = 'none';
    }
    async function saveCallNote() {
      const id = document.getElementById('callLeadId').value;
      const note = document.getElementById('callNote').value;
      const result = document.getElementById('callResult').value;
      if (!note && !result) { ui.warning('Nhập ghi chú hoặc kết quả'); return; }
      try {
        await api.post('/leads/' + id + '/call-log', { duration: callSeconds, result, note, called_at: new Date().toISOString() });
        ui.success('Đã lưu');
        document.getElementById('callNote').value = '';
        document.getElementById('callResult').value = '';
        callSeconds = 0;
        loadCallHistory(id);
      } catch (e) { ui.error(e.message); }
    }
    async function loadCallHistory(id) {
      const c = document.getElementById('callHistory');
      try {
        const res = await api.get('/leads/' + id + '/call-logs');
        const logs = res.data || [];
        if (!logs.length) { c.innerHTML = '<p class="text-muted text-center">Chưa có</p>'; return; }
        const lbl = { answered: 'Đã nghe', no_answer: 'Không nghe', busy: 'Máy bận', interested: 'Quan tâm', callback: 'Gọi lại' };
        c.innerHTML = logs.map(l => '<div class="call-history-item"><div style="display:flex;justify-content:space-between"><span style="font-size:11px;color:var(--text-muted)">' + formatDate(l.called_at) + '</span></div>' + (l.result ? '<span class="badge badge-info">' + (lbl[l.result] || l.result) + '</span>' : '') + (l.note ? '<div style="font-size:12px;margin-top:4px">' + l.note + '</div>' : '') + '</div>').join('');
      } catch (e) { c.innerHTML = '<p class="text-muted">Lỗi</p>'; }
    }

    function formatDate(d) { return d ? new Date(d).toLocaleDateString('vi-VN') : '-'; }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>