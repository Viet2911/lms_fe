<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lịch trải nghiệm - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* Calendar Grid */
    .calendar-wrapper {
      background: var(--bg-card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .calendar-title {
      font-size: 18px;
      font-weight: 600;
      min-width: 180px;
      text-align: center;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }

    .calendar-weekday {
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-muted);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .calendar-day {
      min-height: 120px;
      padding: 8px;
      border-right: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-day:nth-child(7n) {
      border-right: none;
    }

    .calendar-day:hover {
      background: var(--bg-hover);
    }

    .calendar-day.other-month {
      background: var(--bg-secondary);
      opacity: 0.5;
    }

    .calendar-day.today {
      background: #eff6ff;
    }

    .calendar-day.today .day-number {
      background: var(--primary-color);
      color: white;
    }

    .day-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    /* Trial Session Events */
    .trial-event {
      padding: 4px 8px;
      margin-bottom: 4px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .trial-event:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .trial-event .session-badge {
      background: rgba(255, 255, 255, 0.3);
      padding: 1px 6px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 10px;
    }

    /* Session colors */
    .trial-event.session-1 {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }

    .trial-event.session-2 {
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
      color: white;
    }

    .trial-event.session-3 {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .trial-event.completed {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .trial-event.waiting {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      color: white;
    }

    /* Cyan - chờ đặt lịch tiếp */
    .trial-event.no-show {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      opacity: 0.7;
    }

    .trial-event.converted {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .calendar-more {
      font-size: 11px;
      color: var(--primary-color);
      cursor: pointer;
      padding: 2px 8px;
    }

    /* Legend */
    .calendar-legend {
      display: flex;
      gap: 16px;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    /* Stats cards */
    .trial-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .trial-stat {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .trial-stat .value {
      font-size: 28px;
      font-weight: 700;
    }

    .trial-stat .label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .trial-stat.blue .value {
      color: #3b82f6;
    }

    .trial-stat.purple .value {
      color: #8b5cf6;
    }

    .trial-stat.orange .value {
      color: #f59e0b;
    }

    .trial-stat.green .value {
      color: #22c55e;
    }

    /* Session detail card */
    .session-detail {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .session-detail h4 {
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .session-timeline {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .session-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      color: white;
    }

    .session-dot.done {
      background: #22c55e;
    }

    .session-dot.current {
      background: #3b82f6;
      animation: pulse 2s infinite;
    }

    .session-dot.pending {
      background: #d1d5db;
      color: #6b7280;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }
    }

    /* Form styles */
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
  </style>
</head>

<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i
              class="fas fa-bars"></i></button>
          <div>
            <h1 class="page-title">Lịch trải nghiệm</h1>
            <p class="page-subtitle">Theo dõi lịch học thử của khách hàng</p>
          </div>
        </div>
        <div class="header-right">
          <button class="theme-toggle" onclick="theme.toggle()" title="Đổi giao diện"><i class="fas fa-moon"></i><i
              class="fas fa-sun"></i></button>
          <div class="user-menu" onclick="auth.logout()">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
              <div class="user-name" id="userName">User</div>
              <div class="user-role" id="userRole">Role</div>
            </div>
          </div>
        </div>
      </header>

      <div class="page-content">
        <!-- Stats -->
        <div class="trial-stats" id="statsGrid"></div>

        <!-- Calendar -->
        <div class="calendar-wrapper">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)"><i
                  class="fas fa-chevron-left"></i></button>
              <span class="calendar-title" id="calendarTitle">Tháng 12, 2025</span>
              <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)"><i
                  class="fas fa-chevron-right"></i></button>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-secondary btn-sm" onclick="goToday()"><i class="fas fa-calendar-day"></i> Hôm
                nay</button>
            </div>
          </div>
          <div class="calendar-grid" id="calendarGrid"></div>
          <div class="calendar-legend">
            <div class="legend-item">
              <div class="legend-color" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);"></div> Buổi 1
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:linear-gradient(135deg, #8b5cf6, #6d28d9);"></div> Buổi 2
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:linear-gradient(135deg, #f59e0b, #d97706);"></div> Buổi 3
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:linear-gradient(135deg, #06b6d4, #0891b2);"></div> Chờ đặt
              lịch
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:linear-gradient(135deg, #22c55e, #16a34a);"></div> Hoàn thành
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:linear-gradient(135deg, #10b981, #059669);"></div> Đã chuyển
              đổi
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:linear-gradient(135deg, #ef4444, #dc2626);"></div> Không đến
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- View/Action Modal -->
  <div class="modal-overlay" id="viewModal">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="viewModalTitle"><i class="fas fa-user-clock"></i> Chi tiết buổi học thử</h3>
        <button class="modal-close" onclick="modal.hide('viewModal')">&times;</button>
      </div>
      <div class="modal-body" id="viewContent"></div>
      <div class="modal-footer" id="viewFooter"></div>
    </div>
  </div>

  <!-- Schedule Next Session Modal -->
  <div class="modal-overlay" id="scheduleModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-calendar-plus"></i> Đặt lịch buổi tiếp theo</h3>
        <button class="modal-close" onclick="modal.hide('scheduleModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="scheduleLeadId">
        <input type="hidden" id="scheduleSessionNum">

        <div class="session-detail" id="scheduleInfo"></div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label required">Ngày học</label>
            <input type="date" id="scheduleDate" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label required">Giờ học</label>
            <input type="time" id="scheduleTime" class="form-control" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Lớp học</label>
          <select id="scheduleClass" class="form-control">
            <option value="">Chọn lớp (nếu có)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Ghi chú</label>
          <textarea id="scheduleNote" class="form-control" rows="2" placeholder="Ghi chú đặc biệt..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="modal.hide('scheduleModal')">Hủy</button>
        <button class="btn btn-primary" onclick="saveSchedule()"><i class="fas fa-save"></i> Lưu lịch</button>
      </div>
    </div>
  </div>

  <!-- Convert to Student Modal - Full Form -->
  <div class="modal-overlay" id="convertModal">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-header" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white;">
        <h3 class="modal-title"><i class="fas fa-user-graduate"></i> Chuyển đổi thành học sinh</h3>
        <button class="modal-close" onclick="modal.hide('convertModal')" style="color:white;">&times;</button>
      </div>
      <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
        <input type="hidden" id="convertLeadId">

        <!-- Lead Info Summary -->
        <div class="session-detail" id="convertInfo" style="background:#dcfce7; margin-bottom: 20px;"></div>

        <!-- PHẦN 1: THÔNG TIN HỌC SINH -->
        <div
          style="background:linear-gradient(135deg,#dbeafe,#e0e7ff);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#1e40af"><i class="fas fa-child"></i> Thông tin Học sinh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="form-label required">Họ tên học sinh</label>
              <input type="text" id="cvStudentName" class="form-control" placeholder="Nguyễn Văn A">
            </div>
            <div class="form-group">
              <label class="form-label">Năm sinh</label>
              <input type="number" id="cvStudentBirthYear" class="form-control" placeholder="2015" min="2000"
                max="2025">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="form-label">Địa chỉ</label>
              <input type="text" id="cvStudentAddress" class="form-control" placeholder="Số nhà, đường, quận/huyện">
            </div>
            <div class="form-group">
              <label class="form-label">Trường học hiện tại</label>
              <input type="text" id="cvStudentSchool" class="form-control" placeholder="THCS ABC">
            </div>
          </div>
        </div>

        <!-- PHẦN 2: THÔNG TIN PHỤ HUYNH -->
        <div
          style="background:linear-gradient(135deg,#fef3c7,#fde68a);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#92400e"><i class="fas fa-users"></i> Thông tin Phụ huynh</h4>
          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="form-label required">Họ tên phụ huynh</label>
              <input type="text" id="cvParentName" class="form-control" placeholder="Nguyễn Văn B">
            </div>
            <div class="form-group">
              <label class="form-label required">Số điện thoại</label>
              <input type="tel" id="cvParentPhone" class="form-control" placeholder="0901234567">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Nghề nghiệp</label>
            <input type="text" id="cvParentJob" class="form-control" placeholder="Kỹ sư, Giáo viên, Kinh doanh...">
          </div>
        </div>

        <!-- PHẦN 3: THÔNG TIN KHÓA HỌC -->
        <div
          style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#166534"><i class="fas fa-book"></i> Thông tin Khóa học</h4>

          <div class="form-row">
            <div class="form-group" style="flex:2">
              <label class="form-label required">Gói học phí (Khóa học)</label>
              <select id="cvTuitionPackage" class="form-control" onchange="onPackageChange()">
                <option value="">-- Chọn gói học phí --</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Học phí gốc</label>
              <input type="text" id="cvFeeOriginal" class="form-control" value="0đ" readonly
                style="background:#f3f4f6;font-weight:bold">
            </div>
          </div>

          <!-- Chương trình giảm giá -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#16a34a;font-weight:600"><i class="fas fa-percent"></i> Chương trình giảm giá</label>
            <div class="form-row" style="margin-top:8px">
              <div class="form-group" style="flex:2;margin-bottom:0">
                <select id="cvPromoProgram" class="form-control" onchange="applyPromoProgram()">
                  <option value="">-- Không áp dụng --</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <input type="text" id="cvPromoDiscount" class="form-control" value="0đ" readonly
                  style="background:#dcfce7;color:#16a34a;font-weight:bold;text-align:right">
              </div>
            </div>
            <div id="promoDiscountInfo" style="margin-top:8px;font-size:12px;color:#16a34a;display:none"></div>
          </div>

          <!-- Học bổng tặng kèm -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <label style="color:#2563eb;font-weight:600;margin:0"><i class="fas fa-graduation-cap"></i> Học bổng tặng
                kèm</label>
              <span id="cvDefaultScholarshipBadge"
                style="background:#dbeafe;color:#2563eb;padding:4px 10px;border-radius:12px;font-size:12px;display:none">
                Mặc định: <strong id="cvDefaultScholarshipMonths">0</strong> tháng
              </span>
            </div>
            <div class="form-row" style="align-items:center">
              <div class="form-group" style="margin-bottom:0;flex:1">
                <input type="number" id="cvScholarshipMonths" class="form-control" value="0" min="0" max="12"
                  onchange="onScholarshipChange()" style="font-size:18px;font-weight:bold;text-align:center">
              </div>
              <span style="padding:0 12px;color:#6b7280">tháng</span>
              <div class="form-group" style="margin-bottom:0;flex:2">
                <small id="cvScholarshipStatus" style="color:#16a34a;display:none">
                  <i class="fas fa-check-circle"></i> Trong mức mặc định
                </small>
              </div>
            </div>
            <div id="cvScholarshipWarning"
              style="margin-top:8px;padding:8px;background:#fef3c7;border-radius:6px;color:#92400e;font-size:12px;display:none">
              <i class="fas fa-exclamation-triangle"></i> Vượt mức mặc định, cần GDV duyệt
            </div>
          </div>

          <!-- Quà tặng -->
          <div style="background:white;padding:12px;border-radius:8px;margin:12px 0">
            <label style="color:#db2777;font-weight:600"><i class="fas fa-gift"></i> Quà tặng kèm</label>
            <div id="giftItemsContainer" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px"></div>
          </div>

          <!-- Tổng kết -->
          <div style="background:#1f2937;color:white;padding:16px;border-radius:8px;margin-top:12px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Khóa học chính:</span>
              <span id="cvMainCourseMonths">0 tháng</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Học bổng tặng:</span>
              <span id="cvBonusMonths" style="color:#4ade80">+0 tháng</span>
            </div>
            <div
              style="display:flex;justify-content:space-between;margin-bottom:12px;padding-top:8px;border-top:1px solid #374151">
              <span><strong>Tổng thời gian học:</strong></span>
              <span id="cvTotalMonths" style="font-size:18px;font-weight:bold;color:#4ade80">0 tháng</span>
            </div>
            <div
              style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid #374151">
              <span style="font-size:16px"><strong>HỌC PHÍ THỰC ĐÓNG:</strong></span>
              <span id="cvFeeTotal" style="font-size:24px;font-weight:bold;color:#fbbf24" data-raw-value="0">0đ</span>
            </div>
          </div>
        </div>

        <!-- PHẦN 4: THANH TOÁN -->
        <div
          style="background:linear-gradient(135deg,#fce7f3,#fbcfe8);padding:16px;border-radius:12px;margin-bottom:20px">
          <h4 style="margin:0 0 12px 0;color:#9d174d"><i class="fas fa-credit-card"></i> Thanh toán</h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Trạng thái</label>
              <select id="cvPaymentStatus" class="form-control" onchange="updatePaymentFields()">
                <option value="pending">Chưa đóng</option>
                <option value="deposit">Đặt cọc</option>
                <option value="partial">Đóng 1 phần</option>
                <option value="paid">Đã đóng đủ</option>
              </select>
            </div>
            <div class="form-group" id="depositGroup" style="display:none">
              <label class="form-label">Tiền cọc</label>
              <input type="text" id="cvDepositAmount" class="form-control currency-input" value="0đ"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
            <div class="form-group" id="paidGroup" style="display:none">
              <label class="form-label">Đã thanh toán</label>
              <input type="text" id="cvPaidAmount" class="form-control currency-input" value="0đ"
                oninput="formatCurrencyField(this);updateRemaining()">
            </div>
          </div>
          <div id="remainingRow" style="display:none;background:white;padding:12px;border-radius:8px;margin-top:8px">
            <div style="display:flex;justify-content:space-between">
              <span>Còn phải đóng:</span>
              <span id="cvRemaining" style="font-size:18px;font-weight:bold;color:#dc2626">0đ</span>
            </div>
          </div>
        </div>

        <!-- Ghi chú -->
        <div class="form-group">
          <label class="form-label">Ghi chú</label>
          <textarea id="cvNote" class="form-control" rows="2" placeholder="Ghi chú thêm..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="modal.hide('convertModal')">Hủy</button>
        <button class="btn btn-success" onclick="convertTrial()"><i class="fas fa-check"></i> Chuyển đổi</button>
      </div>
    </div>
  </div>

  <!-- Conversion Success Modal with QR -->
  <div class="modal-overlay" id="convertSuccessModal">
    <div class="modal-content" style="max-width:520px">
      <div class="modal-header" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white">
        <h3 class="modal-title"><i class="fas fa-check-circle"></i> Chuyển đổi thành công!</h3>
        <button class="modal-close" onclick="closeConvertSuccessModal()" style="color:white">&times;</button>
      </div>
      <div class="modal-body" style="padding:24px">
        <input type="hidden" id="newStudentId">
        <input type="hidden" id="successRemainingRaw" value="0">

        <div style="text-align:center;margin-bottom:20px">
          <i class="fas fa-user-graduate" style="font-size:48px;color:#22c55e;margin-bottom:12px"></i>
          <h3 style="margin:0;color:#166534" id="successStudentName">Học sinh mới</h3>
          <p style="color:#6b7280;margin:4px 0" id="successStudentCode">Mã: ---</p>
        </div>

        <!-- Payment Section -->
        <div id="successPaymentSection" style="display:none">
          <!-- Payment Info -->
          <div style="display:flex;gap:12px;margin-bottom:16px">
            <div style="flex:1;background:#dcfce7;padding:12px;border-radius:8px;text-align:center">
              <div style="color:#166534;font-size:12px">Học phí</div>
              <div style="color:#15803d;font-size:18px;font-weight:700" id="successFeeTotal">0đ</div>
            </div>
            <div style="flex:1;background:#fee2e2;padding:12px;border-radius:8px;text-align:center"
              id="successRemainingBox">
              <div style="color:#991b1b;font-size:12px" id="successPaymentLabel">Cần thanh toán</div>
              <div style="color:#dc2626;font-size:18px;font-weight:700" id="successRemainingAmount">0đ</div>
            </div>
          </div>

          <!-- Payment Method Selection -->
          <div style="margin-bottom:16px">
            <label style="font-weight:600;margin-bottom:8px;display:block">Phương thức thanh toán:</label>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
              <button type="button" class="payment-method-btn active" data-method="bank_transfer"
                onclick="selectPaymentMethod('bank_transfer')">
                <i class="fas fa-qrcode"></i> Chuyển khoản/QR
              </button>
              <button type="button" class="payment-method-btn" data-method="cash" onclick="selectPaymentMethod('cash')">
                <i class="fas fa-money-bill-wave"></i> Tiền mặt
              </button>
              <button type="button" class="payment-method-btn" data-method="card" onclick="selectPaymentMethod('card')">
                <i class="fas fa-credit-card"></i> Quẹt thẻ
              </button>
              <button type="button" class="payment-method-btn" data-method="installment"
                onclick="selectPaymentMethod('installment')">
                <i class="fas fa-calendar-alt"></i> Trả góp
              </button>
            </div>
          </div>

          <!-- QR Code Section (for bank_transfer) -->
          <div id="qrCodeSection" style="text-align:center;margin-bottom:16px">
            <div style="background:#f9fafb;padding:16px;border-radius:12px">
              <img id="successQRImage" src="" alt="QR Code" style="max-width:200px;border-radius:8px">
              <div style="margin-top:12px;background:#e0e7ff;padding:8px;border-radius:8px">
                <div style="font-size:11px;color:#4338ca">Nội dung CK:</div>
                <div style="font-weight:600;color:#3730a3;font-size:13px" id="successPaymentDesc">---</div>
              </div>
            </div>
          </div>

          <!-- Proof Upload Section (for cash, card, installment) -->
          <div id="proofUploadSection" style="display:none;margin-bottom:16px">
            <label style="font-weight:600;margin-bottom:8px;display:block">
              <i class="fas fa-camera"></i> Ảnh minh chứng thanh toán:
            </label>
            <div
              style="border:2px dashed #d1d5db;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s"
              onclick="document.getElementById('proofFileInput').click()" id="proofDropZone">
              <input type="file" id="proofFileInput" accept="image/*" style="display:none"
                onchange="handleProofUpload(this)">
              <div id="proofPreview" style="display:none">
                <img id="proofPreviewImg" src="" style="max-width:100%;max-height:200px;border-radius:8px">
                <p style="margin:8px 0 0;color:#22c55e;font-size:13px"><i class="fas fa-check"></i> Đã chọn ảnh</p>
              </div>
              <div id="proofPlaceholder">
                <i class="fas fa-cloud-upload-alt" style="font-size:32px;color:#9ca3af;margin-bottom:8px"></i>
                <p style="margin:0;color:#6b7280;font-size:13px">Nhấn để chọn ảnh biên lai/hóa đơn</p>
                <p style="margin:4px 0 0;color:#9ca3af;font-size:11px">Hỗ trợ: JPG, PNG (tối đa 5MB)</p>
              </div>
            </div>
          </div>

          <!-- Note -->
          <div style="margin-bottom:16px">
            <label style="font-weight:500;margin-bottom:6px;display:block;font-size:13px">Ghi chú:</label>
            <input type="text" id="paymentNote" class="form-control"
              placeholder="VD: Mẹ bé chuyển khoản, Thanh toán đợt 1...">
          </div>

          <!-- Confirm Button -->
          <button class="btn btn-success" onclick="confirmPaymentReceived()"
            style="width:100%;padding:14px;font-size:16px">
            <i class="fas fa-check-double"></i> Xác nhận đã nhận thanh toán
          </button>
          <p style="color:#6b7280;font-size:12px;margin-top:8px;text-align:center">Bấm sau khi đã nhận được tiền từ phụ
            huynh</p>
        </div>

        <!-- Full paid message -->
        <div id="successFullPaidSection" style="display:none;padding:20px;text-align:center">
          <i class="fas fa-check-double" style="font-size:48px;color:#22c55e;margin-bottom:12px"></i>
          <p style="color:#166534;font-weight:600">Đã thanh toán đầy đủ!</p>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:center;gap:12px">
        <button class="btn btn-primary" onclick="downloadEnrollmentFormFromSuccess()">
          <i class="fas fa-file-word"></i> Xuất đơn nhập học
        </button>
        <button class="btn btn-secondary" onclick="closeConvertSuccessModal()">Đóng</button>
      </div>
    </div>
  </div>

  <style>
    .payment-method-btn {
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .payment-method-btn:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .payment-method-btn.active {
      border-color: #3b82f6;
      background: #dbeafe;
      color: #1d4ed8;
      font-weight: 600;
    }

    #proofDropZone:hover {
      border-color: #3b82f6;
      background: #f9fafb;
    }
  </style>

  <!-- Mark Attendance Modal -->
  <div class="modal-overlay" id="attendanceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-clipboard-check"></i> Điểm danh buổi học thử</h3>
        <button class="modal-close" onclick="modal.hide('attendanceModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="attendanceLeadId">
        <input type="hidden" id="attendanceSessionId">

        <div class="session-detail" id="attendanceInfo"></div>

        <div class="form-group">
          <label class="form-label required">Trạng thái</label>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <label class="branch-checkbox" style="flex:1; min-width:120px;">
              <input type="radio" name="attendanceStatus" value="attended" checked>
              <i class="fas fa-check" style="color:#22c55e;"></i>
              <span>Có mặt</span>
            </label>
            <label class="branch-checkbox" style="flex:1; min-width:120px;">
              <input type="radio" name="attendanceStatus" value="no_show">
              <i class="fas fa-times" style="color:#ef4444;"></i>
              <span>Không đến</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Đánh giá (1-5)</label>
          <div style="display:flex; gap:8px;" id="ratingStars">
            <i class="fas fa-star rating-star" data-value="1" onclick="setRating(1)"></i>
            <i class="fas fa-star rating-star" data-value="2" onclick="setRating(2)"></i>
            <i class="fas fa-star rating-star" data-value="3" onclick="setRating(3)"></i>
            <i class="fas fa-star rating-star" data-value="4" onclick="setRating(4)"></i>
            <i class="fas fa-star rating-star" data-value="5" onclick="setRating(5)"></i>
          </div>
          <input type="hidden" id="attendanceRating" value="0">
        </div>

        <div class="form-group">
          <label class="form-label">Nhận xét</label>
          <textarea id="attendanceFeedback" class="form-control" rows="2"
            placeholder="Nhận xét về buổi học..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="modal.hide('attendanceModal')">Hủy</button>
        <button class="btn btn-primary" onclick="saveAttendance()"><i class="fas fa-save"></i> Lưu</button>
      </div>
    </div>
  </div>

  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/sidebar.js"></script>
  <script>
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;
    let trialSessions = [];
    let classes = [];
    let currentRating = 0;

    async function init() {
      if (!auth.checkAuth()) return;
      buildSidebar('sidebar');
      await loadClasses();
      await loadStats();
      await loadCalendar();
    }

    async function loadClasses() {
      try {
        const result = await api.get('/classes?status=active&limit=100');
        classes = result.data || [];

        const classOptions = '<option value="">Chọn lớp</option>' +
          classes.map(c => `<option value="${c.id}">${c.class_name} - ${c.subject_name || ''} (${c.study_days || ''})</option>`).join('');

        const scheduleClassEl = document.getElementById('scheduleClass');
        if (scheduleClassEl) scheduleClassEl.innerHTML = classOptions;
      } catch (e) { console.error(e); }
    }

    async function loadStats() {
      try {
        const query = branch.buildQuery({});
        const result = await api.get('/leads/stats' + query);
        const s = result.data || {};

        document.getElementById('statsGrid').innerHTML = `
          <div class="trial-stat blue">
            <div class="value">${s.scheduled || 0}</div>
            <div class="label">Chờ TN</div>
          </div>
          <div class="trial-stat" style="border-left: 4px solid #06b6d4;">
            <div class="value" style="color: #06b6d4;">${s.waiting || 0}</div>
            <div class="label">Chờ tiếp theo</div>
          </div>
          <div class="trial-stat purple">
            <div class="value">${s.trial || 0}</div>
            <div class="label">Đang học thử</div>
          </div>
          <div class="trial-stat green">
            <div class="value">${s.converted || 0}</div>
            <div class="label">Đã chuyển đổi</div>
          </div>
        `;
      } catch (e) { console.error(e); }
    }

    async function loadCalendar() {
      document.getElementById('calendarTitle').textContent = `Tháng ${currentMonth}, ${currentYear}`;

      try {
        const query = branch.buildQuery({ year: currentYear, month: currentMonth });
        const result = await api.get('/leads/month' + query);
        trialSessions = result.data || [];
      } catch (e) { trialSessions = []; }

      renderCalendar();
    }

    function renderCalendar() {
      const firstDay = new Date(currentYear, currentMonth - 1, 1);
      const lastDay = new Date(currentYear, currentMonth, 0);
      const startDay = firstDay.getDay() || 7;
      const totalDays = lastDay.getDate();
      const today = new Date();

      let html = `
        <div class="calendar-weekday">T2</div>
        <div class="calendar-weekday">T3</div>
        <div class="calendar-weekday">T4</div>
        <div class="calendar-weekday">T5</div>
        <div class="calendar-weekday">T6</div>
        <div class="calendar-weekday">T7</div>
        <div class="calendar-weekday">CN</div>
      `;

      // Previous month days
      const prevMonth = new Date(currentYear, currentMonth - 1, 0);
      for (let i = startDay - 1; i > 0; i--) {
        html += `<div class="calendar-day other-month"><div class="day-number">${prevMonth.getDate() - i + 1}</div></div>`;
      }

      // Current month days
      for (let d = 1; d <= totalDays; d++) {
        const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const isToday = today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth && today.getDate() === d;
        const daySessions = trialSessions.filter(s => s.scheduled_date?.substring(0, 10) === dateStr);

        // Sort by time (sáng tới tối)
        const sortedSessions = daySessions.sort((a, b) => {
          const timeA = a.scheduled_time || '99:99';
          const timeB = b.scheduled_time || '99:99';
          return timeA.localeCompare(timeB);
        });

        let eventsHtml = sortedSessions.slice(0, 4).map(s => {
          const sessionNum = (s.trial_sessions_attended || 0) + 1;
          let statusClass = `session-${Math.min(sessionNum, 3)}`;
          let badgeText = `B${sessionNum}`;

          if (s.status === 'converted') {
            statusClass = 'converted';
            badgeText = '✓';
          } else if (s.status === 'no_show') {
            statusClass = 'no-show';
            badgeText = '✗';
          } else if (s.status === 'waiting') {
            statusClass = 'waiting';
            badgeText = `✓B${s.trial_sessions_attended || 1}`;
          } else if (s.status === 'attended' && !s.scheduled_date) {
            statusClass = 'waiting';
            badgeText = `✓B${s.trial_sessions_attended || 1}`;
          }

          const branchCode = s.branch_code || '';
          const timeStr = s.scheduled_time ? s.scheduled_time.substring(0, 5) : '';

          return `
            <div class="trial-event ${statusClass}" onclick="viewSession(${s.id}); event.stopPropagation();">
              ${timeStr ? `<span style="font-size:10px;opacity:0.9;margin-right:4px;">${timeStr}</span>` : ''}
              <span class="session-badge">${badgeText}</span>
              <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;">${s.student_name}</span>
              ${branchCode ? `<span style="font-size:9px;opacity:0.8;">${branchCode}</span>` : ''}
            </div>
          `;
        }).join('');

        if (sortedSessions.length > 4) {
          eventsHtml += `<div class="calendar-more" onclick="showDayDetail('${dateStr}'); event.stopPropagation();">+${sortedSessions.length - 4} khác</div>`;
        }

        html += `
          <div class="calendar-day ${isToday ? 'today' : ''}">
            <div class="day-number">${d}</div>
            <div class="calendar-events">${eventsHtml}</div>
          </div>
        `;
      }

      // Next month days
      const remaining = (7 - (startDay - 1 + totalDays) % 7) % 7;
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
      }

      document.getElementById('calendarGrid').innerHTML = html;
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth > 12) { currentMonth = 1; currentYear++; }
      if (currentMonth < 1) { currentMonth = 12; currentYear--; }
      loadCalendar();
    }

    function goToday() {
      const now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth() + 1;
      loadCalendar();
    }

    async function viewSession(leadId) {
      try {
        const result = await api.get(`/leads/${leadId}`);
        const l = result.data;

        const sessionNum = (l.trial_sessions_attended || 0) + 1;
        const maxSessions = l.trial_sessions_max || 3;
        const completedSessions = l.trial_sessions_attended || 0;

        // Build session timeline
        let timelineHtml = '';
        for (let i = 1; i <= maxSessions; i++) {
          let dotClass = 'pending';
          if (i <= completedSessions) dotClass = 'done';
          else if (i === sessionNum && (l.status === 'trial' || l.status === 'scheduled')) dotClass = 'current';
          timelineHtml += `<div class="session-dot ${dotClass}">${i}</div>`;
        }

        // Status display
        const statusMap = {
          'new': { text: 'Mới', class: 'secondary' },
          'scheduled': { text: 'Chờ TN', class: 'warning' },
          'attended': { text: 'Đã TN', class: 'info' },
          'waiting': { text: 'Chờ tiếp theo', class: 'warning', icon: 'fa-clock' },
          'trial': { text: 'Đang học thử', class: 'info' },
          'converted': { text: 'Đã chuyển đổi', class: 'success' },
          'cancelled': { text: 'Đã hủy', class: 'danger' },
          'no_show': { text: 'Không đến', class: 'danger' }
        };
        const statusInfo = statusMap[l.status] || statusMap.new;

        // Waiting status notice
        let waitingNotice = '';
        if (l.status === 'waiting') {
          waitingNotice = `
            <div style="background: #fef3c7; padding: 12px 16px; border-radius: 8px; margin-top: 16px; border-left: 4px solid #f59e0b;">
              <i class="fas fa-clock" style="color: #f59e0b;"></i>
              <span style="font-size: 13px; color: #92400e;">
                <strong>Đang chờ:</strong> Đã hoàn thành ${completedSessions} buổi. 
                Vui lòng đặt lịch buổi tiếp hoặc chuyển đổi thành học viên.
              </span>
            </div>
          `;
        }

        document.getElementById('viewContent').innerHTML = `
          <div class="session-detail">
            <h4>
              <i class="fas fa-user"></i> ${l.student_name}
              <span class="badge badge-${statusInfo.class}" style="margin-left:auto;">
                ${statusInfo.icon ? `<i class="fas ${statusInfo.icon}"></i> ` : ''}${statusInfo.text}
              </span>
            </h4>
            <div class="detail-grid" style="margin-top:12px;">
              <div class="detail-item"><label>Mã</label><span><code>${l.code}</code> <span class="branch-tag-sm">${l.branch_code || ''}</span></span></div>
              <div class="detail-item"><label>Phụ huynh</label><span>${l.customer_name} - <a href="tel:${l.customer_phone}">${l.customer_phone}</a></span></div>
              <div class="detail-item"><label>Môn</label><span>${l.subject_name || '-'}</span></div>
              <div class="detail-item"><label>Nguồn</label><span>${l.source || '-'}</span></div>
              ${l.trial_class_name ? `<div class="detail-item"><label>Lớp</label><span>${l.trial_class_name}</span></div>` : ''}
              ${l.scheduled_date ? `<div class="detail-item"><label><i class="fas fa-calendar"></i> Ngày</label><span>${ui.formatDate(l.scheduled_date)}</span></div>` : ''}
              ${l.scheduled_time ? `<div class="detail-item"><label><i class="fas fa-clock"></i> Giờ</label><span><strong>${l.scheduled_time?.substring(0, 5)}</strong></span></div>` : ''}
            </div>
            
            <div style="margin-top:16px;">
              <label style="font-size:13px;color:var(--text-muted);margin-bottom:8px;display:block;">Tiến độ học thử</label>
              <div class="session-timeline">${timelineHtml}</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:8px;">
                Đã hoàn thành: <strong>${completedSessions}</strong> / ${maxSessions} buổi
              </div>
            </div>
            
            ${waitingNotice}
            
            ${l.note ? `<div style="margin-top:12px;padding:10px;background:var(--bg-primary);border-radius:6px;font-size:13px;"><i class="fas fa-sticky-note" style="color:var(--text-muted);"></i> ${l.note}</div>` : ''}
          </div>
        `;

        // Footer buttons based on status and completed sessions
        let footerHtml = '<button class="btn btn-secondary" onclick="modal.hide(\'viewModal\')">Đóng</button>';

        if (l.status === 'scheduled' || l.status === 'new') {
          // Chưa trải nghiệm - Buổi 1
          footerHtml += `
            <button class="btn btn-danger" onclick="markCancelled(${l.id})"><i class="fas fa-times"></i> Hủy</button>
            <button class="btn btn-warning" onclick="markNoShow(${l.id})"><i class="fas fa-user-slash"></i> K.đến</button>
            <button class="btn btn-success" onclick="markSessionComplete(${l.id}, 1)"><i class="fas fa-check"></i> Hoàn thành B1</button>
          `;
        } else if (l.status === 'waiting') {
          // Đã hoàn thành buổi, chờ quyết định tiếp theo
          const nextSession = completedSessions + 1;
          footerHtml += `
            <button class="btn btn-primary" onclick="openSchedule(${l.id}, ${nextSession})"><i class="fas fa-calendar-plus"></i> Đặt lịch B${Math.min(nextSession, maxSessions)}</button>
            <button class="btn btn-success" onclick="openConvert(${l.id})"><i class="fas fa-user-graduate"></i> Chuyển đổi</button>
          `;
        } else if (l.status === 'trial') {
          // Đang trong quá trình học thử (đã có lịch)
          const nextSession = completedSessions + 1;

          if (nextSession <= maxSessions) {
            footerHtml += `
              <button class="btn btn-warning" onclick="markNoShow(${l.id})"><i class="fas fa-user-slash"></i> K.đến</button>
              <button class="btn btn-success" onclick="markSessionComplete(${l.id}, ${nextSession})"><i class="fas fa-check"></i> Hoàn thành B${nextSession}</button>
            `;
          }

          if (completedSessions >= 1) {
            footerHtml += `
              <button class="btn btn-primary" onclick="openConvert(${l.id})"><i class="fas fa-user-graduate"></i> Chuyển đổi</button>
            `;
          }
        } else if (l.status === 'converted') {
          footerHtml += `<span class="badge badge-success" style="padding: 10px 16px;"><i class="fas fa-check-circle"></i> Đã chuyển đổi thành học viên</span>`;
        }

        document.getElementById('viewFooter').innerHTML = footerHtml;
        modal.show('viewModal');
      } catch (e) { ui.error(e.message); }
    }

    // Đánh dấu hoàn thành buổi học
    async function markSessionComplete(leadId, sessionNum) {
      if (!confirm(`Xác nhận hoàn thành Buổi ${sessionNum}?`)) return;

      try {
        await api.post(`/leads/${leadId}/complete-session`, { sessionNum });
        ui.success(`Đã hoàn thành Buổi ${sessionNum}`);
        modal.hide('viewModal');
        loadCalendar();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    // Đánh dấu hủy
    async function markCancelled(leadId) {
      if (!confirm('Xác nhận hủy lịch này?')) return;
      try {
        await api.put(`/leads/${leadId}`, { status: 'cancelled' });
        ui.success('Đã hủy');
        modal.hide('viewModal');
        loadCalendar();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    // Đánh dấu không đến
    async function markNoShow(leadId) {
      if (!confirm('Xác nhận không đến?')) return;
      try {
        await api.post(`/leads/${leadId}/no-show`);
        ui.success('Đã đánh dấu không đến');
        modal.hide('viewModal');
        loadCalendar();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    function openSchedule(leadId, sessionNum) {
      document.getElementById('scheduleLeadId').value = leadId;
      document.getElementById('scheduleSessionNum').value = sessionNum;

      const lead = trialSessions.find(s => s.id === leadId);
      document.getElementById('scheduleInfo').innerHTML = `
        <h4><i class="fas fa-user"></i> ${lead?.student_name || ''}</h4>
        <p style="margin:0;color:var(--text-muted);">Đặt lịch <strong>Buổi ${sessionNum}</strong></p>
      `;

      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('scheduleTime').value = lead?.scheduled_time?.substring(0, 5) || '09:00';
      document.getElementById('scheduleNote').value = '';

      if (lead?.trial_class_id) {
        document.getElementById('scheduleClass').value = lead.trial_class_id;
      }

      modal.hide('viewModal');
      modal.show('scheduleModal');
    }

    async function saveSchedule() {
      const leadId = document.getElementById('scheduleLeadId').value;
      const date = document.getElementById('scheduleDate').value;
      const time = document.getElementById('scheduleTime').value;
      const classId = document.getElementById('scheduleClass').value;
      const note = document.getElementById('scheduleNote').value;

      if (!date || !time) {
        ui.error('Vui lòng chọn ngày và giờ');
        return;
      }

      try {
        const data = {
          scheduledDate: date,
          scheduledTime: time,
          status: 'trial'
        };
        if (classId) data.trialClassId = classId;
        if (note) data.note = note;

        await api.put(`/leads/${leadId}`, data);
        ui.success('Đã đặt lịch thành công');
        modal.hide('scheduleModal');
        loadCalendar();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    function openAttendance(leadId, sessionNum) {
      document.getElementById('attendanceLeadId').value = leadId;
      document.getElementById('attendanceSessionId').value = sessionNum;

      const lead = trialSessions.find(s => s.id === leadId);
      document.getElementById('attendanceInfo').innerHTML = `
        <h4><i class="fas fa-user"></i> ${lead?.student_name || ''}</h4>
        <p style="margin:0;color:var(--text-muted);">Điểm danh <strong>Buổi ${sessionNum}</strong> - ${ui.formatDate(lead?.scheduled_date)}</p>
      `;

      currentRating = 0;
      updateRatingStars();
      document.getElementById('attendanceFeedback').value = '';
      document.querySelector('input[name="attendanceStatus"][value="attended"]').checked = true;

      modal.hide('viewModal');
      modal.show('attendanceModal');
    }

    function setRating(value) {
      currentRating = value;
      document.getElementById('attendanceRating').value = value;
      updateRatingStars();
    }

    function updateRatingStars() {
      document.querySelectorAll('.rating-star').forEach((star, index) => {
        star.style.color = index < currentRating ? '#f59e0b' : '#d1d5db';
        star.style.cursor = 'pointer';
        star.style.fontSize = '24px';
      });
    }

    async function saveAttendance() {
      const leadId = document.getElementById('attendanceLeadId').value;
      const status = document.querySelector('input[name="attendanceStatus"]:checked').value;
      const rating = document.getElementById('attendanceRating').value;
      const feedback = document.getElementById('attendanceFeedback').value;

      try {
        if (status === 'attended') {
          await api.post(`/leads/${leadId}/attended`, { rating, feedback });
          ui.success('Đã điểm danh - Có mặt');
        } else {
          await api.post(`/leads/${leadId}/no-show`);
          ui.success('Đã điểm danh - Không đến');
        }

        modal.hide('attendanceModal');
        loadCalendar();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    async function openConvert(leadId) {
      document.getElementById('convertLeadId').value = leadId;

      const lead = trialSessions.find(s => s.id === leadId) || await api.get(`/leads/${leadId}`).then(r => r.data);

      // Fill lead info summary
      document.getElementById('convertInfo').innerHTML = `
        <h4 style="color:#15803d; margin:0;"><i class="fas fa-graduation-cap"></i> Chuyển đổi học viên</h4>
        <div style="margin-top:8px; display:flex; gap:20px; flex-wrap:wrap;">
          <span><strong>${lead?.student_name || lead.student_name}</strong></span>
          <span><i class="fas fa-phone"></i> ${lead?.customer_phone || lead.customer_phone}</span>
          <span><i class="fas fa-book"></i> ${lead?.subject_name || '-'}</span>
          <span>Đã học: ${lead?.trial_sessions_attended || 0} buổi</span>
        </div>
      `;

      // Pre-fill form from lead data
      document.getElementById('cvStudentName').value = lead?.student_name || '';
      document.getElementById('cvStudentBirthYear').value = lead?.student_birth_year || '';
      document.getElementById('cvParentName').value = lead?.customer_name || '';
      document.getElementById('cvParentPhone').value = lead?.customer_phone || '';
      document.getElementById('cvStudentAddress').value = '';
      document.getElementById('cvStudentSchool').value = '';
      document.getElementById('cvParentJob').value = '';
      document.getElementById('cvNote').value = '';

      // Reset payment fields
      document.getElementById('cvPaymentStatus').value = 'pending';
      document.getElementById('cvDepositAmount').value = '0đ';
      document.getElementById('cvPaidAmount').value = '0đ';
      document.getElementById('depositGroup').style.display = 'none';
      document.getElementById('paidGroup').style.display = 'none';
      document.getElementById('remainingRow').style.display = 'none';

      // Load tuition packages and promotions
      await loadConvertData(lead);

      modal.hide('viewModal');
      modal.show('convertModal');
    }

    let tuitionPackages = [];
    let promoPrograms = [];
    let giftItems = [];
    let defaultScholarshipMonths = 0;

    async function loadConvertData(lead) {
      try {
        const res = await api.get('/promotions/convert-data');
        console.log('Convert data API response:', res);

        // API trả về tuitionPackages, promotionPrograms, giftItems
        tuitionPackages = res.data?.tuitionPackages || res.data?.packages || res.tuitionPackages || res.packages || [];
        promoPrograms = res.data?.promotionPrograms || res.data?.programs || res.promotionPrograms || res.programs || [];
        giftItems = res.data?.giftItems || res.data?.items || res.giftItems || res.items || [];

        console.log('Packages loaded:', tuitionPackages);
        console.log('Programs loaded:', promoPrograms);
        console.log('Gifts loaded:', giftItems);

        // Populate tuition packages dropdown
        if (tuitionPackages.length === 0) {
          document.getElementById('cvTuitionPackage').innerHTML = '<option value="">-- Chưa có gói học phí --</option>';
          ui.warning('Chưa có gói học phí. Vui lòng tạo gói học phí trước.');
        } else {
          document.getElementById('cvTuitionPackage').innerHTML = '<option value="">-- Chọn gói học phí --</option>' +
            tuitionPackages.map(p => `<option value="${p.id}" data-price="${p.price}" data-months="${p.months}" data-sessions="${p.total_sessions || p.sessions_count}" data-scholarship="${p.default_scholarship_months || 0}">${p.name} - ${formatCurrency(p.price)}</option>`).join('');
        }

        // Populate promo programs dropdown
        document.getElementById('cvPromoProgram').innerHTML = '<option value="">-- Không áp dụng --</option>' +
          promoPrograms.map(p => `<option value="${p.id}" data-type="${p.discount_type}" data-value="${p.discount_value}">${p.name} (${p.discount_type === 'percent' ? p.discount_value + '%' : formatCurrency(p.discount_value)})</option>`).join('');

        // Populate gift items
        document.getElementById('giftItemsContainer').innerHTML = giftItems.length ?
          giftItems.map(g => `<label style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:#fce7f3;border-radius:6px;cursor:pointer"><input type="checkbox" class="gift-checkbox" data-id="${g.id}" data-name="${g.name}"> ${g.name} (${g.stock_quantity || 0})</label>`).join('') :
          '<span style="color:#9ca3af;font-size:13px">Chưa có quà tặng</span>';

        // Reset values
        document.getElementById('cvFeeOriginal').value = '0đ';
        document.getElementById('cvPromoDiscount').value = '0đ';
        document.getElementById('cvFeeTotal').textContent = '0đ';
        document.getElementById('cvFeeTotal').dataset.rawValue = '0';
        document.getElementById('cvScholarshipMonths').value = '0';
        document.getElementById('cvMainCourseMonths').textContent = '0 tháng';
        document.getElementById('cvBonusMonths').textContent = '+0 tháng';
        document.getElementById('cvTotalMonths').textContent = '0 tháng';
        defaultScholarshipMonths = 0;

      } catch (e) {
        console.error('Load convert data error:', e);
        ui.error('Lỗi tải dữ liệu chuyển đổi');
      }
    }

    function onPackageChange() {
      const select = document.getElementById('cvTuitionPackage');
      const option = select.options[select.selectedIndex];

      if (!option.value) {
        document.getElementById('cvFeeOriginal').value = '0đ';
        document.getElementById('cvMainCourseMonths').textContent = '0 tháng';
        defaultScholarshipMonths = 0;
        document.getElementById('cvDefaultScholarshipBadge').style.display = 'none';
        calculateTotal();
        return;
      }

      const price = parseInt(option.dataset.price) || 0;
      const months = parseInt(option.dataset.months) || 0;
      defaultScholarshipMonths = parseInt(option.dataset.scholarship) || 0;

      document.getElementById('cvFeeOriginal').value = formatCurrency(price) + 'đ';
      document.getElementById('cvMainCourseMonths').textContent = months + ' tháng';

      // Set default scholarship
      document.getElementById('cvScholarshipMonths').value = defaultScholarshipMonths;
      if (defaultScholarshipMonths > 0) {
        document.getElementById('cvDefaultScholarshipBadge').style.display = 'inline';
        document.getElementById('cvDefaultScholarshipMonths').textContent = defaultScholarshipMonths;
      } else {
        document.getElementById('cvDefaultScholarshipBadge').style.display = 'none';
      }

      onScholarshipChange();
      calculateTotal();
    }

    function applyPromoProgram() {
      calculateTotal();
    }

    function onScholarshipChange() {
      const months = parseInt(document.getElementById('cvScholarshipMonths').value) || 0;
      document.getElementById('cvBonusMonths').textContent = '+' + months + ' tháng';

      if (months > defaultScholarshipMonths && defaultScholarshipMonths > 0) {
        document.getElementById('cvScholarshipWarning').style.display = 'block';
        document.getElementById('cvScholarshipStatus').style.display = 'none';
      } else if (defaultScholarshipMonths > 0) {
        document.getElementById('cvScholarshipWarning').style.display = 'none';
        document.getElementById('cvScholarshipStatus').style.display = 'inline';
      } else {
        document.getElementById('cvScholarshipWarning').style.display = 'none';
        document.getElementById('cvScholarshipStatus').style.display = 'none';
      }

      // Update total months
      const packageSelect = document.getElementById('cvTuitionPackage');
      const packageOption = packageSelect.options[packageSelect.selectedIndex];
      const mainMonths = parseInt(packageOption?.dataset?.months) || 0;
      document.getElementById('cvTotalMonths').textContent = (mainMonths + months) + ' tháng';

      calculateTotal();
    }

    function calculateTotal() {
      const packageSelect = document.getElementById('cvTuitionPackage');
      const packageOption = packageSelect.options[packageSelect.selectedIndex];
      const price = parseInt(packageOption?.dataset?.price) || 0;

      const promoSelect = document.getElementById('cvPromoProgram');
      const promoOption = promoSelect.options[promoSelect.selectedIndex];
      const promoType = promoOption?.dataset?.type;
      const promoValue = parseFloat(promoOption?.dataset?.value) || 0;

      let discount = 0;
      if (promoType === 'percent') {
        discount = price * promoValue / 100;
      } else if (promoType === 'fixed') {
        discount = promoValue;
      }

      document.getElementById('cvPromoDiscount').value = discount > 0 ? '-' + formatCurrency(discount) + 'đ' : '0đ';

      const total = Math.max(0, price - discount);
      document.getElementById('cvFeeTotal').textContent = formatCurrency(total) + 'đ';
      document.getElementById('cvFeeTotal').dataset.rawValue = total;

      updateRemaining();
    }

    function updatePaymentFields() {
      const status = document.getElementById('cvPaymentStatus').value;
      document.getElementById('depositGroup').style.display = status === 'deposit' ? 'block' : 'none';
      document.getElementById('paidGroup').style.display = (status === 'partial' || status === 'paid') ? 'block' : 'none';

      if (status === 'paid') {
        const total = parseFloat(document.getElementById('cvFeeTotal').dataset.rawValue) || 0;
        document.getElementById('cvPaidAmount').value = formatCurrency(total) + 'đ';
      }

      updateRemaining();
    }

    function updateRemaining() {
      const total = parseFloat(document.getElementById('cvFeeTotal').dataset.rawValue) || 0;
      const deposit = parseCurrency(document.getElementById('cvDepositAmount').value);
      const paid = parseCurrency(document.getElementById('cvPaidAmount').value);
      const remaining = Math.max(0, total - deposit - paid);

      document.getElementById('cvRemaining').textContent = formatCurrency(remaining) + 'đ';
      document.getElementById('remainingRow').style.display = (deposit > 0 || paid > 0) ? 'block' : 'none';
    }

    function formatCurrency(v) {
      return v ? new Intl.NumberFormat('vi-VN').format(v) : '0';
    }

    function parseCurrency(str) {
      return parseInt(String(str).replace(/[^\d]/g, '')) || 0;
    }

    function formatCurrencyField(input) {
      const val = parseCurrency(input.value);
      input.value = val > 0 ? formatCurrency(val) + 'đ' : '0đ';
    }

    async function convertTrial() {
      const id = document.getElementById('convertLeadId').value;

      const studentName = document.getElementById('cvStudentName').value.trim();
      const studentBirthYear = document.getElementById('cvStudentBirthYear').value;
      const studentAddress = document.getElementById('cvStudentAddress').value;
      const studentSchool = document.getElementById('cvStudentSchool').value;
      const parentName = document.getElementById('cvParentName').value.trim();
      const parentPhone = document.getElementById('cvParentPhone').value.trim();
      const parentJob = document.getElementById('cvParentJob').value;

      const packageId = document.getElementById('cvTuitionPackage').value;
      const feeOriginal = parseCurrency(document.getElementById('cvFeeOriginal').value);
      const promoDiscount = parseCurrency(document.getElementById('cvPromoDiscount').value.replace('-', ''));
      const feeTotal = parseFloat(document.getElementById('cvFeeTotal').dataset.rawValue) || 0;
      const programId = document.getElementById('cvPromoProgram').value || null;

      const scholarshipMonths = parseInt(document.getElementById('cvScholarshipMonths').value) || 0;
      const needsApproval = scholarshipMonths > defaultScholarshipMonths;

      const depositAmount = parseCurrency(document.getElementById('cvDepositAmount').value);
      const paidAmount = parseCurrency(document.getElementById('cvPaidAmount').value);
      const paymentStatus = document.getElementById('cvPaymentStatus').value;
      const note = document.getElementById('cvNote').value;

      // Get selected gifts with ID
      const selectedGifts = [];
      document.querySelectorAll('.gift-checkbox:checked').forEach(cb => {
        selectedGifts.push({ id: cb.dataset.id, item_id: cb.dataset.id, name: cb.dataset.name });
      });

      // Validation
      if (!studentName) { ui.warning('Vui lòng nhập họ tên học sinh'); return; }
      if (!parentName || !parentPhone) { ui.warning('Vui lòng nhập thông tin phụ huynh'); return; }
      if (!packageId) { ui.warning('Vui lòng chọn gói học phí'); return; }

      if (needsApproval) {
        if (!confirm('Học bổng vượt mức mặc định. Yêu cầu này cần GDV duyệt. Tiếp tục?')) return;
      }

      try {
        const result = await api.post(`/leads/${id}/convert`, {
          studentName, birthYear: studentBirthYear, address: studentAddress, school: studentSchool,
          customerName: parentName, customerPhone: parentPhone, parentJob,
          packageId, feeOriginal, feeDiscount: promoDiscount, feeTotal,
          scholarshipMonths, defaultScholarshipMonths, scholarshipNeedsApproval: needsApproval,
          depositAmount, paidAmount, paymentStatus,
          programId, gifts: selectedGifts, note
        });

        modal.hide('convertModal');

        // Show success modal with payment options
        const student = result.data || {};
        const studentId = student.id || student.studentId;
        const studentCode = student.student_code || student.studentCode || '';
        const savedDeposit = student.deposit_amount || depositAmount || 0;

        // Số tiền cần thanh toán lần đầu
        let qrAmount = feeTotal;
        let qrLabel = 'Cần thanh toán';

        if (paymentStatus === 'deposit') {
          qrAmount = depositAmount;
          qrLabel = 'Tiền cọc';
        } else if (paymentStatus === 'partial') {
          qrAmount = paidAmount;
          qrLabel = 'Thanh toán 1 phần';
        } else if (paymentStatus === 'paid') {
          qrAmount = feeTotal;
          qrLabel = 'Thanh toán đủ';
        }

        // Set form values
        document.getElementById('newStudentId').value = studentId;
        document.getElementById('successStudentName').textContent = studentName;
        document.getElementById('successStudentCode').textContent = 'Mã: ' + studentCode;
        document.getElementById('successFeeTotal').textContent = formatCurrency(feeTotal) + 'đ';
        document.getElementById('successRemainingAmount').textContent = formatCurrency(qrAmount) + 'đ';
        document.getElementById('successRemainingRaw').value = qrAmount;
        document.getElementById('successPaymentLabel').textContent = qrLabel;
        document.getElementById('successPaymentDesc').textContent = studentCode + ' ' + studentName.substring(0, 15);
        document.getElementById('paymentNote').value = '';

        // Reset proof upload
        document.getElementById('proofFileInput').value = '';
        document.getElementById('proofPreview').style.display = 'none';
        document.getElementById('proofPlaceholder').style.display = 'block';

        if (qrAmount > 0) {
          document.getElementById('successPaymentSection').style.display = 'block';
          document.getElementById('successFullPaidSection').style.display = 'none';

          // Generate QR
          const desc = encodeURIComponent(studentCode + ' ' + studentName.substring(0, 15));
          const qrUrl = 'https://img.vietqr.io/image/970422-0866766189-compact2.png?amount=' + qrAmount + '&addInfo=' + desc;
          document.getElementById('successQRImage').src = qrUrl;

          // Default to bank_transfer
          selectPaymentMethod('bank_transfer');
        } else {
          document.getElementById('successPaymentSection').style.display = 'none';
          document.getElementById('successFullPaidSection').style.display = 'block';
        }

        modal.show('convertSuccessModal');

        ui.success(needsApproval ? 'Chuyển đổi thành công! Học bổng đang chờ duyệt.' : 'Chuyển đổi thành công!');
        loadCalendar();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    // Payment method selection
    let selectedPaymentMethod = 'bank_transfer';
    let proofFile = null;

    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;

      // Update button styles
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.method === method);
      });

      // Show/hide QR or proof upload
      if (method === 'bank_transfer') {
        document.getElementById('qrCodeSection').style.display = 'block';
        document.getElementById('proofUploadSection').style.display = 'none';
      } else {
        document.getElementById('qrCodeSection').style.display = 'none';
        document.getElementById('proofUploadSection').style.display = 'block';
      }
    }

    function handleProofUpload(input) {
      const file = input.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        ui.warning('File quá lớn. Tối đa 5MB');
        return;
      }

      proofFile = file;

      // Preview
      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById('proofPreviewImg').src = e.target.result;
        document.getElementById('proofPreview').style.display = 'block';
        document.getElementById('proofPlaceholder').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    function closeConvertSuccessModal() {
      modal.hide('convertSuccessModal');
      proofFile = null;
    }

    async function confirmPaymentReceived() {
      const studentId = document.getElementById('newStudentId').value;
      const remaining = parseFloat(document.getElementById('successRemainingRaw').value) || 0;
      const note = document.getElementById('paymentNote').value;

      if (!studentId) { ui.warning('Không tìm thấy thông tin học sinh'); return; }
      if (remaining <= 0) { ui.info('Không còn số tiền cần thanh toán'); return; }

      // Validate proof for non-bank methods
      if (selectedPaymentMethod !== 'bank_transfer' && !proofFile) {
        ui.warning('Vui lòng chụp ảnh minh chứng thanh toán');
        return;
      }

      const methodLabels = {
        'bank_transfer': 'chuyển khoản',
        'cash': 'tiền mặt',
        'card': 'quẹt thẻ',
        'installment': 'trả góp'
      };

      if (!confirm(`Xác nhận đã nhận ${formatCurrency(remaining)}đ (${methodLabels[selectedPaymentMethod]}) từ phụ huynh?`)) return;

      try {
        // Upload proof if exists
        let proofUrl = null;
        if (proofFile) {
          const formData = new FormData();
          formData.append('file', proofFile);
          const uploadRes = await fetch(config.API_URL + '/files/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + auth.getToken() },
            body: formData
          });
          const uploadData = await uploadRes.json();
          proofUrl = uploadData.data?.url || null;
        }

        await api.post('/students/' + studentId + '/confirm-payment', {
          amount: remaining,
          paymentMethod: selectedPaymentMethod,
          proofUrl: proofUrl,
          note: note || `Thanh toán ${methodLabels[selectedPaymentMethod]}`
        });

        ui.success('Đã ghi nhận thanh toán ' + formatCurrency(remaining) + 'đ');

        // Update UI - hide payment, show full paid
        document.getElementById('successPaymentSection').style.display = 'none';
        document.getElementById('successFullPaidSection').style.display = 'block';

        loadCalendar();
        loadStats();
      } catch (e) { ui.error(e.message); }
    }

    function downloadEnrollmentFormFromSuccess() {
      const studentId = document.getElementById('newStudentId').value;
      if (!studentId) { ui.warning('Không tìm thấy thông tin học sinh'); return; }
      downloadEnrollmentForm(studentId);
    }

    function downloadEnrollmentForm(studentId) {
      const token = localStorage.getItem('token');
      const url = window.LMS_CONFIG.API_BASE + '/enrollment/' + studentId + '/form';

      ui.info('Đang tạo đơn nhập học...');

      fetch(url, { method: 'GET', headers: { 'Authorization': 'Bearer ' + token } })
        .then(response => {
          if (!response.ok) throw new Error('Lỗi tải file');
          return response.blob();
        })
        .then(blob => {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'Don_nhap_hoc_' + studentId + '.docx';
          link.click();
          URL.revokeObjectURL(link.href);
          ui.success('Đã tải đơn nhập học');
        })
        .catch(e => ui.error(e.message));
    }

    function showDayDetail(dateStr) {
      const daySessions = trialSessions.filter(s => s.scheduled_date?.substring(0, 10) === dateStr);
      // TODO: Show modal with all sessions for this day
      alert(`Có ${daySessions.length} buổi học thử ngày ${dateStr}`);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>