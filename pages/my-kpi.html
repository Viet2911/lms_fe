<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI của tôi - ARMY Tech LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* KPI Hero Section */
    .kpi-hero {
      background: linear-gradient(135deg, var(--primary) 0%, #059669 100%);
      border-radius: 16px;
      padding: 30px;
      color: white;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    .kpi-hero .kpi-main {
      text-align: center;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
    }
    .kpi-hero .kpi-percent {
      font-size: 4rem;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 10px;
    }
    .kpi-hero .kpi-label {
      opacity: 0.9;
      font-size: 14px;
    }
    .kpi-progress {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      height: 24px;
      overflow: hidden;
      margin: 20px 0;
    }
    .kpi-progress-bar {
      height: 100%;
      border-radius: 10px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-weight: bold;
      font-size: 12px;
      transition: width 0.5s ease;
    }
    .kpi-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    .kpi-stat-item {
      text-align: center;
    }
    .kpi-stat-item .value {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .kpi-stat-item .label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* Ranking Section */
    .kpi-ranking {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      padding: 20px;
    }
    .rank-item {
      text-align: center;
      padding: 20px 30px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
    }
    .rank-item .rank-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    .rank-item .rank-icon.gold { color: #fbbf24; }
    .rank-item .rank-icon.silver { color: #e5e7eb; }
    .rank-item .rank-icon.bronze { color: #f59e0b; }
    .rank-item .rank-number {
      font-size: 2.5rem;
      font-weight: 800;
    }
    .rank-item .rank-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* Quick Stats Grid */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .quick-stat {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .quick-stat .icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }
    .quick-stat .icon.blue { background: #dbeafe; color: #2563eb; }
    .quick-stat .icon.green { background: #dcfce7; color: #16a34a; }
    .quick-stat .icon.yellow { background: #fef3c7; color: #d97706; }
    .quick-stat .icon.purple { background: #f3e8ff; color: #9333ea; }
    .quick-stat .info .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .quick-stat .info .label {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    /* Tables */
    .data-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .data-card {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .data-card .card-title {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }
    .data-card .card-title i {
      color: var(--primary);
    }
    .data-card .card-content {
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .data-card table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-card th {
      background: var(--bg-secondary);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-muted);
      position: sticky;
      top: 0;
    }
    .data-card td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .data-card tr:last-child td {
      border-bottom: none;
    }
    .data-card tr:hover {
      background: var(--bg-secondary);
    }
    .revenue-amount {
      font-weight: 700;
      color: #16a34a;
    }
    .fee-amount {
      color: var(--text-muted);
    }
    
    @media (max-width: 1024px) {
      .kpi-hero { grid-template-columns: 1fr; }
      .quick-stats { grid-template-columns: repeat(2, 1fr); }
      .data-section { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .quick-stats { grid-template-columns: 1fr; }
      .kpi-ranking { flex-direction: column; gap: 20px; }
    }
  </style>
</head>
<body>
  <nav class="sidebar" id="sidebar"></nav>
  <main class="main-content">
    <div class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')"><i class="fas fa-bars"></i></button>
        <h1><i class="fas fa-chart-line"></i> KPI của tôi</h1>
      </div>
      <div class="topbar-right">
        <input type="month" id="filterMonth" class="form-control" style="width:160px">
      </div>
    </div>

    <!-- KPI Hero -->
    <div class="kpi-hero">
      <div class="kpi-main">
        <div class="kpi-percent" id="kpiPercent">0%</div>
        <div class="kpi-label">Hoàn thành mục tiêu</div>
        <div class="kpi-progress">
          <div class="kpi-progress-bar" id="kpiBar" style="width:0%"></div>
        </div>
        <div class="kpi-stats">
          <div class="kpi-stat-item">
            <div class="value" id="currentRevenue">0đ</div>
            <div class="label">Doanh số</div>
          </div>
          <div class="kpi-stat-item">
            <div class="value" id="targetRevenue">0đ</div>
            <div class="label">Mục tiêu</div>
          </div>
        </div>
      </div>
      <div class="kpi-ranking">
        <div class="rank-item">
          <div class="rank-icon" id="rankAllIcon"><i class="fas fa-trophy"></i></div>
          <div class="rank-number" id="rankAll">#-</div>
          <div class="rank-label">Toàn hệ thống</div>
        </div>
        <div class="rank-item">
          <div class="rank-icon" id="rankBranchIcon"><i class="fas fa-medal"></i></div>
          <div class="rank-number" id="rankBranch">#-</div>
          <div class="rank-label">Tại cơ sở</div>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="quick-stat">
        <div class="icon blue"><i class="fas fa-user-check"></i></div>
        <div class="info">
          <div class="value" id="checkinCount">0</div>
          <div class="label">Leads đang xử lý</div>
        </div>
      </div>
      <div class="quick-stat">
        <div class="icon green"><i class="fas fa-user-graduate"></i></div>
        <div class="info">
          <div class="value" id="convertedCount">0</div>
          <div class="label">Đã chuyển đổi</div>
        </div>
      </div>
      <div class="quick-stat">
        <div class="icon yellow"><i class="fas fa-coins"></i></div>
        <div class="info">
          <div class="value" id="depositTotal">0đ</div>
          <div class="label">Tổng cọc</div>
        </div>
      </div>
      <div class="quick-stat">
        <div class="icon purple"><i class="fas fa-hourglass-half"></i></div>
        <div class="info">
          <div class="value" id="expectedRevenue">0đ</div>
          <div class="label">Dự thu</div>
        </div>
      </div>
    </div>

    <!-- Data Tables -->
    <div class="data-section">
      <div class="data-card">
        <div class="card-title"><i class="fas fa-calendar-day"></i> Leads hôm nay</div>
        <div class="card-content">
          <table>
            <thead><tr><th>Học sinh</th><th>SĐT</th><th>Giờ</th><th>Trạng thái</th></tr></thead>
            <tbody id="todayLeadsTable"><tr><td colspan="4" class="text-center text-muted" style="padding:30px">Không có leads hôm nay</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="data-card">
        <div class="card-title"><i class="fas fa-check-circle"></i> Đã chuyển đổi</div>
        <div class="card-content">
          <table>
            <thead><tr><th>Học sinh</th><th>Ngày</th><th>Đã đóng</th><th>Học phí</th></tr></thead>
            <tbody id="convertedLeadsTable"><tr><td colspan="4" class="text-center text-muted" style="padding:30px">Chưa có chuyển đổi</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="../js/config.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/sidebar.js"></script>
  <script>
    document.getElementById('filterMonth').value = new Date().toISOString().slice(0,7);
    
    async function init() { 
      await auth.requireAuth(); 
      buildSidebar('sidebar'); 
      await loadData(); 
    }
    
    async function loadData() {
      try {
        const res = await api.get('/dashboard/ec');
        const { myStats, myReport, myKpi, myRanking, todayLeads, convertedLeads } = res.data;

        // KPI Progress
        const target = myKpi?.target_revenue || 0;
        const current = myReport?.revenue || 0;
        const percent = target > 0 ? Math.round(current / target * 100) : 0;
        
        document.getElementById('kpiPercent').textContent = percent + '%';
        document.getElementById('currentRevenue').textContent = formatCurrency(current);
        document.getElementById('targetRevenue').textContent = formatCurrency(target);
        
        const bar = document.getElementById('kpiBar');
        bar.style.width = Math.min(percent, 100) + '%';

        // Ranking with colors
        const rankAll = myRanking?.rank_all || '-';
        const rankBranch = myRanking?.rank_branch || '-';
        document.getElementById('rankAll').textContent = '#' + rankAll;
        document.getElementById('rankBranch').textContent = '#' + rankBranch;
        
        const rankAllIcon = document.getElementById('rankAllIcon');
        rankAllIcon.className = 'rank-icon ' + (rankAll == 1 ? 'gold' : rankAll == 2 ? 'silver' : rankAll == 3 ? 'bronze' : '');
        const rankBranchIcon = document.getElementById('rankBranchIcon');
        rankBranchIcon.className = 'rank-icon ' + (rankBranch == 1 ? 'gold' : rankBranch == 2 ? 'silver' : rankBranch == 3 ? 'bronze' : '');

        // Stats
        document.getElementById('checkinCount').textContent = myReport?.checkin_count || myStats?.attended || 0;
        document.getElementById('convertedCount').textContent = myReport?.leads_converted || 0;
        document.getElementById('depositTotal').textContent = formatCurrency(myReport?.deposit_total || 0);
        document.getElementById('expectedRevenue').textContent = formatCurrency(myReport?.expected_revenue || 0);

        // Today Leads
        const tbody = document.getElementById('todayLeadsTable');
        if (!todayLeads || todayLeads.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted" style="padding:30px">Không có leads hôm nay</td></tr>';
        } else {
          tbody.innerHTML = todayLeads.map(l => `<tr>
            <td><strong>${l.student_name || l.customer_name}</strong></td>
            <td>${l.customer_phone}</td>
            <td>${l.scheduled_time || '-'}</td>
            <td>${getStatusBadge(l.status)}</td>
          </tr>`).join('');
        }

        // Converted Leads
        const ctbody = document.getElementById('convertedLeadsTable');
        if (!convertedLeads || convertedLeads.length === 0) {
          ctbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted" style="padding:30px">Chưa có chuyển đổi</td></tr>';
        } else {
          ctbody.innerHTML = convertedLeads.map(l => `<tr>
            <td><strong>${l.student_name}</strong></td>
            <td>${l.converted_date || '-'}</td>
            <td class="revenue-amount">${formatCurrency(l.actual_revenue)}</td>
            <td class="fee-amount">${formatCurrency(l.fee_total)}</td>
          </tr>`).join('');
        }
      } catch(e) { console.error(e); }
    }
    
    function getStatusBadge(status) {
      const badges = { 
        scheduled:'<span class="badge badge-info">Đã hẹn</span>', 
        attended:'<span class="badge badge-success">Đã TN</span>', 
        trial:'<span class="badge badge-warning">Trial</span>', 
        converted:'<span class="badge badge-success">Converted</span>' 
      };
      return badges[status] || `<span class="badge badge-secondary">${status}</span>`;
    }
    
    function formatCurrency(v) { 
      return v ? new Intl.NumberFormat('vi-VN').format(v) + 'đ' : '0đ'; 
    }
    
    document.getElementById('filterMonth').addEventListener('change', loadData);
    init();
  </script>
</body>
</html>
