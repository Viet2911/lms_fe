<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - LMS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
    .dashboard-card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
    .dashboard-card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .dashboard-card-header h3 { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .dashboard-card-header h3 i { color: var(--primary); }
    .dashboard-card-body { padding: 16px 20px; }
    .dashboard-card-body .empty { color: var(--text-muted); text-align: center; padding: 20px; }
    .mini-table { width: 100%; }
    .mini-table td { padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
    .mini-table tr:last-child td { border-bottom: none; }
    .mini-table .label { color: var(--text-muted); }
    .quick-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .quick-stat { background: var(--bg-secondary); padding: 12px; border-radius: 8px; text-align: center; }
    .quick-stat .value { font-size: 24px; font-weight: 700; color: var(--primary); }
    .quick-stat .label { font-size: 12px; color: var(--text-muted); }
    .session-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .session-item:last-child { border-bottom: none; }
    .session-time { background: var(--primary); color: white; padding: 8px 12px; border-radius: 8px; font-weight: 600; margin-right: 12px; min-width: 60px; text-align: center; }
    .session-info { flex: 1; }
    .session-info .class-name { font-weight: 600; }
    .session-info .meta { font-size: 12px; color: var(--text-muted); }
    .trial-progress { display: flex; align-items: center; gap: 8px; }
    .trial-progress .bar { flex: 1; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; }
    .trial-progress .bar-fill { height: 100%; background: var(--primary); border-radius: 3px; }
    .trial-progress .text { font-size: 12px; color: var(--text-muted); white-space: nowrap; }
    .branch-tag-sm { display: inline-block; background: var(--bg-secondary); color: var(--primary); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 4px; }
  </style>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')"><i class="fas fa-bars"></i></button>
          <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Xin ch√†o, <span id="welcomeName">User</span>!</p>
          </div>
        </div>
        <div class="header-right">
          <button class="theme-toggle" onclick="theme.toggle()" title="ƒê·ªïi giao di·ªán">
            <i class="fas fa-moon"></i>
            <i class="fas fa-sun"></i>
          </button>
          <div class="user-menu" onclick="auth.logout()">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info"><div class="user-name" id="userName">User</div><div class="user-role" id="userRole">Role</div></div>
          </div>
        </div>
      </header>

      <div class="page-content">
        <div id="dashboardContent"><div class="loading"><div class="spinner"></div></div></div>
      </div>
    </main>
  </div>

  <script src="js/config.js"></script>
  <script src="js/app.js"></script>
  <script src="js/sidebar.js"></script>
  <script>
    async function loadDashboard() {
      const role = auth.user?.role_name;
      const container = document.getElementById('dashboardContent');
      
      try {
        let endpoint = '/dashboard/admin';
        if (role === 'SALE') endpoint = '/dashboard/sale';
        else if (role === 'TEACHER') endpoint = '/dashboard/teacher';
        else if (role === 'CM') endpoint = '/dashboard/cm';
        else if (role === 'CHU') endpoint = '/dashboard/owner';
        else if (role === 'OM') endpoint = '/dashboard/om';
        else if (role === 'HOEC') endpoint = '/dashboard/hoec';
        else if (role === 'EC' || role === 'SALE') endpoint = '/dashboard/ec';

        const query = branch.buildQuery({});
        const result = await api.get(endpoint + query);
        const data = result.data;

        if (role === 'ADMIN') renderAdminDashboard(container, data);
        else if (role === 'CHU') renderOwnerDashboard(container, data);
        else if (role === 'OM') renderOMDashboard(container, data);
        else if (role === 'HOEC') renderHOECDashboard(container, data);
        else if (role === 'CM') renderCMDashboard(container, data);
        else if (role === 'TEACHER') renderTeacherDashboard(container, data);
        else if (role === 'EC' || role === 'SALE') renderECDashboard(container, data);
        else container.innerHTML = '<div class="empty-state"><p>Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</p></div>';
      } catch (error) {
        container.innerHTML = `<div class="empty-state"><p>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}</p></div>`;
      }
    }

    function renderAdminDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${data.students?.active || 0}</div><div class="stat-label">H·ªçc sinh (${data.students?.total || 0} t·ªïng)</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${data.classes?.active || 0}</div><div class="stat-label">L·ªõp ƒëang ho·∫°t ƒë·ªông</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.today || 0}</div><div class="stat-label">L·ªãch h√¥m nay</div></div></div>
          <div class="stat-card" style="border-left: 4px solid #06b6d4;"><div class="stat-icon" style="background:#cffafe;color:#0891b2;"><i class="fas fa-clock"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.waiting || 0}</div><div class="stat-label">Ch·ªù x·ª≠ l√Ω</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#ede9fe;color:#7c3aed;"><i class="fas fa-graduation-cap"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.trial || 0}</div><div class="stat-label">ƒêang h·ªçc th·ª≠</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-check-circle"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.converted || 0}</div><div class="stat-label">ƒê√£ chuy·ªÉn ƒë·ªïi</div></div></div>
          <div class="stat-card"><div class="stat-icon secondary"><i class="fas fa-chalkboard-teacher"></i></div><div class="stat-content"><div class="stat-value">${data.teachers || 0}</div><div class="stat-label">Gi√°o vi√™n</div></div></div>
          <div class="stat-card"><div class="stat-icon" style="background:#fef3c7;color:#d97706;"><i class="fas fa-user-clock"></i></div><div class="stat-content"><div class="stat-value">${data.students?.pending || 0}</div><div class="stat-label">Ch·ªù x·∫øp l·ªõp</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-check"></i> Leads c·∫ßn x·ª≠ l√Ω</h3><a href="pages/leads.html" class="btn btn-sm btn-primary">Xem t·∫•t c·∫£</a></div>
            <div class="dashboard-card-body">
              ${data.recentLeads?.length ? `<table class="mini-table">
                ${data.recentLeads.map(l => `<tr>
                  <td>
                    <strong>${l.student_name}</strong> <span class="branch-tag-sm">${l.branch_code}</span>
                    <br><small class="text-muted">${l.customer_phone}</small>
                  </td>
                  <td>${l.subject_name || '-'}</td>
                  <td>
                    ${l.status === 'waiting' ? 
                      `<span class="badge" style="background:#cffafe;color:#0891b2;"><i class="fas fa-clock"></i> Ch·ªù (${l.trial_sessions_attended || 0}/${l.trial_sessions_max || 3})</span>` :
                      l.status === 'trial' ?
                      `<span class="badge badge-info">${l.trial_sessions_attended || 0}/${l.trial_sessions_max || 3} bu·ªïi</span>` :
                      `<span class="badge badge-warning">${l.scheduled_time?.substring(0,5) || '-'}</span>`
                    }
                  </td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Kh√¥ng c√≥ leads c·∫ßn x·ª≠ l√Ω</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-day"></i> Bu·ªïi h·ªçc h√¥m nay</h3><span class="badge badge-info">${data.todaySessions?.length || 0}</span></div>
            <div class="dashboard-card-body">
              ${data.todaySessions?.length ? data.todaySessions.map(s => `
                <div class="session-item">
                  <div class="session-time">${s.start_time?.substring(0,5)}</div>
                  <div class="session-info">
                    <div class="class-name">${s.class_name} <span class="branch-tag-sm">${s.branch_code}</span></div>
                    <div class="meta">GV: ${s.teacher_name || 'N/A'}</div>
                  </div>
                  <span class="badge ${s.attendance_submitted ? 'badge-success' : 'badge-warning'}">${s.attendance_submitted ? 'ƒê√£ ƒêD' : 'Ch∆∞a ƒêD'}</span>
                </div>
              `).join('') : '<p class="empty">Kh√¥ng c√≥ bu·ªïi h·ªçc h√¥m nay</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-user-plus"></i> H·ªçc sinh m·ªõi</h3><a href="pages/students.html" class="btn btn-sm btn-secondary">Xem t·∫•t c·∫£</a></div>
            <div class="dashboard-card-body">
              ${data.recentStudents?.length ? `<table class="mini-table">
                ${data.recentStudents.map(s => `<tr>
                  <td><strong>${s.full_name}</strong> <span class="branch-tag-sm">${s.branch_code}</span></td>
                  <td><code>${s.student_code}</code></td>
                  <td class="text-muted">${ui.formatDate(s.created_at)}</td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Ch∆∞a c√≥ h·ªçc sinh</p>'}
            </div>
          </div>

          ${data.pendingStudents?.length ? `
          <div class="dashboard-card" style="border: 2px solid #f59e0b;">
            <div class="dashboard-card-header" style="background:#fef3c7;"><h3 style="color:#b45309;"><i class="fas fa-exclamation-triangle"></i> Ch·ªù x·∫øp l·ªõp (${data.pendingStudents.length})</h3><a href="pages/students.html?status=pending" class="btn btn-sm btn-warning">X·ª≠ l√Ω</a></div>
            <div class="dashboard-card-body">
              <table class="mini-table">
                ${data.pendingStudents.map(s => `<tr>
                  <td><strong>${s.full_name}</strong> <span class="branch-tag-sm">${s.branch_code}</span></td>
                  <td>${s.subject_name || '-'}</td>
                  <td>${s.parent_phone || '-'}</td>
                </tr>`).join('')}
              </table>
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }

    function renderSaleDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${data.students?.active || 0}</div><div class="stat-label">H·ªçc sinh c·ªßa t√¥i</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.today || 0}</div><div class="stat-label">L·ªãch h√¥m nay</div></div></div>
          <div class="stat-card" style="border-left: 4px solid #06b6d4;"><div class="stat-icon" style="background:#cffafe;color:#0891b2;"><i class="fas fa-clock"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.waiting || 0}</div><div class="stat-label">Ch·ªù ti·∫øp theo</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-graduation-cap"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.trial || 0}</div><div class="stat-label">ƒêang h·ªçc th·ª≠</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-user-check"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.converted || 0}</div><div class="stat-label">ƒê√£ chuy·ªÉn ƒë·ªïi</div></div></div>
          <div class="stat-card"><div class="stat-icon secondary"><i class="fas fa-calendar-check"></i></div><div class="stat-content"><div class="stat-value">${data.leads?.scheduled || 0}</div><div class="stat-label">Ch·ªù tr·∫£i nghi·ªám</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-check"></i> L·ªãch h√¥m nay</h3><a href="pages/trial-calendar.html" class="btn btn-sm btn-primary">Xem l·ªãch</a></div>
            <div class="dashboard-card-body">
              ${data.todayLeads?.length ? data.todayLeads.map(l => `
                <div class="session-item">
                  <div class="session-time">${l.scheduled_time?.substring(0,5) || '--:--'}</div>
                  <div class="session-info">
                    <div class="class-name">${l.student_name} <span class="branch-tag-sm">${l.branch_code}</span></div>
                    <div class="meta">${l.customer_name} - ${l.customer_phone}</div>
                  </div>
                  <span class="badge badge-${l.status === 'scheduled' ? 'warning' : 'info'}">
                    ${l.status === 'scheduled' ? 'Ch·ªù' : `B${(l.trial_sessions_attended || 0) + 1}`}
                  </span>
                </div>
              `).join('') : '<p class="empty">Kh√¥ng c√≥ l·ªãch h√¥m nay</p>'}
            </div>
          </div>

          ${data.waitingLeads?.length ? `
          <div class="dashboard-card" style="border: 2px solid #06b6d4;">
            <div class="dashboard-card-header" style="background:#cffafe;"><h3 style="color:#0891b2;"><i class="fas fa-clock"></i> Ch·ªù ƒë·∫∑t l·ªãch (${data.waitingLeads.length})</h3><a href="pages/leads.html?status=waiting" class="btn btn-sm" style="background:#0891b2;color:white;">X·ª≠ l√Ω</a></div>
            <div class="dashboard-card-body">
              <table class="mini-table">
                ${data.waitingLeads.map(l => `<tr>
                  <td>
                    <strong>${l.student_name}</strong> <span class="branch-tag-sm">${l.branch_code}</span>
                    <br><small class="text-muted">${l.customer_phone}</small>
                  </td>
                  <td>${l.subject_name || '-'}</td>
                  <td>
                    <div class="trial-progress">
                      <div class="bar"><div class="bar-fill" style="width:${((l.trial_sessions_attended || 0)/(l.trial_sessions_max || 3))*100}%"></div></div>
                      <span class="text">${l.trial_sessions_attended || 0}/${l.trial_sessions_max || 3}</span>
                    </div>
                  </td>
                </tr>`).join('')}
              </table>
            </div>
          </div>
          ` : ''}

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-user-clock"></i> ƒêang h·ªçc th·ª≠</h3><a href="pages/trial-calendar.html" class="btn btn-sm btn-secondary">Xem t·∫•t c·∫£</a></div>
            <div class="dashboard-card-body">
              ${data.trialLeads?.length ? `<table class="mini-table">
                ${data.trialLeads.map(l => `<tr>
                  <td>
                    <strong>${l.student_name}</strong> <span class="branch-tag-sm">${l.branch_code}</span>
                    <br><small class="text-muted">${l.subject_name || ''}</small>
                  </td>
                  <td>${l.customer_phone}</td>
                  <td>
                    <div class="trial-progress">
                      <div class="bar"><div class="bar-fill" style="width:${((l.trial_sessions_attended || 0)/(l.trial_sessions_max || 3))*100}%"></div></div>
                      <span class="text">${l.trial_sessions_attended || 0}/${l.trial_sessions_max || 3}</span>
                    </div>
                  </td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Kh√¥ng c√≥ h·ªçc sinh h·ªçc th·ª≠</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderTeacherDashboard(container, data) {
      const stats = data.stats || {};
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${stats.total_classes || 0}</div><div class="stat-label">L·ªõp ƒëang d·∫°y</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${stats.total_students || 0}</div><div class="stat-label">H·ªçc sinh</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${stats.today_sessions || 0}</div><div class="stat-label">Bu·ªïi h·ªçc h√¥m nay</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-tasks"></i></div><div class="stat-content"><div class="stat-value">${stats.total_assignments || 0}</div><div class="stat-label">B√†i t·∫≠p ƒë√£ giao</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-day"></i> Bu·ªïi h·ªçc h√¥m nay</h3></div>
            <div class="dashboard-card-body">
              ${data.todaySessions?.length ? data.todaySessions.map(s => `
                <div class="session-item">
                  <div class="session-time">${s.start_time?.substring(0,5)}</div>
                  <div class="session-info">
                    <div class="class-name">${s.class_name} - Bu·ªïi ${s.session_number}</div>
                    <div class="meta">${s.student_count} h·ªçc sinh</div>
                  </div>
                  ${s.attendance_submitted 
                    ? '<span class="badge badge-success">ƒê√£ ƒëi·ªÉm danh</span>' 
                    : `<a href="pages/attendance.html?sessionId=${s.id}" class="btn btn-sm btn-primary">ƒêi·ªÉm danh</a>`}
                </div>
              `).join('') : '<p class="empty">Kh√¥ng c√≥ bu·ªïi h·ªçc h√¥m nay</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-exclamation-triangle"></i> Ch∆∞a ƒëi·ªÉm danh</h3></div>
            <div class="dashboard-card-body">
              ${data.pendingAttendance?.length ? `<table class="mini-table">
                ${data.pendingAttendance.map(s => `<tr>
                  <td><strong>${s.class_name}</strong> - Bu·ªïi ${s.session_number}</td>
                  <td>${ui.formatDate(s.session_date)}</td>
                  <td><a href="pages/attendance.html?sessionId=${s.id}" class="btn btn-sm btn-warning">ƒêi·ªÉm danh</a></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">T·∫•t c·∫£ ƒë√£ ƒëi·ªÉm danh ‚úì</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-chalkboard"></i> L·ªõp c·ªßa t√¥i</h3><a href="pages/classes.html" class="btn btn-sm btn-secondary">Xem t·∫•t c·∫£</a></div>
            <div class="dashboard-card-body">
              ${data.classes?.length ? `<table class="mini-table">
                ${data.classes.map(c => `<tr>
                  <td><strong>${c.class_name}</strong><br><small class="text-muted">${c.subject_name || ''} - ${c.level_name || ''}</small></td>
                  <td>${c.study_days || ''}<br><small>${c.start_time?.substring(0,5) || ''}</small></td>
                  <td><span class="badge badge-info">${c.student_count} HS</span></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Ch∆∞a c√≥ l·ªõp n√†o</p>'}
            </div>
          </div>
        </div>
      `;
    }

    function renderCMDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${data.classes?.active || 0}</div><div class="stat-label">L·ªõp ho·∫°t ƒë·ªông</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${data.students?.active || 0}</div><div class="stat-label">H·ªçc vi√™n</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-exclamation-triangle"></i></div><div class="stat-content"><div class="stat-value">${data.students?.expiring_soon || 0}</div><div class="stat-label">S·∫Øp h·∫øt ph√≠</div></div></div>
          <div class="stat-card"><div class="stat-icon danger"><i class="fas fa-times-circle"></i></div><div class="stat-content"><div class="stat-value">${data.students?.expired || 0}</div><div class="stat-label">ƒê√£ h·∫øt ph√≠</div></div></div>
        </div>

        <div class="dashboard-grid">
          ${data.expiringStudents?.length ? `
          <div class="dashboard-card" style="border: 2px solid #f59e0b;">
            <div class="dashboard-card-header" style="background:#fef3c7;"><h3 style="color:#b45309;"><i class="fas fa-exclamation-triangle"></i> C·∫ßn gia h·∫°n (${data.expiringStudents.length})</h3><a href="pages/fee-warning.html" class="btn btn-sm btn-warning">X·ª≠ l√Ω</a></div>
            <div class="dashboard-card-body">
              <table class="mini-table">
                ${data.expiringStudents.slice(0,5).map(s => `<tr>
                  <td><strong>${s.full_name}</strong></td>
                  <td>${s.class_name || '-'}</td>
                  <td><strong class="${s.remaining_sessions <= 0 ? 'text-danger' : 'text-warning'}">${s.remaining_sessions || 0} bu·ªïi</strong></td>
                </tr>`).join('')}
              </table>
            </div>
          </div>` : ''}

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-day"></i> Bu·ªïi h·ªçc h√¥m nay</h3></div>
            <div class="dashboard-card-body">
              ${data.todaySessions?.length ? data.todaySessions.map(s => `
                <div class="session-item">
                  <div class="session-time">${s.start_time?.substring(0,5)}</div>
                  <div class="session-info">
                    <div class="class-name">${s.class_name}</div>
                    <div class="meta">GV: ${s.teacher_name || 'N/A'}</div>
                  </div>
                  <span class="badge ${s.attendance_submitted ? 'badge-success' : 'badge-warning'}">${s.attendance_submitted ? 'ƒê√£ ƒêD' : 'Ch∆∞a ƒêD'}</span>
                </div>
              `).join('') : '<p class="empty">Kh√¥ng c√≥ bu·ªïi h·ªçc h√¥m nay</p>'}
            </div>
          </div>

          ${data.pendingStudents?.length ? `
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-user-clock"></i> Ch·ªù x·∫øp l·ªõp (${data.pendingStudents.length})</h3></div>
            <div class="dashboard-card-body">
              <table class="mini-table">
                ${data.pendingStudents.slice(0,5).map(s => `<tr>
                  <td><strong>${s.full_name}</strong></td>
                  <td>${s.subject_name || '-'}</td>
                  <td>${s.parent_phone || '-'}</td>
                </tr>`).join('')}
              </table>
            </div>
          </div>` : ''}
        </div>
      `;
    }

    // Dashboard CH·ª¶
    function renderOwnerDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-user-graduate"></i></div><div class="stat-content"><div class="stat-value">${data.students?.active || 0}</div><div class="stat-label">H·ªçc vi√™n</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${data.classes?.active || 0}</div><div class="stat-label">L·ªõp h·ªçc</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-money-bill-wave"></i></div><div class="stat-content"><div class="stat-value">${formatCurrency(data.saleStats?.total_revenue)}</div><div class="stat-label">Doanh s·ªë th√°ng</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-hand-holding-usd"></i></div><div class="stat-content"><div class="stat-value">${formatCurrency(data.saleStats?.total_deposit)}</div><div class="stat-label">C·ªçc</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-trophy"></i> Top EC th√°ng ${data.currentMonth}</h3><a href="pages/sale-reports.html" class="btn btn-sm btn-primary">Xem chi ti·∫øt</a></div>
            <div class="dashboard-card-body">
              ${data.topEcs?.length ? `<table class="mini-table">
                ${data.topEcs.slice(0,5).map((e, i) => `<tr>
                  <td>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1)}</td>
                  <td><strong>${e.ec_name}</strong> <span class="branch-tag-sm">${e.branch_code || ''}</span></td>
                  <td class="text-success"><strong>${formatCurrency(e.revenue)}</strong></td>
                  <td><span class="badge ${e.kpi_percent >= 100 ? 'badge-success' : 'badge-warning'}">${e.kpi_percent || 0}%</span></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-building"></i> Doanh thu theo c∆° s·ªü</h3></div>
            <div class="dashboard-card-body">
              ${data.revenueByBranch?.length ? `<table class="mini-table">
                ${data.revenueByBranch.map(b => `<tr>
                  <td><strong>${b.code}</strong> - ${b.name}</td>
                  <td class="text-success">${formatCurrency(b.revenue)}</td>
                  <td class="text-warning">${formatCurrency(b.deposit)}</td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu</p>'}
            </div>
          </div>

          ${data.expiringStudents?.length ? `
          <div class="dashboard-card" style="border: 2px solid #ef4444;">
            <div class="dashboard-card-header" style="background:#fef2f2;"><h3 style="color:#dc2626;"><i class="fas fa-exclamation-triangle"></i> H·ªçc vi√™n c·∫ßn gia h·∫°n</h3><a href="pages/fee-warning.html" class="btn btn-sm btn-danger">Xem t·∫•t c·∫£</a></div>
            <div class="dashboard-card-body">
              <table class="mini-table">
                ${data.expiringStudents.slice(0,5).map(s => `<tr>
                  <td><strong>${s.full_name}</strong> <span class="branch-tag-sm">${s.branch_code}</span></td>
                  <td><strong class="${s.remaining_sessions <= 0 ? 'text-danger' : 'text-warning'}">${s.remaining_sessions || 0} bu·ªïi</strong></td>
                </tr>`).join('')}
              </table>
            </div>
          </div>` : ''}
        </div>
      `;
    }

    // Dashboard OM
    function renderOMDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-chalkboard"></i></div><div class="stat-content"><div class="stat-value">${data.classes?.active || 0}</div><div class="stat-label">L·ªõp ho·∫°t ƒë·ªông</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${data.todaySessions?.length || 0}</div><div class="stat-label">Bu·ªïi h·ªçc h√¥m nay</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-exclamation-triangle"></i></div><div class="stat-content"><div class="stat-value">${data.expiringStudents?.length || 0}</div><div class="stat-label">S·∫Øp h·∫øt ph√≠</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-day"></i> Bu·ªïi h·ªçc h√¥m nay</h3></div>
            <div class="dashboard-card-body">
              ${data.todaySessions?.length ? data.todaySessions.map(s => `
                <div class="session-item">
                  <div class="session-time">${s.start_time?.substring(0,5)}</div>
                  <div class="session-info">
                    <div class="class-name">${s.class_name} <span class="branch-tag-sm">${s.branch_code}</span></div>
                    <div class="meta">GV: ${s.teacher_name || 'N/A'} | ${s.student_count || 0} HS</div>
                  </div>
                  <span class="badge ${s.attendance_submitted ? 'badge-success' : 'badge-warning'}">${s.attendance_submitted ? 'ƒê√£ ƒêD' : 'Ch∆∞a ƒêD'}</span>
                </div>
              `).join('') : '<p class="empty">Kh√¥ng c√≥ bu·ªïi h·ªçc h√¥m nay</p>'}
            </div>
          </div>

          ${data.expiringStudents?.length ? `
          <div class="dashboard-card" style="border: 2px solid #f59e0b;">
            <div class="dashboard-card-header" style="background:#fef3c7;"><h3 style="color:#b45309;"><i class="fas fa-exclamation-triangle"></i> C·∫ßn gia h·∫°n</h3><a href="pages/fee-warning.html" class="btn btn-sm btn-warning">X·ª≠ l√Ω</a></div>
            <div class="dashboard-card-body">
              <table class="mini-table">
                ${data.expiringStudents.slice(0,5).map(s => `<tr>
                  <td><strong>${s.full_name}</strong> <span class="branch-tag-sm">${s.branch_code}</span></td>
                  <td>${s.class_name || '-'}</td>
                  <td><strong class="text-warning">${s.remaining_sessions || 0} bu·ªïi</strong></td>
                </tr>`).join('')}
              </table>
            </div>
          </div>` : ''}
        </div>
      `;
    }

    // Dashboard HOEC
    function renderHOECDashboard(container, data) {
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-users"></i></div><div class="stat-content"><div class="stat-value">${data.myEcs?.length || 0}</div><div class="stat-label">EC qu·∫£n l√Ω</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-money-bill-wave"></i></div><div class="stat-content"><div class="stat-value">${formatCurrency(data.saleStats?.total_revenue)}</div><div class="stat-label">T·ªïng doanh s·ªë</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-user-check"></i></div><div class="stat-content"><div class="stat-value">${data.saleStats?.total_checkin || 0}</div><div class="stat-label">T·ªïng checkin</div></div></div>
          <div class="stat-card"><div class="stat-icon warning"><i class="fas fa-percentage"></i></div><div class="stat-content"><div class="stat-value">${Math.round(data.saleStats?.avg_kpi || 0)}%</div><div class="stat-label">KPI trung b√¨nh</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-trophy"></i> BXH EC th√°ng ${data.currentMonth}</h3><a href="pages/sale-reports.html" class="btn btn-sm btn-primary">Chi ti·∫øt</a></div>
            <div class="dashboard-card-body">
              ${data.ecRanking?.length ? `<table class="mini-table">
                ${data.ecRanking.map((e, i) => `<tr>
                  <td>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1)}</td>
                  <td><strong>${e.ec_name}</strong> <span class="branch-tag-sm">${e.branch_code || ''}</span></td>
                  <td class="text-success"><strong>${formatCurrency(e.revenue)}</strong></td>
                  <td><span class="badge ${e.kpi_percent >= 100 ? 'badge-success' : e.kpi_percent >= 70 ? 'badge-warning' : 'badge-danger'}">${e.kpi_percent || 0}%</span></td>
                </tr>`).join('')}
              </table>` : '<p class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu</p>'}
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-bullseye"></i> Qu·∫£n l√Ω KPI</h3><a href="pages/kpi.html" class="btn btn-sm btn-success">Set KPI</a></div>
            <div class="dashboard-card-body">
              <div class="quick-stats">
                <div class="quick-stat"><div class="value text-success">${formatCurrency(data.saleStats?.total_revenue)}</div><div class="label">Doanh s·ªë</div></div>
                <div class="quick-stat"><div class="value text-warning">${formatCurrency(data.saleStats?.total_deposit)}</div><div class="label">C·ªçc</div></div>
                <div class="quick-stat"><div class="value text-info">${formatCurrency(data.saleStats?.total_expected)}</div><div class="label">D·ª± thu</div></div>
                <div class="quick-stat"><div class="value">${data.saleStats?.total_checkin || 0}</div><div class="label">Checkin</div></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Dashboard EC
    function renderECDashboard(container, data) {
      const kpiPercent = data.myKpi?.target_revenue > 0 ? Math.round((data.myReport?.revenue || 0) / data.myKpi.target_revenue * 100) : 0;
      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-icon primary"><i class="fas fa-calendar-day"></i></div><div class="stat-content"><div class="stat-value">${data.myStats?.today || 0}</div><div class="stat-label">L·ªãch h√¥m nay</div></div></div>
          <div class="stat-card" style="border-left: 4px solid #06b6d4;"><div class="stat-icon" style="background:#cffafe;color:#0891b2;"><i class="fas fa-clock"></i></div><div class="stat-content"><div class="stat-value">${data.myStats?.waiting || 0}</div><div class="stat-label">Ch·ªù ƒë·∫∑t l·ªãch</div></div></div>
          <div class="stat-card"><div class="stat-icon info"><i class="fas fa-graduation-cap"></i></div><div class="stat-content"><div class="stat-value">${data.myStats?.trial || 0}</div><div class="stat-label">ƒêang trial</div></div></div>
          <div class="stat-card"><div class="stat-icon success"><i class="fas fa-user-check"></i></div><div class="stat-content"><div class="stat-value">${data.myStats?.converted || 0}</div><div class="stat-label">ƒê√£ chuy·ªÉn ƒë·ªïi</div></div></div>
        </div>

        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-bullseye"></i> KPI th√°ng ${data.currentMonth}</h3><a href="pages/my-kpi.html" class="btn btn-sm btn-primary">Chi ti·∫øt</a></div>
            <div class="dashboard-card-body">
              <div style="text-align:center;margin-bottom:15px">
                <span style="font-size:2.5rem;font-weight:bold;color:${kpiPercent >= 100 ? '#10b981' : kpiPercent >= 70 ? '#f59e0b' : '#ef4444'}">${kpiPercent}%</span>
                <p class="text-muted">Ho√†n th√†nh KPI</p>
              </div>
              <div style="background:var(--bg-secondary);border-radius:8px;height:20px;overflow:hidden">
                <div style="width:${Math.min(kpiPercent,100)}%;height:100%;background:${kpiPercent >= 100 ? '#10b981' : kpiPercent >= 70 ? '#f59e0b' : '#ef4444'};border-radius:8px"></div>
              </div>
              <div class="quick-stats" style="margin-top:15px">
                <div class="quick-stat"><div class="value text-success">${formatCurrency(data.myReport?.revenue)}</div><div class="label">Doanh s·ªë</div></div>
                <div class="quick-stat"><div class="value">${formatCurrency(data.myKpi?.target_revenue)}</div><div class="label">M·ª•c ti√™u</div></div>
              </div>
              <div style="text-align:center;margin-top:10px">
                <span class="text-muted">X·∫øp h·∫°ng: </span>
                <strong>#${data.myRanking?.rank_all || '-'}</strong> to√†n h·ªá th·ªëng |
                <strong>#${data.myRanking?.rank_branch || '-'}</strong> t·∫°i c∆° s·ªü
              </div>
            </div>
          </div>

          <div class="dashboard-card">
            <div class="dashboard-card-header"><h3><i class="fas fa-calendar-check"></i> L·ªãch h√¥m nay</h3><a href="pages/trial-calendar.html" class="btn btn-sm btn-secondary">Xem l·ªãch</a></div>
            <div class="dashboard-card-body">
              ${data.todayLeads?.length ? data.todayLeads.map(l => `
                <div class="session-item">
                  <div class="session-time">${l.scheduled_time?.substring(0,5) || '--:--'}</div>
                  <div class="session-info">
                    <div class="class-name">${l.student_name}</div>
                    <div class="meta">${l.customer_phone}</div>
                  </div>
                  <span class="badge badge-${l.status === 'scheduled' ? 'warning' : 'info'}">${l.status === 'scheduled' ? 'Ch·ªù' : `B${(l.trial_sessions_attended || 0) + 1}`}</span>
                </div>
              `).join('') : '<p class="empty">Kh√¥ng c√≥ l·ªãch h√¥m nay</p>'}
            </div>
          </div>

          ${data.waitingLeads?.length ? `
          <div class="dashboard-card" style="border: 2px solid #06b6d4;">
            <div class="dashboard-card-header" style="background:#cffafe;"><h3 style="color:#0891b2;"><i class="fas fa-clock"></i> Ch·ªù ƒë·∫∑t l·ªãch (${data.waitingLeads.length})</h3><a href="pages/leads.html?status=waiting" class="btn btn-sm" style="background:#0891b2;color:white;">X·ª≠ l√Ω</a></div>
            <div class="dashboard-card-body">
              <table class="mini-table">
                ${data.waitingLeads.slice(0,5).map(l => `<tr>
                  <td><strong>${l.student_name}</strong></td>
                  <td>${l.customer_phone}</td>
                  <td><span class="badge badge-info">${l.trial_sessions_attended || 0} bu·ªïi</span></td>
                </tr>`).join('')}
              </table>
            </div>
          </div>` : ''}
        </div>
      `;
    }

    function formatCurrency(v) { return v ? new Intl.NumberFormat('vi-VN').format(v) + 'ƒë' : '0ƒë'; }

    document.addEventListener('DOMContentLoaded', () => {
      if (!auth.checkAuth()) return;
      document.getElementById('welcomeName').textContent = auth.user?.full_name || 'User';
      buildSidebar('sidebar');
      loadDashboard();
    });
  </script>
</body>
</html>
